/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

"use strict";var rn=Object.defineProperty;var Si=Object.getOwnPropertyDescriptor;var Mi=Object.getOwnPropertyNames;var Li=Object.prototype.hasOwnProperty;var Ii=(r,e,t)=>e in r?rn(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var Ti=(r,e)=>{for(var t in e)rn(r,t,{get:e[t],enumerable:!0})},Ai=(r,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of Mi(e))!Li.call(r,i)&&i!==t&&rn(r,i,{get:()=>e[i],enumerable:!(n=Si(e,i))||n.enumerable});return r};var Vi=r=>Ai(rn({},"__esModule",{value:!0}),r);var Ne=(r,e,t)=>(Ii(r,typeof e!="symbol"?e+"":e,t),t);var Xo={};Ti(Xo,{DEFAULT_SETTINGS:()=>rr,default:()=>kn});module.exports=Vi(Xo);var tn=require("obsidian");var hr=require("obsidian");var Oe=[];for(let r=0;r<256;++r)Oe.push((r+256).toString(16).slice(1));function ir(r,e=0){return(Oe[r[e+0]]+Oe[r[e+1]]+Oe[r[e+2]]+Oe[r[e+3]]+"-"+Oe[r[e+4]]+Oe[r[e+5]]+"-"+Oe[r[e+6]]+Oe[r[e+7]]+"-"+Oe[r[e+8]]+Oe[r[e+9]]+"-"+Oe[r[e+10]]+Oe[r[e+11]]+Oe[r[e+12]]+Oe[r[e+13]]+Oe[r[e+14]]+Oe[r[e+15]]).toLowerCase()}var En,Fi=new Uint8Array(16);function Cn(){if(!En){if(typeof crypto=="undefined"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");En=crypto.getRandomValues.bind(crypto)}return En(Fi)}var Ni=typeof crypto!="undefined"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Sn={randomUUID:Ni};function Hi(r,e,t){var i,o,s;if(Sn.randomUUID&&!e&&!r)return Sn.randomUUID();r=r||{};let n=(s=(o=r.random)!=null?o:(i=r.rng)==null?void 0:i.call(r))!=null?s:Cn();if(n.length<16)throw new Error("Random bytes length must be >= 16");if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let a=0;a<16;++a)e[t+a]=n[a];return e}return ir(n)}var zt=Hi;var Ct=class{constructor(){this.cache=new Map;this.maxCacheSize=50}static getInstance(){return Ct.instance||(Ct.instance=new Ct),Ct.instance}getCachedTree(e,t){let n=this.cache.get(e);if(!n)return null;let i=this.hashContent(t);return n.contentHash===i?(n.timestamp=Date.now(),this.cloneTree(n.tree)):null}cacheTree(e,t,n){this.evictOldEntries();let i=this.hashContent(t),o=this.generateLineHashes(t),s=this.buildHeaderMap(n);this.cache.set(e,{content:t,contentHash:i,tree:this.cloneTree(n),lineHashes:o,headerMap:s,timestamp:Date.now()})}updateTreeIncremental(e,t,n,i){let o=this.cache.get(e);if(!o||o.content!==t){let c=i(n);return this.cacheTree(e,n,c),c}let s=this.hashContent(t),a=this.hashContent(n);if(s===a)return this.cloneTree(o.tree);let l=i(n);return this.cacheTree(e,n,l),l}detectChanges(e,t){let n=e.split(`
`),i=t.split(`
`),o=n.map(d=>this.hashLine(d)),s=i.map(d=>this.hashLine(d)),a=[],l=0,c=0;for(;l<o.length||c<s.length;)if(l>=o.length){let d=c;for(;c<s.length;)c++;a.push({startLine:d,endLine:c-1,type:"added"})}else if(c>=s.length){a.push({startLine:l,endLine:o.length-1,type:"removed"});break}else if(o[l]===s[c])l++,c++;else{let d=c,u=c;for(;c<s.length&&l<o.length&&o[l]!==s[c];)l++,c++,u=c;a.push({startLine:d,endLine:u-1,type:"modified"})}return this.mergeAdjacentChanges(a)}performIncrementalUpdate(e,t,n,i,o,s){let a=s(i);return this.preserveNodeIds(e,a,t)}preserveNodeIds(e,t,n){let i=o=>o.map(s=>{let a=this.getHeaderKey(s),l=n.get(a);return l&&(s.id=l.id),s.children&&s.children.length>0&&(s.children=i(s.children)),s});return i(t)}shouldFullReparse(e,t){if(!t||e.length===0)return!1;let n=t.split(`
`).length;return n===0?!0:e.reduce((o,s)=>o+Math.max(0,s.endLine-s.startLine+1),0)/n>.3||e.length>10}mergeAdjacentChanges(e){if(e.length<=1)return e;let t=[],n=e[0];for(let i=1;i<e.length;i++){let o=e[i];o.startLine<=n.endLine+2?n={startLine:n.startLine,endLine:Math.max(n.endLine,o.endLine),type:"modified"}:(t.push(n),n=o)}return t.push(n),t}buildHeaderMap(e){let t=new Map,n=i=>{i.forEach(o=>{let s=this.getHeaderKey(o);t.set(s,o),o.children&&n(o.children)})};return n(e),t}getHeaderKey(e){return`${e.level}:${e.header}`}generateLineHashes(e){return e.split(`
`).map(t=>this.hashLine(t))}hashContent(e){if(!e)return"0";let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=t*16777619>>>0;return t.toString(36)}hashLine(e){if(!e)return"0";if(e.length<32)return e.length+e.slice(0,Math.min(8,e.length))+e.slice(Math.max(0,e.length-4));let t=2166136261;for(let n=0;n<e.length;n++)t^=e.charCodeAt(n),t=t*16777619>>>0;return t.toString(36)}cloneTree(e){var n;if(!e||e.length===0)return[];let t=new Array(e.length);for(let i=0;i<e.length;i++){let o=e[i];t[i]={id:o.id,header:o.header,content:o.content,level:o.level,startLine:o.startLine,endLine:o.endLine,startChar:o.startChar,endChar:o.endChar,children:(n=o.children)!=null&&n.length?this.cloneTree(o.children):[]}}return t}evictOldEntries(){if(this.cache.size<this.maxCacheSize)return;let e=Array.from(this.cache.entries()).sort(([,n],[,i])=>n.timestamp-i.timestamp);e.slice(0,e.length-this.maxCacheSize+1).forEach(([n,i])=>{i.headerMap.clear(),i.tree=[],i.lineHashes=[],this.cache.delete(n)})}clearCache(e){if(e){let t=this.cache.get(e);t&&(t.headerMap.clear(),t.tree=[],t.lineHashes=[],this.cache.delete(e))}else this.cache.forEach(t=>{t.headerMap.clear(),t.tree=[],t.lineHashes=[]}),this.cache.clear()}getCacheStats(){return{size:this.cache.size,maxSize:this.maxCacheSize,hitRate:0}}},bt=Ct;bt.codeBlockRegex=/^```/,bt.headerRegex=/^(#{1,6})\s+/;function on(r){let e=r.split(`
`),t=[],n=[],i=0,o=!1,s=/^(#{1,6})\s+(.*)$/,a=/^```/,l=new Map,c=-1,d=!1;for(let f=0;f<e.length;f++){let p=e[f];if(a.test(p.trim())&&(d=!d),!d&&s.test(p)){c=f;break}}if(c===-1)return[{id:zt(),header:"Document",content:r,level:1,children:[],startLine:1,endLine:e.length,startChar:0,endChar:r.length}];if(c>0){let f=e.slice(0,c),p=f.join(`
`);if(p.trim()){let w={id:zt(),header:"Document Header",content:p+`
`,level:1,children:[],startLine:1,endLine:c,startChar:0,endChar:f.join(`
`).length+1};t.push(w),n.push(w),i=w.endChar}}e.forEach((f,p)=>{var b;if(c>0&&p<c){i+=f.length+1;return}a.test(f.trim())&&(o=!o);let w=o?null:f.match(s);if(w){let m=w[1].length,E=w[2],M=zt(),y={id:M,header:E,content:"",level:m,children:[],startLine:p+1,endLine:p+1,startChar:i,endChar:i+f.length+1};l.set(M,[]);let I=0;for(let L=n.length-1;L>=0&&n[L].level>=m;L--)I++;I>0&&n.splice(-I),n.length===0?t.push(y):n[n.length-1].children.push(y),n.push(y)}else if(n.length>0){let m=n[n.length-1];(b=l.get(m.id))==null||b.push(f+`
`),m.endLine=p+1,m.endChar=i+f.length+1}i+=f.length+1});for(let f=0;f<n.length;f++){let p=n[f];p.endLine<e.length&&(p.endLine=e.length,p.endChar=i)}let u=[...t],h=[...t];for(;h.length>0;){let f=h.pop();h.push(...f.children),u.push(...f.children)}return u.forEach(f=>{let p=l.get(f.id);p&&(f.content=p.join(""))}),t}function Pt(r,e){let t=r.split(/\r?\n/);if(e<1||e>t.length)throw new Error("currentLineNumber \u8D85\u51FA\u6587\u672C\u884C\u6570\u8303\u56F4");let i=t[e-1].trim().match(/^(#{1,6})\s+/);if(!i)throw new Error("\u6307\u5B9A\u884C\u4E0D\u662F\u4E00\u4E2A\u6709\u6548\u7684 Markdown \u6807\u9898");let o=i[1].length,s=!1;for(let a=0;a<e-1;a++)/^\s*```/.test(t[a])&&(s=!s);for(let a=e;a<t.length;a++){let l=t[a];if(/^\s*```/.test(l)){s=!s;continue}if(!s){let c=l.trim().match(/^(#{1,6})\s+/);if(c&&c[1].length<=o)return a+1}}return t.length+1}function or(r,e){let t=r.split(/\r?\n/),n=e-1,i=!1;for(let o=0;o<e;o++)/^\s*```/.test(t[o])&&(i=!i);for(;n>0;){let o=t[n];if(/^\s*```/.test(o)&&(i=!i),!i&&o.match(/^(#{1,6})\s+/))return n;n--}return null}function sr(r,e){let t=r.split(/\r?\n/),n=e,i=!1;for(let o=0;o<e&&o<t.length;o++)/^\s*```/.test(t[o])&&(i=!i);for(;n<t.length;){let o=t[n];if(/^\s*```/.test(o)&&(i=!i),!i&&o.match(/^(#{1,6})\s+/))return n;n++}return null}function ot(r,e,t){if(typeof r!="string")return console.warn("md2treeWithCache: markdown must be a string"),[];let n=bt.getInstance();if(!e||e.trim()==="")return on(r);try{let i=n.getCachedTree(e,r);if(i)return i;if(t&&typeof t=="string"&&t!==r)return n.updateTreeIncremental(e,t,r,on);let o=on(r);return n.cacheTree(e,r,o),o}catch(i){return console.error("md2treeWithCache\u51FA\u9519:",i),on(r)}}function ar(r){bt.getInstance().clearCache(r)}function lr(r,e,t){let n=r.split(/\r?\n/),i=!1;for(let o=0;o<e-1;o++)/^\s*```/.test(n[o])&&(i=!i);for(let o=e;o<n.length;o++){let s=n[o];if(/^\s*```/.test(s)){i=!i;continue}if(!i){let a=s.trim().match(/^(#{1,6})\s+/);if(a&&a[1].length<=t)return o+1}}return n.length+1}function cr(r,e){let t=r.split(/\r?\n/),n=!1;for(let i=0;i<e-1;i++)/^\s*```/.test(t[i])&&(n=!n);for(let i=e;i<t.length;i++){let o=t[i];if(/^\s*```/.test(o)){n=!n;continue}if(!n&&o.trim().match(/^(#{1,6})\s+/))return i+1}for(let i=t.length-1;i>=e;i--)if(t[i].trim()!=="")return i+2;return e+1}function dr(r,e,t,n="\u65B0\u5EFA\u6807\u9898"){if(t<1||t>6)throw new Error(`Invalid header level: ${t}. Must be between 1 and 6.`);let i=r.split(/\r?\n/),s=`${"#".repeat(t)} ${n}`,a=Math.max(0,Math.min(e-1,i.length));return i.splice(a,0,s,""),i.join(`
`)}function ur(r){let e=[];function t(n){for(let i of n)e.push({line:i.startLine,level:i.level,header:i.header}),i.children&&i.children.length>0&&t(i.children)}return t(r),e}function Mn(r,e,t){for(let n=r.length-1;n>=0;n--)if(r[n].line<e&&r[n].level===t)return r[n].line;return null}function Ln(r,e,t){for(let n=0;n<r.length;n++)if(r[n].line>e&&r[n].level===t)return r[n].line;return null}function fr(r,e,t){for(let n=r.length-1;n>=0;n--)if(r[n].line<e&&r[n].level<t)return r[n].line;return null}function In(r,e,t){let n=t+1;for(let i=0;i<r.length;i++)if(r[i].line>e){if(r[i].level<=t)break;if(r[i].level===n)return r[i].line}return null}var Ye="Grid-Note-Markdown-View",St=class extends hr.MarkdownView{getViewType(){return Ye}getIcon(){return"star"}constructor(e){super(e)}async onOpen(){this.headerEl.style.display="flex",this.onClickEditor(),this.actionsEl.empty()}onScrollToSelectedRange(e){let t=e-1,n=sr(this.editor.getValue(),e);this.editor.setSelection({line:t,ch:0},{line:n?n-1:t,ch:0}),this.editor.focus()}onClickEditor(){this.editor.cm.dom.addEventListener("click",this.handleClick.bind(this))}handleClick(e){let t=e.target;if(t instanceof HTMLAnchorElement){let n=t.innerText,{basename:i,path:o}=this.file;if(!n.startsWith(i)){let s=t.parentNode;s&&s.classList.contains("cm-link")||this.app.workspace.openLinkText(n,o,!0)}}else this.handleScrollToLine()}handleScrollToLine(){let e=this.editor.getCursor(),t=or(this.editor.getValue(),e.line+1),n=t?t+1:e.line+1;this.syncScrollToGridNoteView(n)}syncScrollToGridNoteView(e){var t,n,i,o;try{let s=this.app.workspace.getActiveViewOfType(St);if(!s||s.leaf!==this.leaf)return;let l=this.app.workspace.getLeavesOfType("markdown").find(c=>{var u,h;let d=c.view;return d&&((u=d.file)==null?void 0:u.path)===((h=this.file)==null?void 0:h.path)&&c!==this.leaf});if(l){let c=l.view,d=(t=c.contentEl)==null?void 0:t.querySelector(".gridnote-container");if(d){if(this.app.workspace.setActiveLeaf(l),this.isLineVisibleInGridNoteView(c,e))return;try{let u=null;if(c.instance&&c.instance.currentLines&&(u=c.instance),!u){let h=(o=(i=(n=this.app.plugins)==null?void 0:n.plugins)==null?void 0:i["gird-note"])==null?void 0:o.viewToggleManager;if(h&&h.viewStates){let f=h.viewStates.get(l);f&&f.instance&&f.instance.currentLines&&(u=f.instance)}}if(!u){let h=d.querySelectorAll("*");for(let f of h)if(f.__svelte__&&f.__svelte__.ctx){let p=f.__svelte__.ctx;if(p&&p.length>0){for(let w=0;w<p.length;w++)if(p[w]&&typeof p[w]=="object"&&p[w].currentLines){u=p[w];break}}if(u)break}}u&&u.currentLines?(u.currentLines.set(-1),setTimeout(()=>{u.currentLines.set(e)},50)):c.scrollToLine&&c.scrollToLine(e-1)}catch(u){console.error("Error accessing Svelte instance:",u)}}}}catch(s){console.error("Error syncing scroll to GridNote view:",s)}}isLineVisibleInGridNoteView(e,t){try{if(!e.instance||!e.contentEl)return!1;let n=e.contentEl.querySelector(".gridnote-container");if(!n)return!1;let i=n.querySelector(`[data-line="${t}"]`)||n.querySelector(`[data-start-line="${t}"]`);if(!i)return!1;let o=n.getBoundingClientRect(),s=i.getBoundingClientRect();return s.top<o.bottom&&s.bottom>o.top}catch(n){return!1}}onSimulateClickFoldBtn(e,t){return this.editor.scrollIntoView({from:{line:t,ch:0},to:{line:t,ch:0}},!0),new Promise(n=>{let o=this.editor.cm.domAtPos(e),s=o.node instanceof Element?o.node:o.node.parentElement;if(!s)return n(!1);let a=s.querySelector(".cm-fold-indicator");if(a){let l=new MouseEvent("click",{bubbles:!1,cancelable:!0,view:window,button:0});a.dispatchEvent(l),n(!0)}else n(!1)})}async onClose(){this.editor.cm.dom.removeEventListener("click",this.handleClick)}};var en=require("obsidian");function J(){}var dt=r=>r;function Tn(r){return r()}function sn(){return Object.create(null)}function ce(r){r.forEach(Tn)}function Fe(r){return typeof r=="function"}function be(r,e){return r!=r?e==e:r!==e||r&&typeof r=="object"||typeof r=="function"}function pr(r){return Object.keys(r).length===0}function st(r,...e){if(r==null){for(let n of e)n(void 0);return J}let t=r.subscribe(...e);return t.unsubscribe?()=>t.unsubscribe():t}function Bt(r){let e;return st(r,t=>e=t)(),e}function at(r,e,t){r.$$.on_destroy.push(st(e,t))}function gr(r){return r&&Fe(r.destroy)?r.destroy:J}function An(r){let e=typeof r=="string"&&r.match(/^\s*(-?[\d.]+)([^\s]*)\s*$/);return e?[parseFloat(e[1]),e[2]||"px"]:[r,"px"]}var mr=typeof window!="undefined",Wt=mr?()=>window.performance.now():()=>Date.now(),qt=mr?r=>requestAnimationFrame(r):J;var Mt=new Set;function vr(r){Mt.forEach(e=>{e.c(r)||(Mt.delete(e),e.f())}),Mt.size!==0&&qt(vr)}function Gt(r){let e;return Mt.size===0&&qt(vr),{promise:new Promise(t=>{Mt.add(e={c:r,f:t})}),abort(){Mt.delete(e)}}}var Vn=typeof window!="undefined"?window:typeof globalThis!="undefined"?globalThis:global;var Lt=class{constructor(e){Ne(this,"_listeners","WeakMap"in Vn?new WeakMap:void 0);Ne(this,"_observer");Ne(this,"options");this.options=e}observe(e,t){return this._listeners.set(e,t),this._getObserver().observe(e,this.options),()=>{this._listeners.delete(e),this._observer.unobserve(e)}}_getObserver(){var e;return(e=this._observer)!=null?e:this._observer=new ResizeObserver(t=>{var n;for(let i of t)Lt.entries.set(i.target,i),(n=this._listeners.get(i.target))==null||n(i)})}};Lt.entries="WeakMap"in Vn?new WeakMap:void 0;var br=!1;function wr(){br=!0}function yr(){br=!1}function _(r,e){r.appendChild(e)}function ke(r,e,t){let n=an(r);if(!n.getElementById(e)){let i=C("style");i.id=e,i.textContent=t,_r(n,i)}}function an(r){if(!r)return document;let e=r.getRootNode?r.getRootNode():r.ownerDocument;return e&&e.host?e:r.ownerDocument}function xr(r){let e=C("style");return e.textContent="/* empty */",_r(an(r),e),e.sheet}function _r(r,e){return _(r.head||r,e),e.sheet}function P(r,e,t){r.insertBefore(e,t||null)}function O(r){r.parentNode&&r.parentNode.removeChild(r)}function wt(r,e){for(let t=0;t<r.length;t+=1)r[t]&&r[t].d(e)}function C(r){return document.createElement(r)}function Ee(r){return document.createTextNode(r)}function R(){return Ee(" ")}function ut(){return Ee("")}function B(r,e,t,n){return r.addEventListener(e,t,n),()=>r.removeEventListener(e,t,n)}function Fn(r){return function(e){return e.preventDefault(),r.call(this,e)}}function yt(r){return function(e){return e.stopPropagation(),r.call(this,e)}}function g(r,e,t){t==null?r.removeAttribute(e):r.getAttribute(e)!==t&&r.setAttribute(e,t)}function Nn(r){return r===""?null:+r}function kr(r){return Array.from(r.childNodes)}function Je(r,e){e=""+e,r.data!==e&&(r.data=e)}function Er(r,e){e=""+e,r.wholeText!==e&&(r.data=e)}function ft(r,e){r.value=e==null?"":e}function ue(r,e,t,n){t==null?r.style.removeProperty(e):r.style.setProperty(e,t,n?"important":"")}function j(r,e,t){r.classList.toggle(e,!!t)}function jt(r,e,{bubbles:t=!1,cancelable:n=!1}={}){return new CustomEvent(r,{detail:e,bubbles:t,cancelable:n})}function Cr(r){let e={};return r.childNodes.forEach(t=>{e[t.slot||"default"]=!0}),e}var ln=new Map,cn=0;function Oi(r){let e=5381,t=r.length;for(;t--;)e=(e<<5)-e^r.charCodeAt(t);return e>>>0}function Ri(r,e){let t={stylesheet:xr(e),rules:{}};return ln.set(r,t),t}function It(r,e,t,n,i,o,s,a=0){let l=16.666/n,c=`{
`;for(let b=0;b<=1;b+=l){let m=e+(t-e)*o(b);c+=b*100+`%{${s(m,1-m)}}
`}let d=c+`100% {${s(t,1-t)}}
}`,u=`__svelte_${Oi(d)}_${a}`,h=an(r),{stylesheet:f,rules:p}=ln.get(h)||Ri(h,r);p[u]||(p[u]=!0,f.insertRule(`@keyframes ${u} ${d}`,f.cssRules.length));let w=r.style.animation||"";return r.style.animation=`${w?`${w}, `:""}${u} ${n}ms linear ${i}ms 1 both`,cn+=1,u}function Tt(r,e){let t=(r.style.animation||"").split(", "),n=t.filter(e?o=>o.indexOf(e)<0:o=>o.indexOf("__svelte")===-1),i=t.length-n.length;i&&(r.style.animation=n.join(", "),cn-=i,cn||zi())}function zi(){qt(()=>{cn||(ln.forEach(r=>{let{ownerNode:e}=r.stylesheet;e&&O(e)}),ln.clear())})}var ht;function lt(r){ht=r}function At(){if(!ht)throw new Error("Function called outside component initialization");return ht}function Pe(r){At().$$.on_mount.push(r)}function Ke(r){At().$$.on_destroy.push(r)}function Kt(){let r=At();return(e,t,{cancelable:n=!1}={})=>{let i=r.$$.callbacks[e];if(i){let o=jt(e,t,{cancelable:n});return i.slice().forEach(s=>{s.call(r,o)}),!o.defaultPrevented}return!0}}function pt(r,e){return At().$$.context.set(r,e),e}function $e(r){return At().$$.context.get(r)}function Sr(r,e){let t=r.$$.callbacks[e.type];t&&t.slice().forEach(n=>n.call(this,e))}var xt=[];var re=[],Ft=[],Dn=[],Mr=Promise.resolve(),On=!1;function Rn(){On||(On=!0,Mr.then(dn))}function Ze(){return Rn(),Mr}function Be(r){Ft.push(r)}function Lr(r){Dn.push(r)}var Hn=new Set,Vt=0;function dn(){if(Vt!==0)return;let r=ht;do{try{for(;Vt<xt.length;){let e=xt[Vt];Vt++,lt(e),Pi(e.$$)}}catch(e){throw xt.length=0,Vt=0,e}for(lt(null),xt.length=0,Vt=0;re.length;)re.pop()();for(let e=0;e<Ft.length;e+=1){let t=Ft[e];Hn.has(t)||(Hn.add(t),t())}Ft.length=0}while(xt.length);for(;Dn.length;)Dn.pop()();On=!1,Hn.clear(),lt(r)}function Pi(r){if(r.fragment!==null){r.update(),ce(r.before_update);let e=r.dirty;r.dirty=[-1],r.fragment&&r.fragment.p(r.ctx,e),r.after_update.forEach(Be)}}function Ir(r){let e=[],t=[];Ft.forEach(n=>r.indexOf(n)===-1?e.push(n):t.push(n)),t.forEach(n=>n()),Ft=e}var Ut;function zn(){return Ut||(Ut=Promise.resolve(),Ut.then(()=>{Ut=null})),Ut}function _t(r,e,t){r.dispatchEvent(jt(`${e?"intro":"outro"}${t}`))}var un=new Set,et;function Ie(){et={r:0,c:[],p:et}}function Te(){et.r||ce(et.c),et=et.p}function D(r,e){r&&r.i&&(un.delete(r),r.i(e))}function W(r,e,t,n){if(r&&r.o){if(un.has(r))return;un.add(r),et.c.push(()=>{un.delete(r),n&&(t&&r.d(1),n())}),r.o(e)}else n&&n()}var Pn={duration:0};function Bn(r,e,t){let n={direction:"in"},i=e(r,t,n),o=!1,s,a,l=0;function c(){s&&Tt(r,s)}function d(){let{delay:h=0,duration:f=300,easing:p=dt,tick:w=J,css:b}=i||Pn;b&&(s=It(r,0,1,f,h,p,b,l++)),w(0,1);let m=Wt()+h,E=m+f;a&&a.abort(),o=!0,Be(()=>_t(r,!0,"start")),a=Gt(M=>{if(o){if(M>=E)return w(1,0),_t(r,!0,"end"),c(),o=!1;if(M>=m){let y=p((M-m)/f);w(y,1-y)}}return o})}let u=!1;return{start(){u||(u=!0,Tt(r),Fe(i)?(i=i(n),zn().then(d)):d())},invalidate(){u=!1},end(){o&&(c(),o=!1)}}}function Wn(r,e,t){let n={direction:"out"},i=e(r,t,n),o=!0,s,a=et;a.r+=1;let l;function c(){let{delay:d=0,duration:u=300,easing:h=dt,tick:f=J,css:p}=i||Pn;p&&(s=It(r,1,0,u,d,h,p));let w=Wt()+d,b=w+u;Be(()=>_t(r,!1,"start")),"inert"in r&&(l=r.inert,r.inert=!0),Gt(m=>{if(o){if(m>=b)return f(0,1),_t(r,!1,"end"),--a.r||ce(a.c),!1;if(m>=w){let E=h((m-w)/u);f(1-E,E)}}return o})}return Fe(i)?zn().then(()=>{i=i(n),c()}):c(),{end(d){d&&"inert"in r&&(r.inert=l),d&&i.tick&&i.tick(1,0),o&&(s&&Tt(r,s),o=!1)}}}function tt(r,e,t,n){let o=e(r,t,{direction:"both"}),s=n?0:1,a=null,l=null,c=null,d;function u(){c&&Tt(r,c)}function h(p,w){let b=p.b-s;return w*=Math.abs(b),{a:s,b:p.b,d:b,duration:w,start:p.start,end:p.start+w,group:p.group}}function f(p){let{delay:w=0,duration:b=300,easing:m=dt,tick:E=J,css:M}=o||Pn,y={start:Wt()+w,b:p};p||(y.group=et,et.r+=1),"inert"in r&&(p?d!==void 0&&(r.inert=d):(d=r.inert,r.inert=!0)),a||l?l=y:(M&&(u(),c=It(r,s,p,b,w,m,M)),p&&E(0,1),a=h(y,b),Be(()=>_t(r,p,"start")),Gt(I=>{if(l&&I>l.start&&(a=h(l,b),l=null,_t(r,a.b,"start"),M&&(u(),c=It(r,s,a.b,a.duration,0,m,o.css))),a){if(I>=a.end)E(s=a.b,1-s),_t(r,a.b,"end"),l||(a.b?u():--a.group.r||ce(a.group.c)),a=null;else if(I>=a.start){let L=I-a.start;s=a.a+a.d*m(L/a.duration),E(s,1-s)}}return!!(a||l)}))}return{run(p){Fe(o)?zn().then(()=>{o=o({direction:p?"in":"out"}),f(p)}):f(p)},end(){u(),a=l=null}}}function Re(r){return(r==null?void 0:r.length)!==void 0?r:Array.from(r)}function Tr(r,e){W(r,1,1,()=>{e.delete(r.key)})}function Ar(r,e,t,n,i,o,s,a,l,c,d,u){let h=r.length,f=o.length,p=h,w={};for(;p--;)w[r[p].key]=p;let b=[],m=new Map,E=new Map,M=[];for(p=f;p--;){let T=u(i,o,p),q=t(T),N=s.get(q);N?n&&M.push(()=>N.p(T,e)):(N=c(q,T),N.c()),m.set(q,b[p]=N),q in w&&E.set(q,Math.abs(p-w[q]))}let y=new Set,I=new Set;function L(T){D(T,1),T.m(a,d),s.set(T.key,T),d=T.first,f--}for(;h&&f;){let T=b[f-1],q=r[h-1],N=T.key,K=q.key;T===q?(d=T.first,h--,f--):m.has(K)?!s.has(N)||y.has(N)?L(T):I.has(K)?h--:E.get(N)>E.get(K)?(I.add(N),L(T)):(y.add(K),h--):(l(q,s),h--)}for(;h--;){let T=r[h];m.has(T.key)||l(T,s)}for(;f;)L(b[f-1]);return ce(M),b}var Bi=["allowfullscreen","allowpaymentrequest","async","autofocus","autoplay","checked","controls","default","defer","disabled","formnovalidate","hidden","inert","ismap","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected"],Wi=new Set([...Bi]);function Vr(r,e,t){let n=r.$$.props[e];n!==void 0&&(r.$$.bound[n]=t,t(r.$$.ctx[n]))}function Ae(r){r&&r.c()}function Ce(r,e,t){let{fragment:n,after_update:i}=r.$$;n&&n.m(e,t),Be(()=>{let o=r.$$.on_mount.map(Tn).filter(Fe);r.$$.on_destroy?r.$$.on_destroy.push(...o):ce(o),r.$$.on_mount=[]}),i.forEach(Be)}function Se(r,e){let t=r.$$;t.fragment!==null&&(Ir(t.after_update),ce(t.on_destroy),t.fragment&&t.fragment.d(e),t.on_destroy=t.fragment=null,t.ctx=[])}function Gi(r,e){r.$$.dirty[0]===-1&&(xt.push(r),Rn(),r.$$.dirty.fill(0)),r.$$.dirty[e/31|0]|=1<<e%31}function Me(r,e,t,n,i,o,s=null,a=[-1]){let l=ht;lt(r);let c=r.$$={fragment:null,ctx:[],props:o,update:J,not_equal:i,bound:sn(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(l?l.$$.context:[])),callbacks:sn(),dirty:a,skip_bound:!1,root:e.target||l.$$.root};s&&s(c.root);let d=!1;if(c.ctx=t?t(r,e.props||{},(u,h,...f)=>{let p=f.length?f[0]:h;return c.ctx&&i(c.ctx[u],c.ctx[u]=p)&&(!c.skip_bound&&c.bound[u]&&c.bound[u](p),d&&Gi(r,u)),h}):[],c.update(),d=!0,ce(c.before_update),c.fragment=n?n(c.ctx):!1,e.target){if(e.hydrate){wr();let u=kr(e.target);c.fragment&&c.fragment.l(u),u.forEach(O)}else c.fragment&&c.fragment.c();e.intro&&D(r.$$.fragment),Ce(r,e.target,e.anchor),yr(),dn()}lt(l)}var ji;typeof HTMLElement=="function"&&(ji=class extends HTMLElement{constructor(e,t,n){super();Ne(this,"$$ctor");Ne(this,"$$s");Ne(this,"$$c");Ne(this,"$$cn",!1);Ne(this,"$$d",{});Ne(this,"$$r",!1);Ne(this,"$$p_d",{});Ne(this,"$$l",{});Ne(this,"$$l_u",new Map);this.$$ctor=e,this.$$s=t,n&&this.attachShadow({mode:"open"})}addEventListener(e,t,n){if(this.$$l[e]=this.$$l[e]||[],this.$$l[e].push(t),this.$$c){let i=this.$$c.$on(e,t);this.$$l_u.set(t,i)}super.addEventListener(e,t,n)}removeEventListener(e,t,n){if(super.removeEventListener(e,t,n),this.$$c){let i=this.$$l_u.get(t);i&&(i(),this.$$l_u.delete(t))}}async connectedCallback(){if(this.$$cn=!0,!this.$$c){let e=function(o){return()=>{let s;return{c:function(){s=C("slot"),o!=="default"&&g(s,"name",o)},m:function(c,d){P(c,s,d)},d:function(c){c&&O(s)}}}};if(await Promise.resolve(),!this.$$cn||this.$$c)return;let t={},n=Cr(this);for(let o of this.$$s)o in n&&(t[o]=[e(o)]);for(let o of this.attributes){let s=this.$$g_p(o.name);s in this.$$d||(this.$$d[s]=qn(s,o.value,this.$$p_d,"toProp"))}for(let o in this.$$p_d)!(o in this.$$d)&&this[o]!==void 0&&(this.$$d[o]=this[o],delete this[o]);this.$$c=new this.$$ctor({target:this.shadowRoot||this,props:{...this.$$d,$$slots:t,$$scope:{ctx:[]}}});let i=()=>{this.$$r=!0;for(let o in this.$$p_d)if(this.$$d[o]=this.$$c.$$.ctx[this.$$c.$$.props[o]],this.$$p_d[o].reflect){let s=qn(o,this.$$d[o],this.$$p_d,"toAttribute");s==null?this.removeAttribute(this.$$p_d[o].attribute||o):this.setAttribute(this.$$p_d[o].attribute||o,s)}this.$$r=!1};this.$$c.$$.after_update.push(i),i();for(let o in this.$$l)for(let s of this.$$l[o]){let a=this.$$c.$on(o,s);this.$$l_u.set(s,a)}this.$$l={}}}attributeChangedCallback(e,t,n){var i;this.$$r||(e=this.$$g_p(e),this.$$d[e]=qn(e,n,this.$$p_d,"toProp"),(i=this.$$c)==null||i.$set({[e]:this.$$d[e]}))}disconnectedCallback(){this.$$cn=!1,Promise.resolve().then(()=>{!this.$$cn&&this.$$c&&(this.$$c.$destroy(),this.$$c=void 0)})}$$g_p(e){return Object.keys(this.$$p_d).find(t=>this.$$p_d[t].attribute===e||!this.$$p_d[t].attribute&&t.toLowerCase()===e)||e}});function qn(r,e,t,n){var o;let i=(o=t[r])==null?void 0:o.type;if(e=i==="Boolean"&&typeof e!="boolean"?e!=null:e,!n||!t[r])return e;if(n==="toAttribute")switch(i){case"Object":case"Array":return e==null?null:JSON.stringify(e);case"Boolean":return e?"":null;case"Number":return e==null?null:e;default:return e}else switch(i){case"Object":case"Array":return e&&JSON.parse(e);case"Boolean":return e;case"Number":return e!=null?+e:e;default:return e}}var ge=class{constructor(){Ne(this,"$$");Ne(this,"$$set")}$destroy(){Se(this,1),this.$destroy=J}$on(e,t){if(!Fe(t))return J;let n=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return n.push(t),()=>{let i=n.indexOf(t);i!==-1&&n.splice(i,1)}}$set(e){this.$$set&&!pr(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}};var Fr="4";typeof window!="undefined"&&(window.__svelte||(window.__svelte={v:new Set})).v.add(Fr);var hn=require("obsidian");var Nt=[];function He(r,e=J){let t,n=new Set;function i(a){if(be(r,a)&&(r=a,t)){let l=!Nt.length;for(let c of n)c[1](),Nt.push(c,r);if(l){for(let c=0;c<Nt.length;c+=2)Nt[c][0](Nt[c+1]);Nt.length=0}}}function o(a){i(a(r))}function s(a,l=J){let c=[a,l];return n.add(c),n.size===1&&(t=e(i,o)||J),a(r),()=>{n.delete(c),n.size===0&&t&&(t(),t=null)}}return{set:i,update:o,subscribe:s}}var Ki=He({activeEditorId:null}),gt=class{constructor(){this.state=Ki}static getInstance(){return gt.instance||(gt.instance=new gt),gt.instance}requestEdit(e){return this.state.update(t=>({...t,activeEditorId:e})),!0}exitEdit(e){this.state.update(t=>t.activeEditorId===e?{...t,activeEditorId:null}:t)}isEditing(e){let t={activeEditorId:null};return this.state.subscribe(i=>{t=i})(),t.activeEditorId===e}subscribe(e){return this.state.subscribe(e)}forceExitAll(){this.state.set({activeEditorId:null})}},ct=gt.getInstance();var Nr=require("obsidian"),Yt=require("@codemirror/state"),Ht=class extends Nr.Component{constructor(t,n,i={}){super();this.widgetEditor=null;this.app=t,this.containerEl=n,this.options=i,this._value=i.value||"",this.initialize()}async initialize(){try{await this.createObsidianEditor()||this.createTextareaEditor()}catch(t){this.createTextareaEditor()}}async createObsidianEditor(){var t,n,i,o,s,a;try{let l=this.app;if(!((n=(t=l.embedRegistry)==null?void 0:t.embedByExtension)!=null&&n.md))return console.warn("embedRegistry not available"),!1;if(this.widgetEditor=l.embedRegistry.embedByExtension.md({app:this.app,containerEl:this.containerEl},null,this._value||""),!this.widgetEditor)return console.warn("Failed to create widget editor"),!1;if(this.widgetEditor.editable=!0,this.widgetEditor.showEditor&&this.widgetEditor.showEditor(),(i=this.widgetEditor.editMode)!=null&&i.editor){let c=this.widgetEditor.editMode.editor;if((o=c.cm)!=null&&o.dom?this.editorEl=c.cm.dom:this.editorEl=this.containerEl.querySelector(".cm-editor"),this._value&&c.setValue)c.setValue(this._value);else if(this._value&&c.cm)try{c.cm.dispatch({changes:{from:0,to:c.cm.state.doc.length,insert:this._value}})}catch(d){console.warn("Failed to set initial value:",d)}if(this.options.cursorLocation&&((s=c.cm)!=null&&s.dispatch))try{c.cm.dispatch({selection:Yt.EditorSelection.range(this.options.cursorLocation.anchor,this.options.cursorLocation.head)})}catch(d){console.warn("Failed to set cursor:",d)}else if((a=c.cm)!=null&&a.dispatch)try{let d=c.cm.state.doc.length;c.cm.dispatch({selection:Yt.EditorSelection.cursor(d)})}catch(d){console.warn("Failed to set cursor to end:",d)}return this.options.cls&&this.editorEl&&this.editorEl.classList.add(this.options.cls),this.editorEl&&(this.editorEl.style.fontSize="14px"),this.setupObsidianEditorEvents(c),!0}return console.warn("Editor instance not available"),!1}catch(l){return console.warn("Failed to create Obsidian editor:",l),!1}}setupObsidianEditorEvents(t){if(!t.cm)return;let n=t.cm,i=n.contentDOM||n.dom;if(!i){console.warn("Content DOM not available");return}let o=()=>{setTimeout(()=>{var u,h;let d=this.value;d!==this._value&&(this._value=d,(h=(u=this.options).onChange)==null||h.call(u,d))},0)},s=d=>{var u,h,f,p,w,b;if(d.key==="Escape")(h=(u=this.options).onEscape)==null||h.call(u,this),d.preventDefault(),d.stopPropagation();else if(d.key==="Enter"){let m=d.ctrlKey||d.metaKey,E=d.shiftKey;(p=(f=this.options).onEnter)!=null&&p.call(f,this,m,E)&&d.preventDefault()}else d.key==="s"&&(d.ctrlKey||d.metaKey)&&((b=(w=this.options).onSave)==null||b.call(w,this),d.preventDefault())},a=()=>{var d,u;(u=(d=this.options).onBlur)==null||u.call(d,this)},l=d=>{var u,h;(h=(u=this.options).onPaste)==null||h.call(u,d,this)};i.addEventListener("keydown",s),i.addEventListener("blur",a),i.addEventListener("paste",l),i.addEventListener("input",o);let c=new MutationObserver(o);c.observe(i,{childList:!0,subtree:!0,characterData:!0}),this.register(()=>{c.disconnect(),i.removeEventListener("keydown",s),i.removeEventListener("blur",a),i.removeEventListener("paste",l),i.removeEventListener("input",o)})}createTextareaEditor(){this.editorEl=this.containerEl.createEl("textarea",{cls:this.options.cls||"embeddable-editor-textarea",attr:{placeholder:this.options.placeholder||"Edit markdown here...",value:this._value}});let t=this.editorEl;Object.assign(t.style,{width:"100%",minHeight:"120px",border:"1px solid var(--background-modifier-border)",borderRadius:"6px",outline:"none",resize:"vertical",fontFamily:"var(--font-text)",fontSize:"14px",background:"var(--background-primary)",color:"var(--text-normal)",padding:"12px",lineHeight:"1.6"}),t.addEventListener("input",()=>{var n,i;this._value=t.value,(i=(n=this.options).onChange)==null||i.call(n,this._value)}),t.addEventListener("keydown",n=>{var i,o,s,a,l,c,d,u;if(n.key==="Escape")(o=(i=this.options).onEscape)==null||o.call(i,this),n.preventDefault(),n.stopPropagation();else if(n.key==="Enter"&&(n.ctrlKey||n.metaKey))(a=(s=this.options).onEnter)!=null&&a.call(s,this,!0,n.shiftKey)&&n.preventDefault();else if(n.key==="s"&&(n.ctrlKey||n.metaKey))(c=(l=this.options).onSave)==null||c.call(l,this),n.preventDefault();else if(n.key==="Tab"){n.preventDefault();let h=t.selectionStart,f=t.selectionEnd;t.value=t.value.substring(0,h)+"	"+t.value.substring(f),t.selectionStart=t.selectionEnd=h+1,this._value=t.value,(u=(d=this.options).onChange)==null||u.call(d,this._value)}}),t.addEventListener("blur",()=>{var n,i;(i=(n=this.options).onBlur)==null||i.call(n,this)}),t.addEventListener("paste",n=>{var i,o;(o=(i=this.options).onPaste)==null||o.call(i,n,this)}),setTimeout(()=>{let n=t.value.length;t.selectionStart=t.selectionEnd=n},0)}get value(){var n,i,o,s;if((i=(n=this.widgetEditor)==null?void 0:n.editMode)!=null&&i.editor)try{let a=this.widgetEditor.editMode.editor;if(a.getValue&&typeof a.getValue=="function")return a.getValue();if((s=(o=a.cm)==null?void 0:o.state)!=null&&s.doc)return a.cm.state.doc.toString()}catch(a){console.warn("Error getting value from native editor:",a)}let t=this.editorEl;return(t==null?void 0:t.value)||this._value}setValue(t){var i,o;if(this._value=t,(o=(i=this.widgetEditor)==null?void 0:i.editMode)!=null&&o.editor)try{let s=this.widgetEditor.editMode.editor;s.setValue?s.setValue(t):s.cm&&s.cm.dispatch({changes:{from:0,to:s.cm.state.doc.length,insert:t}});return}catch(s){console.warn("Error setting value to native editor:",s)}let n=this.editorEl;n&&(n.value=t)}focus(){var t,n,i,o;if((i=(n=(t=this.widgetEditor)==null?void 0:t.editMode)==null?void 0:n.editor)!=null&&i.cm)try{this.widgetEditor.editMode.editor.cm.focus();return}catch(s){console.warn("Error focusing native editor:",s)}(o=this.editorEl)==null||o.focus()}getCursor(){var n,i,o;if((o=(i=(n=this.widgetEditor)==null?void 0:n.editMode)==null?void 0:i.editor)!=null&&o.cm)try{return this.widgetEditor.editMode.editor.cm.state.selection.main.head}catch(s){console.warn("Error getting cursor from native editor:",s)}let t=this.editorEl;return(t==null?void 0:t.selectionStart)||0}setCursor(t){var i,o,s;if((s=(o=(i=this.widgetEditor)==null?void 0:i.editMode)==null?void 0:o.editor)!=null&&s.cm)try{this.widgetEditor.editMode.editor.cm.dispatch({selection:Yt.EditorSelection.cursor(t)});return}catch(a){console.warn("Error setting cursor in native editor:",a)}let n=this.editorEl;n&&(n.selectionStart=n.selectionEnd=t,n.focus())}setCursorToEnd(){var n,i,o;if((o=(i=(n=this.widgetEditor)==null?void 0:n.editMode)==null?void 0:i.editor)!=null&&o.cm)try{let s=this.widgetEditor.editMode.editor.cm.state.doc.length;this.widgetEditor.editMode.editor.cm.dispatch({selection:Yt.EditorSelection.cursor(s)});return}catch(s){console.warn("Error setting cursor to end in native editor:",s)}let t=this.editorEl;if(t){let s=t.value.length;t.selectionStart=t.selectionEnd=s,t.focus()}}destroy(){var t,n;if(this.widgetEditor){try{(n=(t=this.widgetEditor).unload)==null||n.call(t)}catch(i){console.warn("Error unloading widget editor:",i)}this.widgetEditor=null}this.containerEl.empty(),super.unload()}onunload(){this.destroy()}};var ze=class{constructor(e){this.activeEditors=new Map;this.eventRefs=[];this.cleanupDebounceTimer=null;this.app=e,this.setupEventListeners()}static getInstance(e){return ze.instance||(ze.instance=new ze(e)),ze.instance}setupEventListeners(){this.eventRefs.push(this.app.workspace.on("layout-change",()=>{this.debouncedCleanupClosedEditors()})),this.eventRefs.push(this.app.workspace.on("file-open",e=>{e&&e.extension==="md"&&this.handleFileOpen(e)}))}debouncedCleanupClosedEditors(){this.cleanupDebounceTimer&&clearTimeout(this.cleanupDebounceTimer),this.cleanupDebounceTimer=setTimeout(()=>{this.cleanupClosedEditors(),this.cleanupDebounceTimer=null},100)}async openFallbackEditor(e,t,n){if(!e)return null;let i=e.path,o=this.activeEditors.get(i);if(o){if(this.app.workspace.getLeavesOfType(Ye).some(l=>l===o.leaf)&&o.leaf.view)return this.app.workspace.setActiveLeaf(o.leaf),t&&o.view.onScrollToSelectedRange&&queueMicrotask(()=>{o.view.onScrollToSelectedRange(t.startLine)}),o.view;this.activeEditors.delete(i)}return this.createNewFallbackEditor(e,t,n)}async createNewFallbackEditor(e,t,n){var i,o,s;try{(i=this.app.workspace.rightSplit)!=null&&i.collapsed&&((o=this.app.workspace.rightSplit)==null||o.expand());let a=this.app.workspace.getRightLeaf(!1);if(!a)return null;await a.setViewState({type:Ye,state:{file:e.path}});let l=a.view;return l?(await new Promise(c=>queueMicrotask(()=>c(void 0))),((s=l.file)==null?void 0:s.path)!==e.path&&await a.setViewState({type:Ye,state:{file:e.path}}),this.activeEditors.set(e.path,{leaf:a,view:l,filePath:e.path}),this.app.workspace.setActiveLeaf(a),t&&l.onScrollToSelectedRange&&queueMicrotask(()=>{l.onScrollToSelectedRange(t.startLine)}),l):null}catch(a){return console.error("Error creating fallback editor:",a),null}}static isEmbeddableEditorAvailable(e){var t,n;try{return!!((n=(t=e.embedRegistry)==null?void 0:t.embedByExtension)!=null&&n.md)}catch(i){return!1}}getFallbackEditor(e){return this.activeEditors.get(e)}closeFallbackEditor(e){let t=this.activeEditors.get(e);t&&(t.leaf&&t.leaf.view&&t.leaf.detach(),this.activeEditors.delete(e))}handleFileOpen(e){var n;let t=this.activeEditors.get(e.path);t&&((n=t.view.file)==null?void 0:n.path)!==e.path&&t.leaf.setViewState({type:Ye,state:{file:e.path}})}cleanupClosedEditors(){let e=[],t=new Set;this.app.workspace.getLeavesOfType("markdown").forEach(i=>{let o=i.view;o&&o.file&&t.add(o.file.path)}),this.activeEditors.forEach((i,o)=>{(!this.app.workspace.getLeavesOfType(Ye).some(l=>l===i.leaf)||!i.leaf.view||!t.has(o))&&e.push(o)}),e.forEach(i=>{let o=this.activeEditors.get(i);o&&(o.leaf&&o.leaf.view&&o.leaf.detach(),this.activeEditors.delete(i))})}getActiveEditors(){return new Map(this.activeEditors)}closeAllFallbackEditors(){this.activeEditors.forEach((e,t)=>{e.leaf&&e.leaf.view&&e.leaf.detach()}),this.activeEditors.clear()}destroy(){this.cleanupDebounceTimer&&(clearTimeout(this.cleanupDebounceTimer),this.cleanupDebounceTimer=null),this.eventRefs.forEach(e=>{this.app.workspace.offref(e)}),this.eventRefs=[],this.closeAllFallbackEditors(),ze.instance=null}};var Hr=require("obsidian"),fn=class extends Hr.Modal{constructor(t,n,i=""){super(t);this.imageSrc=n,this.imageAlt=i}onOpen(){let{contentEl:t,modalEl:n,titleEl:i}=this;n.addClass("image-preview-modal");let o=n.querySelector(".modal-close-button");o&&(o.style.display="none"),i&&this.imageAlt?i.setText(this.imageAlt):i&&i.setText("\u56FE\u7247\u9884\u89C8"),t.empty();let a=t.createDiv("image-preview-container").createEl("img",{attr:{src:this.imageSrc,alt:this.imageAlt}});a.onload=()=>{this.adjustImageSize(a)},this.addStyles()}onClose(){let{contentEl:t}=this;t.empty()}adjustImageSize(t){let n=window.innerWidth*.9,i=window.innerHeight*.8,o=60,s=40,a=i-o,l=t.naturalWidth,c=t.naturalHeight;if(l===0||c===0)return;let d=(n-s)/l,u=a/c,h=Math.min(d,u,1),f=l*h,p=c*h;t.style.width=`${f}px`,t.style.height=`${p}px`,t.style.maxWidth=`${f}px`,t.style.maxHeight=`${p}px`;let w=Math.min(f+s,n),b=p+o+s;this.modalEl.style.width=`${w}px`,this.modalEl.style.height=`${b}px`,this.modalEl.style.maxWidth=`${w}px`,this.modalEl.style.maxHeight=`${b}px`,this.modalEl.style.overflow="hidden",this.modalEl.style.position="fixed",this.modalEl.style.left="50%",this.modalEl.style.top="50%",this.modalEl.style.transform="translate(-50%, -50%)"}addStyles(){if(document.getElementById("image-preview-modal-styles"))return;let t=document.createElement("style");t.id="image-preview-modal-styles",t.textContent=`
			.image-preview-modal {
				padding: 0;
				overflow: hidden !important;
			}
			
			.image-preview-modal .modal-content {
				padding: 0;
				background: var(--background-primary);
				border-radius: 12px;
				box-shadow: var(--shadow-l);
				overflow: hidden;
				margin: 0;
				height: 100%;
				display: flex;
				flex-direction: column;
			}
			
			.image-preview-modal .modal-header {
				flex-shrink: 0;
				border-bottom: 1px solid var(--background-modifier-border);
				padding: 16px 20px;
			}
			
			.image-preview-modal .modal-title {
				font-size: 16px;
				font-weight: 500;
				color: var(--text-normal);
				margin: 0;
				text-align: center;
			}
			
			.image-preview-modal .modal-close-button {
				display: none !important;
			}
			
			.image-preview-container {
				flex: 1;
				display: flex;
				align-items: center;
				justify-content: center;
				padding: 20px;
				background: var(--background-primary);
				overflow: hidden;
			}
			
			.image-preview-container img {
				object-fit: contain;
				border-radius: 8px;
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
				display: block;
			}
			
			/* \u6697\u8272\u4E3B\u9898\u9002\u914D */
			.theme-dark .image-preview-container {
				background: var(--background-primary);
			}
			
			.theme-dark .image-preview-container img {
				box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
			}
			
			/* \u79FB\u52A8\u7AEF\u9002\u914D */
			@media (max-width: 768px) {
				.image-preview-container {
					padding: 10px;
				}
				
				.image-preview-container img {
					max-width: 95vw;
					max-height: 75vh;
				}
				
				.image-preview-caption {
					font-size: 12px;
					padding: 0 10px 10px;
				}
			}
		`,document.head.appendChild(t)}};function Dr(r,e={}){let t=e;function n(o){if(!t.enabled)return;let s=o.target;if(s.tagName==="IMG"){let a=s;if(i(a))return;o.preventDefault(),o.stopPropagation();let l=a.src,c=a.alt||"";t.onImageClick&&t.onImageClick(l,c)}}function i(o){let s=o.naturalWidth||parseInt(o.getAttribute("width")||"0"),a=o.naturalHeight||parseInt(o.getAttribute("height")||"0");if(s>0&&a>0&&(s<64||a<64))return!0;let l=o.src.toLowerCase(),c=o.alt.toLowerCase();return!!(l.includes("icon")||l.includes("avatar")||c.includes("icon")||c.includes("avatar")||o.classList.contains("no-preview")||o.classList.contains("icon")||o.classList.contains("avatar"))}return r.addEventListener("click",n,!0),{update(o){t={...t,...o}},destroy(){r.removeEventListener("click",n,!0)}}}function Ui(r){ke(r,"svelte-1evr0xc",'@charset "UTF-8";.markdown-editor-wrapper.svelte-1evr0xc{position:relative;min-height:120px;border-radius:4px}.markdown-editor-container.svelte-1evr0xc{border:2px solid var(--interactive-accent);border-radius:8px;background:var(--background-primary);overflow:hidden;box-shadow:0 4px 16px rgba(var(--color-accent-rgb), 0.15)}.editor-container.svelte-1evr0xc{min-height:120px;font-size:var(--font-text-size)}.editor-container.svelte-1evr0xc .cm-editor{font-size:var(--font-text-size) !important}.editor-container.svelte-1evr0xc .cm-scroller{padding:8px !important;font-size:var(--font-text-size) !important}.editor-container.svelte-1evr0xc .cm-content{font-size:var(--font-text-size) !important}.editor-container.svelte-1evr0xc .markdown-embed-link{display:none}.editor-toolbar.svelte-1evr0xc{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--background-secondary);border-top:1px solid var(--background-modifier-border)}.editor-hint.svelte-1evr0xc{font-size:11px;color:var(--text-faint);opacity:0.8}.editor-actions.svelte-1evr0xc{display:flex;gap:8px}.btn-primary.svelte-1evr0xc,.btn-secondary.svelte-1evr0xc{padding:4px 12px;border:none;border-radius:4px;font-size:12px;font-weight:500;cursor:pointer;transition:all 0.2s ease}.btn-primary.svelte-1evr0xc{background:var(--interactive-accent);color:var(--text-on-accent)}.btn-primary.svelte-1evr0xc:hover{background:var(--interactive-accent-hover);transform:translateY(-1px)}.btn-secondary.svelte-1evr0xc{background:var(--background-primary);color:var(--text-normal);border:1px solid var(--background-modifier-border)}.btn-secondary.svelte-1evr0xc:hover{background:var(--background-modifier-hover);transform:translateY(-1px)}.markdown-rendered.svelte-1evr0xc{max-width:100%;min-height:100px;user-select:text;font-size:var(--font-text-size);line-height:1.5;cursor:pointer;transition:opacity 0.2s;overflow-x:hidden;word-wrap:break-word}.markdown-rendered.svelte-1evr0xc h1{font-size:calc(var(--font-text-size) * 2)}.markdown-rendered.svelte-1evr0xc h2{font-size:calc(var(--font-text-size) * 1.6)}.markdown-rendered.svelte-1evr0xc h3{font-size:calc(var(--font-text-size) * 1.4)}.markdown-rendered.svelte-1evr0xc h4{font-size:calc(var(--font-text-size) * 1.2)}.markdown-rendered.svelte-1evr0xc h5{font-size:calc(var(--font-text-size) * 1.1)}.markdown-rendered.svelte-1evr0xc h6{font-size:var(--font-text-size)}.markdown-rendered.svelte-1evr0xc:lang(zh){letter-spacing:0.05em}.markdown-rendered.svelte-1evr0xc img{width:100%;min-width:200px;max-width:500px;height:auto;border-radius:8px;box-shadow:0 2px 8px rgba(0, 0, 0, 0.1);margin:16px 0}.markdown-rendered.svelte-1evr0xc img:hover{box-shadow:0 4px 16px rgba(0, 0, 0, 0.15);transform:scale(1.02);transition:all 0.3s ease}.markdown-rendered.svelte-1evr0xc .layout-left{display:block;margin:16px auto 16px 0}.markdown-rendered.svelte-1evr0xc .layout-right{display:block;margin:16px 0 16px auto}.markdown-rendered.svelte-1evr0xc .layout-center{display:block;margin:16px auto}.markdown-rendered.svelte-1evr0xc .layout-full{display:block;width:100% !important;max-width:100% !important;margin:16px 0}.markdown-rendered.svelte-1evr0xc .shape-circle{border-radius:50% !important;width:200px !important;height:200px !important;object-fit:cover}.markdown-rendered.svelte-1evr0xc .shape-round{border-radius:20px !important}.markdown-rendered.svelte-1evr0xc .image-left-paragraph{text-align:left}.markdown-rendered.svelte-1evr0xc .image-right-paragraph{text-align:right}.markdown-rendered.svelte-1evr0xc .image-center-paragraph{text-align:center}.markdown-rendered.svelte-1evr0xc .image-full-paragraph{text-align:center}.markdown-rendered.svelte-1evr0xc .embed-left-paragraph{text-align:left}.markdown-rendered.svelte-1evr0xc .embed-center-paragraph{text-align:center}.markdown-rendered.svelte-1evr0xc .embed-right-paragraph{text-align:right}.markdown-rendered.svelte-1evr0xc .embed-full-paragraph{text-align:center}.markdown-rendered.svelte-1evr0xc .internal-embed.layout-left{display:block;margin:16px auto 16px 0}.markdown-rendered.svelte-1evr0xc .internal-embed.layout-right{display:block;margin:16px 0 16px auto}.markdown-rendered.svelte-1evr0xc .internal-embed.layout-center{display:block;margin:16px auto}.markdown-rendered.svelte-1evr0xc .internal-embed.layout-full{display:block;width:100% !important;max-width:100% !important;margin:16px 0}.markdown-rendered.svelte-1evr0xc img[src*="icon"]:not(.layout-left):not(.layout-center):not(.layout-full),.markdown-rendered.svelte-1evr0xc img[src*="avatar"]:not(.layout-left):not(.layout-center):not(.layout-full),.markdown-rendered.svelte-1evr0xc img[width="16"]:not(.layout-left):not(.layout-center):not(.layout-full),.markdown-rendered.svelte-1evr0xc img[width="24"]:not(.layout-left):not(.layout-center):not(.layout-full),.markdown-rendered.svelte-1evr0xc img[width="32"]:not(.layout-left):not(.layout-center):not(.layout-full){margin:8px 0 8px auto !important;max-width:64px !important}.markdown-rendered.svelte-1evr0xc:not(.editing) img:not(.no-preview):not(.icon):not(.avatar){cursor:zoom-in;transition:all 0.2s ease}.markdown-rendered.svelte-1evr0xc:not(.editing) img:not(.no-preview):not(.icon):not(.avatar):hover{opacity:0.9;transform:scale(1.02);box-shadow:0 4px 12px rgba(0, 0, 0, 0.15)}.markdown-rendered.svelte-1evr0xc video{max-width:400px !important;border-radius:8px;box-shadow:0 2px 8px rgba(0, 0, 0, 0.1)}.markdown-rendered.svelte-1evr0xc video:hover{box-shadow:0 4px 16px rgba(0, 0, 0, 0.15);transition:all 0.3s ease}.markdown-rendered.svelte-1evr0xc:empty::before{content:"\u53CC\u51FB\u7F16\u8F91\u5185\u5BB9...";color:var(--text-muted);font-style:italic;opacity:0.6}.selected.svelte-1evr0xc{box-shadow:0 0 0 2px var(--color-accent)}.search-highlight{background:var(--text-highlight-bg);color:var(--text-on-accent);border-radius:2px;box-shadow:0 0 0 2px var(--text-highlight-bg)}.search-current{background:var(--text-selection);color:var(--text-normal)}.node-preview{font-size:var(--font-text-size);margin-right:20px}.node-preview p{margin:0}.markdown-rendered.level-one-content.svelte-1evr0xc p{text-align:center}.markdown-rendered.level-one-content.svelte-1evr0xc h1,.markdown-rendered.level-one-content.svelte-1evr0xc h2,.markdown-rendered.level-one-content.svelte-1evr0xc h3,.markdown-rendered.level-one-content.svelte-1evr0xc h4,.markdown-rendered.level-one-content.svelte-1evr0xc h5,.markdown-rendered.level-one-content.svelte-1evr0xc h6{text-align:center}.markdown-rendered.level-one-content.svelte-1evr0xc ul,.markdown-rendered.level-one-content.svelte-1evr0xc ol{text-align:left;display:inline-block}.markdown-rendered.level-one-content.svelte-1evr0xc pre{text-align:left;max-width:100%;overflow-x:auto;white-space:pre-wrap;word-wrap:break-word;word-break:break-all}.markdown-rendered.level-one-content.svelte-1evr0xc code{text-align:left;max-width:100%;word-wrap:break-word;word-break:break-all}.markdown-rendered.level-one-content.svelte-1evr0xc div[class*="language-"],.markdown-rendered.level-one-content.svelte-1evr0xc div[class*="hljs"],.markdown-rendered.level-one-content.svelte-1evr0xc .cm-editor{text-align:left}.markdown-rendered.level-one-content.svelte-1evr0xc table{text-align:left;margin:0 auto}.markdown-rendered.level-one-content.svelte-1evr0xc blockquote{text-align:left}.markdown-editor-wrapper.svelte-1evr0xc .math,.markdown-editor-wrapper.svelte-1evr0xc .math-inline,.markdown-editor-wrapper.svelte-1evr0xc .math-block,.markdown-editor-wrapper.svelte-1evr0xc .mjx-container,.markdown-editor-wrapper.svelte-1evr0xc .katex,.markdown-editor-wrapper.svelte-1evr0xc .katex-display{font-size:larger !important}.editor-container.svelte-1evr0xc .math,.editor-container.svelte-1evr0xc .math-inline,.editor-container.svelte-1evr0xc .math-block,.editor-container.svelte-1evr0xc .mjx-container,.editor-container.svelte-1evr0xc .katex,.editor-container.svelte-1evr0xc .katex-display,.editor-container.svelte-1evr0xc .cm-math{font-size:larger !important}')}function Yi(r){let e,t,n,i;return{c(){e=C("div"),g(e,"class","markdown-rendered svelte-1evr0xc"),j(e,"selected",Zi),j(e,"level-one-content",r[0])},m(o,s){P(o,e,s),r[18](e),n||(i=gr(t=Dr.call(null,e,{enabled:!r[1],onImageClick:r[6]})),n=!0)},p(o,s){t&&Fe(t.update)&&s[0]&2&&t.update.call(null,{enabled:!o[1],onImageClick:o[6]}),s[0]&1&&j(e,"level-one-content",o[0])},d(o){o&&O(e),r[18](null),n=!1,i()}}}function Ji(r){let e,t,n,i,o,s,a,l,c,d,u,h;return{c(){e=C("div"),t=C("div"),n=R(),i=C("div"),o=C("div"),o.innerHTML="<span>\u2328 Ctrl/Cmd + S \u6216 Enter \u4FDD\u5B58 \xB7 Esc \u53D6\u6D88</span>",s=R(),a=C("div"),l=C("button"),l.textContent="\u53D6\u6D88",c=R(),d=C("button"),d.textContent="\u4FDD\u5B58",g(t,"class","editor-container svelte-1evr0xc"),g(o,"class","editor-hint svelte-1evr0xc"),g(l,"class","btn-secondary svelte-1evr0xc"),g(d,"class","btn-primary svelte-1evr0xc"),g(a,"class","editor-actions svelte-1evr0xc"),g(i,"class","editor-toolbar svelte-1evr0xc"),g(e,"class","markdown-editor-container svelte-1evr0xc")},m(f,p){P(f,e,p),_(e,t),r[17](t),_(e,n),_(e,i),_(i,o),_(i,s),_(i,a),_(a,l),_(a,c),_(a,d),u||(h=[B(l,"mousedown",Fn(r[5])),B(d,"mousedown",Fn(r[4]))],u=!0)},p:J,d(f){f&&O(e),r[17](null),u=!1,ce(h)}}}function Xi(r){let e;function t(o,s){return o[1]?Ji:Yi}let n=t(r,[-1,-1]),i=n(r);return{c(){e=C("div"),i.c(),g(e,"class","markdown-editor-wrapper svelte-1evr0xc")},m(o,s){P(o,e,s),i.m(e,null)},p(o,s){n===(n=t(o,s))&&i?i.p(o,s):(i.d(1),i=n(o),i&&(i.c(),i.m(e,null)))},i:J,o:J,d(o){o&&O(e),i.d()}}}var Zi=!1;function Qi(r,e){let t=Or(r),n=Or(e);if(t.length!==n.length)return!0;for(let i=0;i<t.length;i++)if(t[i].text!==n[i].text||t[i].level!==n[i].level)return!0;return!1}function Or(r){let e=[],t=r.split(`
`),n=!1;return t.forEach(i=>{let o=i.trim();if(o.startsWith("```")){n=!n;return}if(!n){let s=o.match(/^(#{1,6})\s+(.+)$/);s&&e.push({text:s[2].trim(),level:s[1].length})}}),e}function $i(r,e){let t=r.split(/\r?\n/),n=!1;for(let i=e;i<t.length;i++){let o=t[i];if(/^\s*```/.test(o)){n=!n;continue}if(!n&&o.trim().match(/^(#{1,6})\s+/))return i+1}return t.length+1}function Rr(r){let e="none",t="normal",n=r;return r.startsWith("left:")?(e="left",n=r.substring(5).trim()):r.startsWith("right:")?(e="right",n=r.substring(6).trim()):r.startsWith("center:")?(e="center",n=r.substring(7).trim()):r.startsWith("full:")&&(e="full",n=r.substring(5).trim()),n.startsWith("circle:")?(t="circle",n=n.substring(7).trim()):n.startsWith("round:")&&(t="round",n=n.substring(6).trim()),r.startsWith("circle:")&&(t="circle",n=r.substring(7).trim(),n.startsWith("left:")?(e="left",n=n.substring(5).trim()):n.startsWith("right:")?(e="right",n=n.substring(6).trim()):n.startsWith("center:")&&(e="center",n=n.substring(7).trim())),{layout:e,shape:t,cleanText:n}}function eo(r){if(!r)return!1;let e=r.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&e.right<=(window.innerWidth||document.documentElement.clientWidth)}function to(r,e,t){let n,{node:i}=e,{View:o}=e,{searchKeyword:s}=e,{searchIndex:a}=e,{allHighlights:l}=e,{isLevelOne:c=!1}=e,{triggerEdit:d=!1}=e,{isSelected:u=!1}=e,h=Kt(),f,p,w=!1,b="",m=!1,E,M,y,I=null,L=`editor_${i.startLine}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,T="",q=0,N=[],K=String(i.startLine),Z=i.id||"unknown";function ne(){w?fe():we()}function de(){return i&&(i.content||p)||""}function we(){w||m||(m=!0,I&&ie(),t(1,w=!0),b=de(),ct.requestEdit(L),queueMicrotask(()=>{Y(),m=!1}))}function Y(){if(!y){console.error("Editor container not available"),t(1,w=!1),m=!1,ct.exitEdit(L);return}I&&ie(),!b&&p&&(b=p),b||(b="");try{t(3,y.innerHTML="",y),I=new Ht(o.app,y,{value:b,placeholder:"\u5728\u6B64\u7F16\u8F91 Markdown \u5185\u5BB9...",cls:"in-place-markdown-editor",onChange:v=>{b=v},onEnter:(v,S,V)=>S?($(),!0):!1,onEscape:v=>{Le()},onSubmit:v=>{$()},onSave:v=>{$()},onBlur:v=>{}}),queueMicrotask(()=>{I==null||I.focus()})}catch(v){console.error("\u521B\u5EFA\u5C31\u5730\u7F16\u8F91\u5668\u5931\u8D25:",v),ae()}}function ae(){if(!o.file){t(1,w=!1),m=!1,ct.exitEdit(L);return}t(1,w=!1),m=!1,ct.exitEdit(L),ze.getInstance(o.app).openFallbackEditor(o.file,i,o.leaf)}function ie(){if(I){try{I.destroy()}catch(v){console.error("Error destroying editor:",v)}I=null}y&&t(3,y.innerHTML="",y),f&&f.removeEventListener("click",X)}function le(v){return{header:i.header,content:v,level:i.level}}function $(){if(m)return;I&&(b=I.value);let{header:v,content:S,level:V}=le(b);t(1,w=!1),m=!1,ct.exitEdit(L),ie();let z=p!==S,Q=p;t(14,p=S),t(7,i.content=S,i),z&&o.file&&oe(),Ze().then(()=>{te(!1)})}function Le(){m||(t(1,w=!1),m=!1,ct.exitEdit(L),b=p,ie(),Ze().then(()=>{te(!1)}))}function fe(){w&&Le()}async function oe(){var v;try{if(!o.file||!o.app)return;let S=((v=o.editor)===null||v===void 0?void 0:v.getValue())||"";o.markInternalModification&&o.markInternalModification(o.file.path);let V=me();await o.app.vault.modify(o.file,V),S&&V&&S!==V&&Qi(S,V)&&o.recalculateFoldStates&&o.recalculateFoldStates(S,V),h("contentUpdated",{node:i,newContent:b,fullMarkdown:V,skipGlobalRefresh:!0})}catch(S){console.error("\u4FDD\u5B58\u6587\u4EF6\u65F6\u51FA\u9519:",S),new o.app.Notice("\u4FDD\u5B58\u5931\u8D25: "+S.message)}}function me(){var v,S;try{let V=((v=o.editor)===null||v===void 0?void 0:v.getValue())||"",z=V.split(`
`),{header:Q,content:G,level:xe}=le(b),se=i.startLine-1,ve=$i(V,i.startLine)-2,U=[...z],ee=`${"#".repeat(xe)} ${Q}`;U[se]=ee;let pe=se+1,he=ve,Ve=G?G.split(`
`):[],Xe=Math.max(0,he-pe+1);return U.splice(pe,Xe,...Ve),U.join(`
`)}catch(V){return console.error("\u91CD\u5EFAmarkdown\u6587\u6863\u65F6\u51FA\u9519:",V),((S=o.editor)===null||S===void 0?void 0:S.getValue())||""}}function Ge(){f&&!w&&(f.removeEventListener("click",X),f.addEventListener("click",X))}function De(){if(f)try{f.querySelectorAll("p").forEach(S=>{var V;let z=S.querySelectorAll("img"),Q=S.querySelectorAll("video"),G=S.querySelectorAll(".internal-embed"),xe=((V=S.textContent)===null||V===void 0?void 0:V.trim())||"";if(z.length===1){let se=z[0],_e=se.alt||"",{layout:ve,shape:U,cleanText:ee}=Rr(_e);ee!==_e&&(se.alt=ee),ve!=="none"&&(se.classList.add(`layout-${ve}`),S.classList.add(`image-${ve}-paragraph`)),U!=="normal"&&(se.classList.add(`shape-${U}`),S.classList.add(`image-${U}-paragraph`))}if(Q.length===1){let se=Q[0]}if(G.length===1){let se=G[0],_e=se.querySelector("video"),ve=se.querySelector("img");if(_e||ve){let U="",ee=S.textContent||"";if(ee.match(/!\[\[(.*?)\]\]/)){let je=ee.substring(0,ee.indexOf("![[")),vt=ee.substring(ee.indexOf("]]")+2),nn=(je+" "+vt).match(/(left|right|center|full|circle|round):\s*/);nn&&(U=nn[1]+":")}let{layout:he,shape:Ve,cleanText:Xe}=Rr(U);he!=="none"&&(se.classList.add(`layout-${he}`),S.classList.add(`embed-${he}-paragraph`)),Ve!=="normal"&&(se.classList.add(`shape-${Ve}`),_e&&_e.classList.add(`shape-${Ve}`),ve&&ve.classList.add(`shape-${Ve}`))}}})}catch(v){console.warn("\u5904\u7406\u56FE\u7247\u5E03\u5C40\u65F6\u51FA\u9519:",v)}}async function te(v=!1){if(!(!f||!o||w)){N.length>0&&l&&l.update&&l.update(S=>S.filter(V=>!N.includes(V)));try{t(2,f.innerHTML="",f);let S=o.file,V=o.app;if(!S||!V){t(2,f.innerHTML=`<div class="fallback-content">${p}</div>`,f),await Ze(),Ge();return}let z=V.vault.adapter.getResourcePath(S.path),Q=o.addChild(new hn.Component);await hn.MarkdownRenderer.render(V,p,f,z,Q),await Ze(),A(v),Ge(),De(),N=[],T&&(it(f,T),N.forEach(G=>{G.setAttribute("data-node-line",K),G.setAttribute("data-is-header","false"),G.setAttribute("data-source","MarkdownEditor"),G.setAttribute("data-node-id",Z)}),l&&l.update&&l.update(G=>{let xe=[...G];for(let se of N){let _e=parseInt(se.getAttribute("data-node-line")||"0"),ve=se.getAttribute("data-is-header")==="true",U=0,ee=xe.length;for(;U<ee;){let pe=Math.floor((U+ee)/2),he=parseInt(xe[pe].getAttribute("data-node-line")||"0"),Ve=xe[pe].getAttribute("data-is-header")==="true";_e<he||_e===he&&ve&&!Ve?ee=pe:U=pe+1}xe.splice(U,0,se)}return xe}))}catch(S){console.error("\u6E32\u67D3Markdown\u65F6\u51FA\u9519:",S);try{t(2,f.innerHTML="",f);let V=f.createDiv("fallback-content");V.innerHTML=p.replace(/\n/g,"<br>"),await Ze()}catch(V){console.error("\u964D\u7EA7\u6E32\u67D3\u4E5F\u5931\u8D25:",V),t(2,f.textContent=p,f)}Ge()}}}function it(v,S){if(!v||!S)return;let V=S.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),z=new RegExp(V,"gi"),Q=document.createTreeWalker(v,NodeFilter.SHOW_TEXT,null),G=[],xe;for(;xe=Q.nextNode();){let se=xe.textContent||"";z.test(se)&&G.push(xe)}G.forEach(se=>{let _e=se.textContent||"",ve=se.parentNode;if(!ve)return;let U=document.createDocumentFragment(),ee=0,pe;for(z.lastIndex=0;(pe=z.exec(_e))!==null;){pe.index>ee&&U.appendChild(document.createTextNode(_e.slice(ee,pe.index)));let he=document.createElement("span");he.className="search-highlight",he.textContent=pe[0],N.push(he),U.appendChild(he),ee=z.lastIndex,pe[0].length===0&&z.lastIndex++}ee<_e.length&&U.appendChild(document.createTextNode(_e.slice(ee))),ve.replaceChild(U,se)})}async function A(v=!1){await Ze();let V=(l?Bt(l):N).filter(z=>z.isConnected&&z.offsetParent!==null);if(V.length>0){V.forEach((Q,G)=>{Q.className=G===(v?0:q)?"search-current":"search-highlight"});let z=null;v?z=V[0]:V.length>0&&q<V.length&&(z=V[q]),z&&!eo(z)&&z.scrollIntoView({behavior:"smooth",block:"center"})}}Pe(()=>{t(15,E=o.ProStatus),M=!0,te();let v=ct.subscribe(S=>{w&&S.activeEditorId!==L&&(t(1,w=!1),Ze().then(()=>{te(!1)}))});return()=>{f&&f.removeEventListener("click",X),v()}}),Ke(()=>{ie(),w&&ct.exitEdit(L),N.length>0&&l&&l.update&&l.update(v=>v.filter(S=>!N.includes(S)))});function X(v){if(w)return;let S=v.target;S.tagName==="A"||S.closest("a")?o.handleClickLink(v,i.startLine):u&&(v.preventDefault(),v.stopPropagation(),E?ne():k())}function ye(v,S){new fn(o.app,v,S).open()}function F(){try{let v=o.file;if(!v)return!1;let V=ze.getInstance(o.app).getFallbackEditor(v.path);if(V){let z=V.leaf;return z&&z.view&&!z.isDetached&&z.getViewState().type===Ye}return!1}catch(v){return console.error("Error checking right editor existence:",v),!1}}function k(){try{let v=o.file;if(!v)return;ze.getInstance(o.app).openFallbackEditor(v,i,o.leaf)}catch(v){console.error("Error opening right editor:",v)}}function H(v){re[v?"unshift":"push"](()=>{y=v,t(3,y)})}function x(v){re[v?"unshift":"push"](()=>{f=v,t(2,f)})}return r.$$set=v=>{"node"in v&&t(7,i=v.node),"View"in v&&t(8,o=v.View),"searchKeyword"in v&&t(9,s=v.searchKeyword),"searchIndex"in v&&t(10,a=v.searchIndex),"allHighlights"in v&&t(11,l=v.allHighlights),"isLevelOne"in v&&t(0,c=v.isLevelOne),"triggerEdit"in v&&t(12,d=v.triggerEdit),"isSelected"in v&&t(13,u=v.isSelected)},r.$$.update=()=>{if(r.$$.dirty[0]&33024){e:if(o&&E!==void 0){let v=o.ProStatus;v!==E&&t(15,E=v)}}if(r.$$.dirty[0]&36866){e:d&&!w&&(E?we():ae())}if(r.$$.dirty[0]&16514){e:i&&(t(14,p=i.content),w||(b=p,te(!1)))}if(r.$$.dirty[0]&2){e:t(16,n=!w)}if(r.$$.dirty[0]&66048){e:s.subscribe(v=>{T=v,n&&te(!0)})}if(r.$$.dirty[0]&66560){e:a.subscribe(v=>{q=v,n&&A(!1)})}},[c,w,f,y,$,Le,ye,i,o,s,a,l,d,u,p,E,n,H,x]}var Gn=class extends ge{constructor(e){super(),Me(this,e,to,Xi,be,{node:7,View:8,searchKeyword:9,searchIndex:10,allHighlights:11,isLevelOne:0,triggerEdit:12,isSelected:13},Ui,[-1,-1])}},jn=Gn;var Kn=require("obsidian");function zr(r,e,t){r.empty();let n=new Kn.ExtraButtonComponent(r).setIcon(e?`heading-${e}`:"heading").setDisabled(!0).onClick(()=>{});return n.extraSettingsEl.addEventListener("pointerdown",i=>{}),()=>{n.extraSettingsEl.addEventListener("pointerdown",i=>{})}}var We=require("obsidian");var pn=require("obsidian");function no(r,e,t=1){let n=new pn.Menu;n.addItem(o=>o.setTitle("\u590D\u5236\u6574\u4E2A\u6587\u6863").setIcon("copy-plus").onClick(()=>{e("\u590D\u5236\u6574\u4E2A\u6587\u6863")})),n.addSeparator(),n.addItem(o=>o.setTitle("\u590D\u5236\u6B64\u8282\u70B9\uFF08\u7EAF\u6587\u672C\uFF09").setIcon("copy-minus").onClick(()=>{e("\u590D\u5236\u6B64\u8282\u70B9\uFF08\u7EAF\u6587\u672C\uFF09")})),n.addItem(o=>o.setTitle("\u590D\u5236\u8282\u70B9\u53CA\u5B50\u8282\u70B9\uFF08\u7EAF\u6587\u672C\uFF09").setIcon("copy").onClick(()=>{e("\u590D\u5236\u8282\u70B9\u53CA\u5B50\u8282\u70B9\uFF08\u7EAF\u6587\u672C\uFF09")})),n.addSeparator(),n.addItem(o=>o.setTitle("\u590D\u5236\u6B64\u8282\u70B9\uFF08\u5BCC\u6587\u672C\uFF09").setIcon("file-text").onClick(()=>{e("\u590D\u5236\u6B64\u8282\u70B9\uFF08\u5BCC\u6587\u672C\uFF09")})),n.addItem(o=>o.setTitle("\u590D\u5236\u8282\u70B9\u53CA\u5B50\u8282\u70B9\uFF08\u5BCC\u6587\u672C\uFF09").setIcon("files").onClick(()=>{e("\u590D\u5236\u8282\u70B9\u53CA\u5B50\u8282\u70B9\uFF08\u5BCC\u6587\u672C\uFF09")})),n.addSeparator(),n.addItem(o=>o.setTitle("\u5206\u4EAB\u4E3A\u56FE\u7247").setIcon("image").onClick(()=>{e("\u5206\u4EAB\u4E3A\u56FE\u7247")}));let i=r.getBoundingClientRect();n.showAtPosition({x:i.right,y:i.bottom})}function Pr(r,e,t=1){let n=new pn.ExtraButtonComponent(r).setIcon("copy").setTooltip("\u590D\u5236").onClick(()=>{no(n.extraSettingsEl,e,t)});return()=>{n.extraSettingsEl.remove()}}function Br(r){let e=r.getBoundingClientRect();return e.top>=150&&e.left>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)-150&&e.right<=(window.innerWidth||document.documentElement.clientWidth)}var gn=require("obsidian");var Un=class extends gn.Modal{constructor(t,n){super(t);this.editor=null;this.options=n,this.currentValue=n.value,this.fileChangeHandler=()=>{this.close()}}onOpen(){let{contentEl:t}=this;this.modalEl.addClass("grid-note-editor-modal"),this.setupModalPosition(),this.options.title&&this.titleEl.setText(this.options.title),t.style.display="flex",t.style.flexDirection="column",t.style.height="100%",this.editorContainer=t.createDiv({cls:"grid-note-modal-editor-container"}),this.createEditor();let n=t.createDiv({cls:"grid-note-modal-button-area"});new gn.Setting(n).addButton(i=>i.setButtonText("\u53D6\u6D88").onClick(()=>{this.handleCancel()})).addButton(i=>i.setButtonText("\u4FDD\u5B58").setCta().onClick(()=>{this.handleSave()})),this.app.workspace.on("active-leaf-change",this.fileChangeHandler)}setupModalPosition(){this.modalEl.style.width="90vw",this.modalEl.style.maxWidth="1200px",this.modalEl.style.minWidth="800px",this.modalEl.style.height="85vh",this.modalEl.style.maxHeight="900px",this.modalEl.style.minHeight="500px"}createEditor(){this.editorContainer&&(this.editor=new Ht(this.app,this.editorContainer,{value:this.currentValue,placeholder:this.options.placeholder||"\u5728\u6B64\u7F16\u8F91 Markdown \u5185\u5BB9...",cls:"grid-note-modal-editor",onChange:t=>{this.currentValue=t},onEnter:(t,n,i)=>n?(this.handleSave(),!0):!1,onEscape:t=>{this.handleCancel()},onSubmit:t=>{this.handleSave()}}),setTimeout(()=>{var t;(t=this.editor)==null||t.focus()},100))}handleSave(){this.editor&&(this.currentValue=this.editor.value),this.options.onSave&&this.options.onSave(this.currentValue),this.close()}handleCancel(){this.options.onCancel&&this.options.onCancel(),this.close()}onClose(){let{contentEl:t}=this;this.app.workspace.off("active-leaf-change",this.fileChangeHandler),this.editor&&(this.editor.destroy(),this.editor=null),t.empty(),this.options.onClose&&this.options.onClose(),nt.getInstance(this.app).onModalClosed(this)}},nt=class{constructor(e){this.currentModal=null;this.isOpening=!1;this.lastOpenTime=0;this.app=e}static getInstance(e){return nt.instance||(nt.instance=new nt(e)),nt.instance}openEditor(e){let t=Date.now();t-this.lastOpenTime<100||this.isOpening||this.currentModal||(this.isOpening=!0,this.lastOpenTime=t,this.currentModal=new Un(this.app,e),this.currentModal.open(),setTimeout(()=>{this.isOpening=!1},100))}closeEditor(){this.currentModal&&(this.currentModal.close(),this.currentModal=null),this.isOpening=!1}onModalClosed(e){this.currentModal===e&&(this.currentModal=null,this.isOpening=!1,this.lastOpenTime=0)}isOpen(){return this.currentModal!==null||this.isOpening}};var vn=require("obsidian");var mn=require("obsidian");function ro(r){ke(r,"svelte-xe5p74",'@charset "UTF-8";.screenshot-node.svelte-xe5p74.svelte-xe5p74{height:fit-content;overflow:visible;contain:layout style;padding-bottom:16px;font-size:13px;line-height:1.4;max-width:100%;min-width:0;position:relative;clear:both}.screenshot-header.svelte-xe5p74.svelte-xe5p74{font-weight:700;border-bottom:2px solid var(--background-modifier-border);color:var(--color-orange);position:relative;margin-top:6px;font-size:16px}.screenshot-header.level-1.svelte-xe5p74.svelte-xe5p74{color:var(--interactive-accent);border-image:linear-gradient(90deg, transparent, var(--interactive-accent), transparent) 1}.screenshot-layout.svelte-xe5p74.svelte-xe5p74{display:grid;gap:20px;width:100%;align-items:start;min-height:0;height:fit-content;max-width:100%;overflow:visible}.screenshot-left.svelte-xe5p74.svelte-xe5p74{min-width:0;padding-right:6px;overflow:hidden;max-width:100%}.screenshot-right.svelte-xe5p74.svelte-xe5p74{min-width:0;display:flex;flex-direction:column;gap:12px;overflow:hidden;max-width:100%}.screenshot-children-vertical.svelte-xe5p74.svelte-xe5p74{margin-top:24px;display:flex;flex-direction:column;gap:20px;max-width:100%;overflow:hidden}.screenshot-final-children.svelte-xe5p74.svelte-xe5p74{margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;max-width:100%}.screenshot-final-item.svelte-xe5p74.svelte-xe5p74{background:var(--background-secondary);border-radius:6px;padding:8px 12px;border:1px solid var(--background-modifier-border)}.screenshot-final-item.svelte-xe5p74 .screenshot-header.svelte-xe5p74{font-size:13px;color:var(--text-muted);border-bottom:none;margin-bottom:0;padding:0;font-weight:500}.screenshot-content.svelte-xe5p74.svelte-xe5p74{word-break:break-word;height:auto;max-height:none;position:relative;z-index:1;font-size:12px;line-height:1.5}.screenshot-content.svelte-xe5p74 p{margin:0}.screenshot-content.svelte-xe5p74 p:first-child{margin-top:0}.screenshot-content.svelte-xe5p74 p:last-child{margin-bottom:0}.screenshot-content.svelte-xe5p74 ul,.screenshot-content.svelte-xe5p74 ol{margin:0}.screenshot-content.svelte-xe5p74 code{background:var(--code-background);padding:2px 6px;border-radius:4px;font-size:0.9em}.screenshot-content.svelte-xe5p74 pre{background:var(--code-background);padding:8px;border-radius:4px;overflow-x:auto;margin:0.8em 0;font-size:11px;line-height:1.4}.screenshot-content.svelte-xe5p74 .math{margin:0.5em 0;font-size:large}.screenshot-content.svelte-xe5p74 .inline-title,.screenshot-content.svelte-xe5p74 .metadata-container{display:none !important}.screenshot-content.svelte-xe5p74 img{max-width:420px;min-width:200px;height:auto;border-radius:8px;box-shadow:0 2px 8px rgba(0, 0, 0, 0.1);margin:16px 0}.screenshot-content.svelte-xe5p74 video{max-width:420px;min-width:200px;border-radius:8px;box-shadow:0 2px 8px rgba(0, 0, 0, 0.1)}.screenshot-content.svelte-xe5p74 .layout-left{display:block;margin:16px auto 16px 0}.screenshot-content.svelte-xe5p74 .layout-right{display:block;margin:16px 0 16px auto}.screenshot-content.svelte-xe5p74 .layout-center{display:block;margin:16px auto}.screenshot-content.svelte-xe5p74 .layout-full{display:block;width:100% !important;max-width:100% !important;margin:16px 0}.screenshot-content.svelte-xe5p74 .shape-circle{border-radius:50% !important;width:200px !important;height:200px !important;object-fit:cover}.screenshot-content.svelte-xe5p74 .shape-round{border-radius:20px !important}.screenshot-content.svelte-xe5p74 .copy-code-button{display:none}.screenshot-content.svelte-xe5p74 table{border-collapse:collapse;margin:16px 0;width:100%}.screenshot-content.svelte-xe5p74 table th,.screenshot-content.svelte-xe5p74 table td{border:1px solid var(--table-border-color, var(--background-modifier-border));padding:8px 12px;text-align:left}.screenshot-content.svelte-xe5p74 table th{background-color:var(--table-header-background, var(--background-secondary));font-weight:600}.screenshot-content-placeholder.svelte-xe5p74.svelte-xe5p74{min-height:20px}.theme-dark .screenshot-header.svelte-xe5p74.svelte-xe5p74{color:var(--color-orange)}.theme-light .screenshot-header.svelte-xe5p74.svelte-xe5p74{color:var(--color-blue)}')}function Wr(r,e,t){let n=r.slice();return n[17]=e[t],n}function qr(r,e,t){let n=r.slice();return n[17]=e[t],n}function Gr(r,e,t){let n=r.slice();return n[17]=e[t],n}function io(r){var u;let e=(u=r[0].content)==null?void 0:u.trim(),t,n,i,o,s,a=e&&jr(r),l=[ao,so],c=[];function d(h,f){return h[0].level===1&&h[9]?0:h[9]&&h[1]===h[3]-1?1:-1}return~(n=d(r,-1))&&(i=c[n]=l[n](r)),{c(){a&&a.c(),t=R(),i&&i.c(),o=ut()},m(h,f){a&&a.m(h,f),P(h,t,f),~n&&c[n].m(h,f),P(h,o,f),s=!0},p(h,f){var w;f&1&&(e=(w=h[0].content)==null?void 0:w.trim()),e?a?a.p(h,f):(a=jr(h),a.c(),a.m(t.parentNode,t)):a&&(a.d(1),a=null);let p=n;n=d(h,f),n===p?~n&&c[n].p(h,f):(i&&(Ie(),W(c[p],1,1,()=>{c[p]=null}),Te()),~n?(i=c[n],i?i.p(h,f):(i=c[n]=l[n](h),i.c()),D(i,1),i.m(o.parentNode,o)):i=null)},i(h){s||(D(i),s=!0)},o(h){W(i),s=!1},d(h){h&&(O(t),O(o)),a&&a.d(h),~n&&c[n].d(h)}}}function oo(r){let e,t,n,i,o;function s(d,u){var h;return u&1&&(n=null),n==null&&(n=!!((h=d[0].content)!=null&&h.trim())),n?co:lo}let a=s(r,-1),l=a(r),c=r[6]>0&&r[4]>0&&Yr(r);return{c(){e=C("div"),t=C("div"),l.c(),i=R(),c&&c.c(),g(t,"class","screenshot-left svelte-xe5p74"),g(e,"class","screenshot-layout svelte-xe5p74"),ue(e,"grid-template-columns",r[7])},m(d,u){P(d,e,u),_(e,t),l.m(t,null),_(e,i),c&&c.m(e,null),o=!0},p(d,u){a===(a=s(d,u))&&l?l.p(d,u):(l.d(1),l=a(d),l&&(l.c(),l.m(t,null))),d[6]>0&&d[4]>0?c?(c.p(d,u),u&80&&D(c,1)):(c=Yr(d),c.c(),D(c,1),c.m(e,null)):c&&(Ie(),W(c,1,1,()=>{c=null}),Te()),(!o||u&128)&&ue(e,"grid-template-columns",d[7])},i(d){o||(D(c),o=!0)},o(d){W(c),o=!1},d(d){d&&O(e),l.d(),c&&c.d()}}}function jr(r){let e;return{c(){e=C("div"),g(e,"class","screenshot-content svelte-xe5p74"),ue(e,"transform","scale("+r[8]+")"),ue(e,"transform-origin","top left")},m(t,n){P(t,e,n),r[14](e)},p(t,n){n&256&&ue(e,"transform","scale("+t[8]+")")},d(t){t&&O(e),r[14](null)}}}function so(r){let e,t=Re(r[0].children),n=[];for(let i=0;i<t.length;i+=1)n[i]=Kr(Wr(r,t,i));return{c(){e=C("div");for(let i=0;i<n.length;i+=1)n[i].c();g(e,"class","screenshot-final-children svelte-xe5p74")},m(i,o){P(i,e,o);for(let s=0;s<n.length;s+=1)n[s]&&n[s].m(e,null)},p(i,o){if(o&3){t=Re(i[0].children);let s;for(s=0;s<t.length;s+=1){let a=Wr(i,t,s);n[s]?n[s].p(a,o):(n[s]=Kr(a),n[s].c(),n[s].m(e,null))}for(;s<n.length;s+=1)n[s].d(1);n.length=t.length}},i:J,o:J,d(i){i&&O(e),wt(n,i)}}}function ao(r){let e,t,n=Re(r[0].children),i=[];for(let s=0;s<n.length;s+=1)i[s]=Ur(qr(r,n,s));let o=s=>W(i[s],1,1,()=>{i[s]=null});return{c(){e=C("div");for(let s=0;s<i.length;s+=1)i[s].c();g(e,"class","screenshot-children-vertical svelte-xe5p74")},m(s,a){P(s,e,a);for(let l=0;l<i.length;l+=1)i[l]&&i[l].m(e,null);t=!0},p(s,a){if(a&15){n=Re(s[0].children);let l;for(l=0;l<n.length;l+=1){let c=qr(s,n,l);i[l]?(i[l].p(c,a),D(i[l],1)):(i[l]=Ur(c),i[l].c(),D(i[l],1),i[l].m(e,null))}for(Ie(),l=n.length;l<i.length;l+=1)o(l);Te()}},i(s){if(!t){for(let a=0;a<n.length;a+=1)D(i[a]);t=!0}},o(s){i=i.filter(Boolean);for(let a=0;a<i.length;a+=1)W(i[a]);t=!1},d(s){s&&O(e),wt(i,s)}}}function Kr(r){let e,t,n=r[17].header+"",i,o,s;return{c(){e=C("div"),t=C("div"),i=Ee(n),s=R(),g(t,"class",o="screenshot-header level-"+(r[1]+2)+" svelte-xe5p74"),g(e,"class","screenshot-final-item svelte-xe5p74")},m(a,l){P(a,e,l),_(e,t),_(t,i),_(e,s)},p(a,l){l&1&&n!==(n=a[17].header+"")&&Je(i,n),l&2&&o!==(o="screenshot-header level-"+(a[1]+2)+" svelte-xe5p74")&&g(t,"class",o)},d(a){a&&O(e)}}}function Ur(r){let e,t;return e=new Jt({props:{node:r[17],level:r[1]+1,app:r[2],maxDepth:r[3]}}),{c(){Ae(e.$$.fragment)},m(n,i){Ce(e,n,i),t=!0},p(n,i){let o={};i&1&&(o.node=n[17]),i&2&&(o.level=n[1]+1),i&4&&(o.app=n[2]),i&8&&(o.maxDepth=n[3]),e.$set(o)},i(n){t||(D(e.$$.fragment,n),t=!0)},o(n){W(e.$$.fragment,n),t=!1},d(n){Se(e,n)}}}function lo(r){let e;return{c(){e=C("div"),g(e,"class","screenshot-content-placeholder svelte-xe5p74")},m(t,n){P(t,e,n)},p:J,d(t){t&&O(e)}}}function co(r){let e;return{c(){e=C("div"),g(e,"class","screenshot-content svelte-xe5p74"),ue(e,"transform","scale("+r[8]+")"),ue(e,"transform-origin","top left")},m(t,n){P(t,e,n),r[13](e)},p(t,n){n&256&&ue(e,"transform","scale("+t[8]+")")},d(t){t&&O(e),r[13](null)}}}function Yr(r){let e,t,n=Re(r[0].children),i=[];for(let s=0;s<n.length;s+=1)i[s]=Jr(Gr(r,n,s));let o=s=>W(i[s],1,1,()=>{i[s]=null});return{c(){e=C("div");for(let s=0;s<i.length;s+=1)i[s].c();g(e,"class","screenshot-right svelte-xe5p74")},m(s,a){P(s,e,a);for(let l=0;l<i.length;l+=1)i[l]&&i[l].m(e,null);t=!0},p(s,a){if(a&15){n=Re(s[0].children);let l;for(l=0;l<n.length;l+=1){let c=Gr(s,n,l);i[l]?(i[l].p(c,a),D(i[l],1)):(i[l]=Jr(c),i[l].c(),D(i[l],1),i[l].m(e,null))}for(Ie(),l=n.length;l<i.length;l+=1)o(l);Te()}},i(s){if(!t){for(let a=0;a<n.length;a+=1)D(i[a]);t=!0}},o(s){i=i.filter(Boolean);for(let a=0;a<i.length;a+=1)W(i[a]);t=!1},d(s){s&&O(e),wt(i,s)}}}function Jr(r){let e,t;return e=new Jt({props:{node:r[17],level:r[1]+1,app:r[2],maxDepth:r[3]}}),{c(){Ae(e.$$.fragment)},m(n,i){Ce(e,n,i),t=!0},p(n,i){let o={};i&1&&(o.node=n[17]),i&2&&(o.level=n[1]+1),i&4&&(o.app=n[2]),i&8&&(o.maxDepth=n[3]),e.$set(o)},i(n){t||(D(e.$$.fragment,n),t=!0)},o(n){W(e.$$.fragment,n),t=!1},d(n){Se(e,n)}}}function uo(r){let e,t,n=r[0].header+"",i,o,s,a,l,c,d=[oo,io],u=[];function h(f,p){return f[10]?0:1}return a=h(r,-1),l=u[a]=d[a](r),{c(){e=C("div"),t=C("div"),i=Ee(n),s=R(),l.c(),g(t,"class",o="screenshot-header level-"+(r[1]+1)+" svelte-xe5p74"),g(e,"class","screenshot-node svelte-xe5p74")},m(f,p){P(f,e,p),_(e,t),_(t,i),_(e,s),u[a].m(e,null),c=!0},p(f,[p]){(!c||p&1)&&n!==(n=f[0].header+"")&&Je(i,n),(!c||p&2&&o!==(o="screenshot-header level-"+(f[1]+1)+" svelte-xe5p74"))&&g(t,"class",o),l.p(f,p)},i(f){c||(D(l),c=!0)},o(f){W(l),c=!1},d(f){f&&O(e),u[a].d()}}}function fo(r,e,t){let n,{node:i}=e,{level:o=0}=e,{app:s}=e,{maxDepth:a=3}=e,l=1,c=0,d="1fr",u,h=1,f=null;async function p(){var y;!u||!(!((y=i.content)===null||y===void 0)&&y.trim())||(f&&f.unload(),f=new mn.Component,await mn.MarkdownRenderer.render(s,i.content,u,"",f),u.querySelectorAll(".internal-link").forEach(I=>{let L=I.textContent||"";I.replaceWith(document.createTextNode(L))}),requestAnimationFrame(()=>{if(u){let I=u.scrollWidth,L=u.offsetWidth;I>L?t(8,h=L/I):t(8,h=1)}}))}let w=!1,b=i.children&&i.children.length>0,m=b&&o<a-1&&i.level!==1;Ke(()=>{f&&(f.unload(),f=null)});function E(y){re[y?"unshift":"push"](()=>{u=y,t(5,u)})}function M(y){re[y?"unshift":"push"](()=>{u=y,t(5,u)})}return r.$$set=y=>{"node"in y&&t(0,i=y.node),"level"in y&&t(1,o=y.level),"app"in y&&t(2,s=y.app),"maxDepth"in y&&t(3,a=y.maxDepth)},r.$$.update=()=>{if(r.$$.dirty&1){e:t(6,n=i.children&&i.children.length>0?i.children.length:0)}if(r.$$.dirty&2138){e:{let y=Math.max(0,a-o-1);n===0||y<=0?(t(11,l=1),t(4,c=0),t(7,d="1fr")):(t(11,l=1),t(4,c=y),t(7,d=`${l}fr ${c}fr`))}}if(r.$$.dirty&4129){e:u&&i.content&&!w&&(t(12,w=!0),p())}},[i,o,s,a,c,u,n,d,h,b,m,l,w,E,M]}var Jt=class extends ge{constructor(e){super(),Me(this,e,fo,uo,be,{node:0,level:1,app:2,maxDepth:3},ro)}},Xr=Jt;function ho(r){ke(r,"svelte-hz6y90",'@charset "UTF-8";.screenshot-modal-overlay.svelte-hz6y90.svelte-hz6y90{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0, 0, 0, 0.7);display:flex;align-items:center;justify-content:center;z-index:10000}.screenshot-modal.svelte-hz6y90.svelte-hz6y90{background:var(--background-primary);border-radius:12px;max-width:1500px;max-height:90vh;display:flex;flex-direction:column;box-shadow:0 8px 32px rgba(0, 0, 0, 0.3)}.screenshot-modal-header.svelte-hz6y90.svelte-hz6y90{padding:16px 24px;border-bottom:1px solid var(--background-modifier-border);display:flex;justify-content:space-between;align-items:center;gap:20px}.screenshot-modal-header.svelte-hz6y90 h3.svelte-hz6y90{margin:0;font-size:18px;flex-shrink:0}.screenshot-header-right.svelte-hz6y90.svelte-hz6y90{display:flex;align-items:center;gap:20px}.screenshot-controls.svelte-hz6y90.svelte-hz6y90{display:flex;gap:20px;align-items:center}.control-group.svelte-hz6y90.svelte-hz6y90{display:flex;flex-direction:column;gap:4px;min-width:120px}.control-group.svelte-hz6y90 label.svelte-hz6y90{font-size:12px;font-weight:500;color:var(--text-muted);white-space:nowrap}.slider.svelte-hz6y90.svelte-hz6y90{-webkit-appearance:none;appearance:none;height:4px;border-radius:2px;background:var(--background-modifier-border);outline:none;transition:background 0.2s;width:100px;user-select:none;-webkit-user-select:none}.slider.svelte-hz6y90.svelte-hz6y90::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:14px;height:14px;border-radius:50%;background:var(--interactive-accent);cursor:pointer;transition:all 0.2s}.slider.svelte-hz6y90.svelte-hz6y90::-webkit-slider-thumb:hover{background:var(--interactive-accent-hover);transform:scale(1.1)}.slider.svelte-hz6y90.svelte-hz6y90::-moz-range-thumb{width:14px;height:14px;border-radius:50%;background:var(--interactive-accent);cursor:pointer;border:none;transition:all 0.2s}.slider.svelte-hz6y90.svelte-hz6y90::-moz-range-thumb:hover{background:var(--interactive-accent-hover);transform:scale(1.1)}.slider.svelte-hz6y90.svelte-hz6y90:hover{background:var(--background-modifier-border-hover)}.screenshot-actions.svelte-hz6y90.svelte-hz6y90{display:flex;gap:12px}.screenshot-btn.svelte-hz6y90.svelte-hz6y90{padding:8px 16px;border-radius:6px;border:none;cursor:pointer;font-size:14px;transition:all 0.2s}.screenshot-btn.capture-btn.svelte-hz6y90.svelte-hz6y90{background:var(--interactive-accent);color:var(--text-on-accent)}.screenshot-btn.capture-btn.svelte-hz6y90.svelte-hz6y90:hover:not(:disabled){background:var(--interactive-accent-hover)}.screenshot-btn.capture-btn.svelte-hz6y90.svelte-hz6y90:disabled{opacity:0.5;cursor:not-allowed}.screenshot-btn.close-btn.svelte-hz6y90.svelte-hz6y90{background:var(--background-modifier-border);color:var(--text-normal)}.screenshot-btn.close-btn.svelte-hz6y90.svelte-hz6y90:hover{background:var(--background-modifier-border-hover)}.screenshot-preview.svelte-hz6y90.svelte-hz6y90{flex:1;overflow:hidden;padding:36px;display:flex;justify-content:center;align-items:flex-start}.screenshot-container.svelte-hz6y90.svelte-hz6y90{background:linear-gradient(135deg, var(--background-primary) 0%, var(--background-secondary) 100%);padding:32px 28px 40px 28px;border-radius:16px;box-shadow:0 20px 60px rgba(0, 0, 0, 0.15);position:relative;transition:width 0.3s ease, max-height 0.3s ease;border:5px solid transparent;background-image:linear-gradient(135deg, var(--background-primary) 0%, var(--background-secondary) 100%), linear-gradient(90deg, #6366f1, #8b5cf6, #d946ef);background-origin:border-box;background-clip:padding-box, border-box;overflow:hidden}.screenshot-container.svelte-hz6y90 .screenshot-node{position:relative;z-index:0}.screenshot-container.svelte-hz6y90.svelte-hz6y90::before{content:"";position:absolute;bottom:0;left:0;right:0;height:60px;background:linear-gradient(to bottom, transparent 0%, var(--background-primary) 100%);pointer-events:none;z-index:10}.screenshot-container.svelte-hz6y90.svelte-hz6y90::after{content:"Generated by GridNote";position:absolute;bottom:16px;right:24px;font-size:11px;opacity:0.35;font-weight:500;letter-spacing:0.8px;z-index:11;background:var(--background-primary);padding:2px 6px;border-radius:4px}')}function po(r){let e,t,n,i,o,s,a,l,c,d,u,h,f,p,w,b,m,E,M,y,I,L,T,q,N,K=r[4]?"\u751F\u6210\u4E2D...":"\u590D\u5236\u56FE\u7247",Z,ne,de,we,Y,ae,ie,le,$,Le;return ie=new Xr({props:{node:r[0],level:0,app:r[2],maxDepth:r[6]}}),{c(){e=C("div"),t=C("div"),n=C("div"),i=C("h3"),i.textContent="\u9884\u89C8\u5206\u4EAB\u56FE\u7247",o=R(),s=C("div"),a=C("div"),l=C("div"),c=C("label"),d=Ee("\u5C42\u7EA7: "),u=Ee(r[8]),h=Ee("/5"),f=R(),p=C("input"),w=R(),b=C("div"),m=C("label"),E=Ee("\u6700\u5927\u9AD8\u5EA6: "),M=Ee(r[9]),y=Ee("px"),I=R(),L=C("input"),T=R(),q=C("div"),N=C("button"),Z=Ee(K),ne=R(),de=C("button"),de.textContent="\u5173\u95ED",we=R(),Y=C("div"),ae=C("div"),Ae(ie.$$.fragment),g(i,"class","svelte-hz6y90"),g(c,"for","depth-slider"),g(c,"class","svelte-hz6y90"),g(p,"id","depth-slider"),g(p,"type","range"),g(p,"min","1"),g(p,"max","5"),g(p,"class","slider svelte-hz6y90"),g(l,"class","control-group svelte-hz6y90"),g(m,"for","height-slider"),g(m,"class","svelte-hz6y90"),g(L,"id","height-slider"),g(L,"type","range"),g(L,"min","400"),g(L,"max","1200"),g(L,"step","50"),g(L,"class","slider svelte-hz6y90"),g(b,"class","control-group svelte-hz6y90"),g(a,"class","screenshot-controls svelte-hz6y90"),g(N,"class","screenshot-btn capture-btn svelte-hz6y90"),N.disabled=r[4],g(de,"class","screenshot-btn close-btn svelte-hz6y90"),g(q,"class","screenshot-actions svelte-hz6y90"),g(s,"class","screenshot-header-right svelte-hz6y90"),g(n,"class","screenshot-modal-header svelte-hz6y90"),g(ae,"class","screenshot-container svelte-hz6y90"),ue(ae,"width",r[5]),ue(ae,"max-height",r[7]+"px"),g(Y,"class","screenshot-preview svelte-hz6y90"),g(t,"class","screenshot-modal svelte-hz6y90"),g(t,"role","dialog"),g(e,"class","screenshot-modal-overlay svelte-hz6y90"),g(e,"role","button"),g(e,"tabindex","0")},m(fe,oe){P(fe,e,oe),_(e,t),_(t,n),_(n,i),_(n,o),_(n,s),_(s,a),_(a,l),_(l,c),_(c,d),_(c,u),_(c,h),_(l,f),_(l,p),ft(p,r[8]),_(a,w),_(a,b),_(b,m),_(m,E),_(m,M),_(m,y),_(b,I),_(b,L),ft(L,r[9]),_(s,T),_(s,q),_(q,N),_(N,Z),_(q,ne),_(q,de),_(t,we),_(t,Y),_(Y,ae),Ce(ie,ae,null),r[17](ae),le=!0,$||(Le=[B(p,"change",r[15]),B(p,"input",r[15]),B(p,"change",r[10]),B(L,"change",r[16]),B(L,"input",r[16]),B(L,"change",r[11]),B(N,"click",r[12]),B(de,"click",function(){Fe(r[1])&&r[1].apply(this,arguments)}),B(t,"click",yt(r[14])),B(e,"click",function(){Fe(r[1])&&r[1].apply(this,arguments)}),B(e,"keydown",r[18])],$=!0)},p(fe,[oe]){r=fe,(!le||oe&256)&&Je(u,r[8]),oe&256&&ft(p,r[8]),(!le||oe&512)&&Je(M,r[9]),oe&512&&ft(L,r[9]),(!le||oe&16)&&K!==(K=r[4]?"\u751F\u6210\u4E2D...":"\u590D\u5236\u56FE\u7247")&&Je(Z,K),(!le||oe&16)&&(N.disabled=r[4]);let me={};oe&1&&(me.node=r[0]),oe&4&&(me.app=r[2]),oe&64&&(me.maxDepth=r[6]),ie.$set(me),(!le||oe&32)&&ue(ae,"width",r[5]),(!le||oe&128)&&ue(ae,"max-height",r[7]+"px")},i(fe){le||(D(ie.$$.fragment,fe),le=!0)},o(fe){W(ie.$$.fragment,fe),le=!1},d(fe){fe&&O(e),Se(ie),r[17](null),$=!1,ce(Le)}}}function go(r){try{let i=function(o,s=1){if(s>10||n.has(o))return s;n.add(o);let a=s;return o.children&&Array.isArray(o.children)&&o.children.length>0&&o.children.forEach(l=>{if(l&&typeof l=="object"){let c=i(l,s+1);a=Math.max(a,c)}}),a};var e=i;if(!r)return 1;let t=1,n=new Set;return t=i(r),Math.min(t,5)}catch(t){return console.warn("getContentDepth error:",t),3}}function Zr(r,e=3){try{if(!r)return 800;let t=800;if(r.level===1)return t=1e3,Math.min(Math.max(t,1e3),1400);let n=200,i=Math.max(0,e-1),o=t+i*n;return e>=3&&(o+=100),Math.min(Math.max(o,t),1800)}catch(t){return console.warn("calculateWidth error:",t),800}}function mo(r,e,t){let{node:n}=e,{onClose:i}=e,{onCapture:o}=e,{app:s}=e,a,l=!1,c="900px",d=5,u=600,h=5,f=600,p=5,w=null,b=null;function m(){w&&clearTimeout(w),w=setTimeout(()=>{let N=Math.max(1,Math.min(5,Math.floor(h)));t(6,d=N),t(8,h=N);let K=Zr(n,N);t(5,c=`${K}px`),w=null},100)}function E(){b&&clearTimeout(b),b=setTimeout(()=>{let N=Math.max(400,Math.min(1200,Math.floor(f/50)*50));t(7,u=N),t(9,f=N),b=null},100)}async function M(){if(!(l||!a)){t(4,l=!0),new vn.Notice("\u6B63\u5728\u751F\u6210\u56FE\u7247..."),await new Promise(N=>setTimeout(N,100));try{let N=window.require;if(!N){await o(a);return}let{remote:K}=N("electron")||{};if(K){let Z=K.getCurrentWindow(),ne=window.devicePixelRatio||1,de=a.getBoundingClientRect(),we=20,Y=await Z.webContents.capturePage(),ae={x:Math.round((de.left-we)*ne),y:Math.round((de.top-we)*ne),width:Math.round((de.width+we*2)*ne),height:Math.round((de.height+we*2)*ne)},le=Y.crop(ae).toPNG(),$=new Blob([le],{type:"image/png"});await navigator.clipboard.write([new ClipboardItem({"image/png":$})]),new vn.Notice("\u56FE\u7247\u5DF2\u590D\u5236\u5230\u526A\u8D34\u677F"),i();return}await o(a)}catch(N){new vn.Notice("\u622A\u56FE\u5931\u8D25\uFF0C\u8BF7\u7A0D\u540E\u91CD\u8BD5")}finally{t(4,l=!1)}}}Pe(()=>{let N=go(n);p=Math.max(N,1);let K=Math.min(N,5);t(6,d=K),t(8,h=K);let Z=Zr(n,K);t(5,c=`${Z}px`)}),Ke(()=>{w&&(clearTimeout(w),w=null),b&&(clearTimeout(b),b=null)});function y(N){Sr.call(this,r,N)}function I(){h=Nn(this.value),t(8,h)}function L(){f=Nn(this.value),t(9,f)}function T(N){re[N?"unshift":"push"](()=>{a=N,t(3,a)})}let q=N=>N.key==="Escape"&&i();return r.$$set=N=>{"node"in N&&t(0,n=N.node),"onClose"in N&&t(1,i=N.onClose),"onCapture"in N&&t(13,o=N.onCapture),"app"in N&&t(2,s=N.app)},[n,i,s,a,l,c,d,u,h,f,m,E,M,o,y,I,L,T,q]}var Yn=class extends ge{constructor(e){super(),Me(this,e,mo,po,be,{node:0,onClose:1,onCapture:13,app:2},ho)}},Qr=Yn;function vo(r){ke(r,"svelte-160ftkp",'@charset "UTF-8";.container.svelte-160ftkp.svelte-160ftkp{min-height:30px;border-bottom:1.5px solid var(--background-modifier-border);display:flex;align-items:center;padding:4px 0}.container.svelte-160ftkp .title.svelte-160ftkp{flex:1;display:flex;align-items:center;width:calc(100% - 90px)}.container.svelte-160ftkp .title .header.svelte-160ftkp{vertical-align:bottom;font-size:var(--font-text-size);font-weight:700;flex:1;max-width:calc(100% - 60px);padding-left:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;letter-spacing:0.05em;cursor:pointer;transition:background-color 0.2s ease}.container.svelte-160ftkp .title .header.svelte-160ftkp:hover{background-color:var(--background-modifier-hover);border-radius:4px}.container.svelte-160ftkp .title .header.header-editing.svelte-160ftkp{background-color:var(--background-primary);border:2px solid var(--interactive-accent);border-radius:4px;outline:none;cursor:text;white-space:normal;overflow:visible;text-overflow:initial;padding:4px 8px;margin:-4px -8px}.container.svelte-160ftkp .title .header.header-editing.svelte-160ftkp:focus{border-color:var(--interactive-accent);box-shadow:0 0 0 2px rgba(var(--interactive-accent-rgb), 0.2)}.container.svelte-160ftkp .title .header.empty-header.svelte-160ftkp{color:var(--text-muted);font-style:italic;min-width:60px;min-height:20px}.container.svelte-160ftkp .title .header.empty-header.svelte-160ftkp:hover{color:var(--text-normal);background-color:var(--background-modifier-hover)}.container.svelte-160ftkp .action.svelte-160ftkp{opacity:0;margin-right:20px}.container.svelte-160ftkp .action .actions.svelte-160ftkp{display:flex;justify-content:space-between}.container.svelte-160ftkp:hover .action.svelte-160ftkp{opacity:1}.theme-dark .container.svelte-160ftkp .header.svelte-160ftkp{color:var(--color-orange)}.theme-light .container.svelte-160ftkp .header.svelte-160ftkp{color:var(--color-blue)}.selected.svelte-160ftkp.svelte-160ftkp{color:var(--color-accent);border-color:var(--color-accent)}.is-fold.svelte-160ftkp.svelte-160ftkp{opacity:0.5}.gridnote-delete-notice{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:var(--background-primary);border:1px solid var(--color-green);border-radius:8px;padding:12px 24px;color:var(--text-normal);font-size:var(--font-small);font-weight:500;box-shadow:var(--shadow-m);z-index:10000;opacity:0;transition:all 0.3s ease;pointer-events:none;max-width:300px;text-align:center}.gridnote-delete-notice.show{opacity:1;transform:translateX(-50%) translateY(-10px)}.gridnote-delete-notice::before{content:"\u2713";margin-right:8px;color:var(--color-green);font-weight:bold}')}function bo(r){let e,t,n,i;return{c(){e=C("div"),t=Ee(r[10]),g(e,"class","header svelte-160ftkp"),g(e,"role","button"),g(e,"aria-label","\u53CC\u51FB\u7F16\u8F91\u6807\u9898"),g(e,"tabindex","0"),j(e,"empty-header",!r[0].header.trim())},m(o,s){P(o,e,s),_(e,t),r[26](e),n||(i=[B(e,"dblclick",r[12]),B(e,"keydown",r[13])],n=!0)},p(o,s){s[0]&1024&&Je(t,o[10]),s[0]&1&&j(e,"empty-header",!o[0].header.trim())},d(o){o&&O(e),r[26](null),n=!1,ce(i)}}}function wo(r){let e,t=r[0].header+"",n,i,o;return{c(){e=C("div"),n=Ee(t),g(e,"class","header header-editing svelte-160ftkp"),g(e,"contenteditable","true"),g(e,"role","textbox"),g(e,"aria-label","\u7F16\u8F91\u6807\u9898"),g(e,"tabindex","0"),g(e,"spellcheck","false")},m(s,a){P(s,e,a),_(e,n),r[25](e),i||(o=[B(e,"keydown",r[14]),B(e,"blur",r[15])],i=!0)},p(s,a){a[0]&1&&t!==(t=s[0].header+"")&&Er(n,t)},d(s){s&&O(e),r[25](null),i=!1,ce(o)}}}function $r(r){let e,t;return e=new Qr({props:{node:r[0],app:r[11].app,onClose:r[16],onCapture:r[17]}}),{c(){Ae(e.$$.fragment)},m(n,i){Ce(e,n,i),t=!0},p(n,i){let o={};i[0]&1&&(o.node=n[0]),e.$set(o)},i(n){t||(D(e.$$.fragment,n),t=!0)},o(n){W(e.$$.fragment,n),t=!1},d(n){Se(e,n)}}}function yo(r){let e,t,n,i,o,s,a,l,c,d,u,h;function f(m,E){return m[4]?wo:bo}let p=f(r,[-1,-1]),w=p(r),b=r[7]&&$r(r);return{c(){e=C("div"),t=C("div"),n=C("div"),i=R(),o=C("div"),s=R(),w.c(),a=R(),l=C("div"),c=C("div"),d=R(),b&&b.c(),u=ut(),g(t,"class","title svelte-160ftkp"),g(c,"class","actions svelte-160ftkp"),g(l,"class","action svelte-160ftkp"),g(e,"class","container svelte-160ftkp"),j(e,"selected",r[3]),j(e,"is-fold",!r[6])},m(m,E){P(m,e,E),_(e,t),_(t,n),r[23](n),_(t,i),_(t,o),r[24](o),_(t,s),w.m(t,null),_(e,a),_(e,l),_(l,c),r[27](c),P(m,d,E),b&&b.m(m,E),P(m,u,E),h=!0},p(m,E){p===(p=f(m,E))&&w?w.p(m,E):(w.d(1),w=p(m),w&&(w.c(),w.m(t,null))),(!h||E[0]&8)&&j(e,"selected",m[3]),(!h||E[0]&64)&&j(e,"is-fold",!m[6]),m[7]?b?(b.p(m,E),E[0]&128&&D(b,1)):(b=$r(m),b.c(),D(b,1),b.m(u.parentNode,u)):b&&(Ie(),W(b,1,1,()=>{b=null}),Te())},i(m){h||(D(b),h=!0)},o(m){W(b),h=!1},d(m){m&&(O(e),O(d),O(u)),r[23](null),r[24](null),w.d(),r[27](null),b&&b.d(m)}}}function xo(r,e){let t=ei(r),n=ei(e);if(t.length!==n.length)return!0;for(let i=0;i<t.length;i++)if(t[i].text!==n[i].text||t[i].level!==n[i].level)return!0;return!1}function ei(r){let e=[],t=r.split(`
`),n=!1;return t.forEach(i=>{let o=i.trim();if(o.startsWith("```")){n=!n;return}if(!n){let s=o.match(/^(#{1,6})\s+(.+)$/);s&&e.push({text:s[2].trim(),level:s[1].length})}}),e}function _o(r){let e=document.createElement("div");e.className="gridnote-delete-notice",e.textContent=`\u5DF2\u5220\u9664\u8282\u70B9"${r}"`,document.body.appendChild(e),requestAnimationFrame(()=>{e.classList.add("show")});let t,n=()=>{e.classList.remove("show"),e.addEventListener("transitionend",()=>{e.parentNode&&e.parentNode.removeChild(e)},{once:!0})};return t=window.setTimeout(n,3e3),()=>window.clearTimeout(t)}function ko(r,e,t){let n,{node:i}=e,{currentLines:o}=e,{searchKeyword:s=""}=e,{allHighlights:a=null}=e,{triggerEditHeader:l=!1}=e,c=$e("View"),d,u,h,f=!1,p=null,w=null,b=null,m=!1,E=!1,M,y=[],I=!1,L;function T(){t(4,I=!0),setTimeout(()=>{if(L){L.focus();let k=document.createRange();k.selectNodeContents(L);let H=window.getSelection();H==null||H.removeAllRanges(),H==null||H.addRange(k)}},0)}function q(){var k;if(!I)return;let H=((k=L==null?void 0:L.textContent)===null||k===void 0?void 0:k.trim())||"";t(4,I=!1),H!==i.header&&H!==""&&K(H)}function N(){t(4,I=!1)}function K(k){let{editor:H}=c;t(0,i.header=k,i);let x=`${"#".repeat(i.level)} ${k}`,v=i.startLine-1;if(H.setLine(v,x),c.file){c.markInternalModification&&c.markInternalModification(c.file.path);let S=H.getValue();c.app.vault.modify(c.file,S)}}function Z(k){k.preventDefault(),k.stopPropagation(),T()}function ne(k){(k.key==="Enter"||k.key===" ")&&(k.preventDefault(),k.stopPropagation(),T())}function de(k){k.key==="Enter"?(k.preventDefault(),q()):k.key==="Escape"&&(k.preventDefault(),k.stopPropagation(),N())}function we(){q()}function Y(k){let H=new We.Menu;H.addItem(v=>v.setTitle("\u5220\u9664\u6807\u9898\u884C").setIcon("minus").onClick(()=>{Le($.HEADER_ONLY)})),H.addItem(v=>v.setTitle("\u5220\u9664\u5F53\u524D\u8282\u70B9").setIcon("trash-2").onClick(()=>{Le($.CURRENT_NODE)})),H.addItem(v=>v.setTitle("\u5220\u9664\u5F53\u524D\u8282\u70B9\u53CA\u5B50\u8282\u70B9").setIcon("trash").onClick(()=>{Le($.WITH_CHILDREN)}));let x=k.getBoundingClientRect();H.showAtPosition({x:x.right,y:x.bottom})}function ae(k){let H=new We.ExtraButtonComponent(k).setIcon("trash").setTooltip("\u5220\u9664\u9009\u9879").onClick(()=>{Y(H.extraSettingsEl)});return()=>{H.extraSettingsEl.remove()}}function ie(){if(!M||I)return;if(y.length>0&&a&&a.update&&a.update(Q=>Q.filter(G=>!y.includes(G))),y=[],!s){t(8,M.textContent=n,M);return}let k=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),H=new RegExp(k,"gi"),x=i.header.trim();if(!x){t(8,M.textContent=n,M);return}let v=[],S;for(;(S=H.exec(x))!==null;)v.push({start:S.index,end:S.index+S[0].length,text:S[0]});if(v.length===0){t(8,M.textContent=n,M);return}t(8,M.textContent="",M);let V=document.createDocumentFragment(),z=0;v.forEach(Q=>{Q.start>z&&V.appendChild(document.createTextNode(x.slice(z,Q.start)));let G=document.createElement("span");G.className="search-highlight",G.textContent=Q.text,V.appendChild(G),z=Q.end}),z<x.length&&V.appendChild(document.createTextNode(x.slice(z))),M.appendChild(V),requestAnimationFrame(()=>{if(M){let Q=Array.from(M.querySelectorAll(".search-highlight, .search-current"));y=Q,Q.forEach(G=>{G.setAttribute("data-node-line",String(i.startLine)),G.setAttribute("data-is-header","true"),G.setAttribute("data-source","Header"),G.setAttribute("data-header-text",i.header)}),a&&a.update&&a.update(G=>((se,_e)=>{let ve=[...se];for(let U of _e){let ee=parseInt(U.getAttribute("data-node-line")||"0"),pe=U.getAttribute("data-is-header")==="true",he=0,Ve=ve.length;for(;he<Ve;){let Xe=Math.floor((he+Ve)/2),je=parseInt(ve[Xe].getAttribute("data-node-line")||"0"),vt=ve[Xe].getAttribute("data-is-header")==="true";ee<je||ee===je&&pe&&!vt?Ve=Xe:he=Xe+1}ve.splice(he,0,U)}return ve})(G,Q))}})}function le(k,H,x){let{editor:v}=c,S=v.getValue(),V=k,z=v.lineCount();x<=z&&!V.endsWith(`
`)&&(V=V+`
`),v.replaceRange(V,{line:H-1,ch:0},{line:x-1,ch:0});let G=v.getValue();if(S&&G&&S!==G){let xe=S.split(`
`).length,se=G.split(`
`).length;(xe!==se||xo(S,G))&&c.recalculateFoldStates&&c.recalculateFoldStates(S,G)}c.file&&(c.markInternalModification&&c.markInternalModification(c.file.path),c.app.vault.modify(c.file,G))}var $;(function(k){k.HEADER_ONLY="header-only",k.CURRENT_NODE="current-node",k.WITH_CHILDREN="with-children"})($||($={}));function Le(k=$.WITH_CHILDREN){if(!c.file)return;let{editor:H}=c,x=i.startLine-1,v,S;switch(k){case $.HEADER_ONLY:v=x,S="\u6807\u9898\u884C";break;case $.CURRENT_NODE:i.children&&i.children.length>0?v=i.children[0].startLine-2:v=i.endLine-1,S="\u5F53\u524D\u8282\u70B9";break;case $.WITH_CHILDREN:default:let V=H.getValue();v=Pt(V,i.startLine)-2,S="\u5F53\u524D\u8282\u70B9\u53CA\u5B50\u8282\u70B9";break}try{let V=H.getValue();H.replaceRange("",{line:x,ch:0},{line:v+1,ch:0});let z=H.getValue();c.recalculateFoldStates&&c.recalculateFoldStates(V,z),c.markInternalModification&&c.markInternalModification(c.file.path),c.app.vault.modify(c.file,z),_o(`${S}: ${i.header}`)}catch(V){console.error("Delete node failed:",V),new We.Notice("\u5220\u9664\u8282\u70B9\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5")}}function fe(){if(!c.file)return;ze.getInstance(c.app).openFallbackEditor(c.file,i,c.leaf)}function oe(){if(c.file){if(!i||!i.startLine){new We.Notice("\u5F53\u524D\u6587\u4EF6\u6CA1\u6709\u6807\u9898\uFF0C\u65E0\u6CD5\u4F7F\u7528\u6B64\u529F\u80FD");return}if(ze.isEmbeddableEditorAvailable(c.app)){let{editor:k}=c,H=k.getValue(),x=i.startLine;try{let v=Pt(H,x),S=k.getRange({line:x-1,ch:0},{line:v-1,ch:0});nt.getInstance(c.app).openEditor({title:i.header,value:S,placeholder:"\u7F16\u8F91\u5F53\u524D\u8282\u70B9\u53CA\u5176\u6240\u6709\u5B50\u8282\u70B9\u7684\u5185\u5BB9...",onSave:z=>{le(z,x,v)},onCancel:()=>{}})}catch(v){console.error("\u6253\u5F00\u7F16\u8F91\u5F39\u6846\u5931\u8D25:",v),new We.Notice("\u65E0\u6CD5\u6253\u5F00\u7F16\u8F91\u5668\uFF0C\u8BF7\u786E\u4FDD\u5F53\u524D\u884C\u662F\u6709\u6548\u7684\u6807\u9898")}}}}async function me(k){var H;let x=document.createElement("div"),v=new We.Component;try{await We.MarkdownRenderer.render(c.app,k,x,((H=c.file)===null||H===void 0?void 0:H.path)||"",v);let S=x.innerHTML,V=x.innerText;try{let z=new Blob([S],{type:"text/html"}),Q=new Blob([V],{type:"text/plain"});await navigator.clipboard.write([new ClipboardItem({"text/html":z,"text/plain":Q})])}catch(z){await navigator.clipboard.writeText(V)}}finally{v.unload()}}function Ge(){t(7,E=!0)}function De(){t(7,E=!1)}async function te(k){new We.Notice("\u622A\u56FE\u529F\u80FD\u4EC5\u5728 Electron \u73AF\u5883\u4E2D\u53EF\u7528"),De()}Pe(()=>{if(h){new We.ExtraButtonComponent(h).setIcon("columns").setTooltip("\u5728\u53F3\u4FA7\u7F16\u8F91\u5668\u4E2D\u6253\u5F00").onClick(()=>{fe()}),new We.ExtraButtonComponent(h).setIcon("edit").setTooltip("\u5F39\u6846\u7F16\u8F91\u8282\u70B9\u5185\u5BB9").onClick(()=>{oe()}),b=ae(h),w=Pr(h,async H=>{let{editor:x}=c,{startLine:v,content:S}=i;switch(H){case"\u590D\u5236\u6574\u4E2A\u6587\u6863":{let V=x.getValue();await navigator.clipboard.writeText(V);break}case"\u590D\u5236\u6B64\u8282\u70B9\uFF08\u7EAF\u6587\u672C\uFF09":{let V=x.getLine(v-1);await navigator.clipboard.writeText(`${V}
${S}`);break}case"\u590D\u5236\u8282\u70B9\u53CA\u5B50\u8282\u70B9\uFF08\u7EAF\u6587\u672C\uFF09":{let V=x.getValue(),z=Pt(V,v),Q=x.getRange({line:v-1,ch:0},{line:z-1,ch:0});await navigator.clipboard.writeText(Q);break}case"\u590D\u5236\u6B64\u8282\u70B9\uFF08\u5BCC\u6587\u672C\uFF09":{let z=`${x.getLine(v-1)}
${S}`;await me(z);break}case"\u590D\u5236\u8282\u70B9\u53CA\u5B50\u8282\u70B9\uFF08\u5BCC\u6587\u672C\uFF09":{let V=x.getValue(),z=Pt(V,v),Q=x.getRange({line:v-1,ch:0},{line:z-1,ch:0});await me(Q);break}case"\u5206\u4EAB\u4E3A\u56FE\u7247":{Ge();break}default:}},i.level);let k=new We.ExtraButtonComponent(d).setIcon(f?"chevron-down":"chevron-right").onClick(()=>{c.handleClickFold(i.startChar,i.startLine,()=>{})});c.LOCAL_FOLDS.subscribe(H=>{t(6,f=!H.includes(i.startLine-1)),k.setIcon(f?"chevron-down":"chevron-right")})}return()=>{p&&p(),w&&w(),b&&b()}}),Ke(()=>{y.length>0&&a&&a.update&&a.update(k=>k.filter(H=>!y.includes(H)))});function it(k){re[k?"unshift":"push"](()=>{d=k,t(5,d)})}function A(k){re[k?"unshift":"push"](()=>{u=k,t(1,u)})}function X(k){re[k?"unshift":"push"](()=>{L=k,t(9,L)})}function ye(k){re[k?"unshift":"push"](()=>{M=k,t(8,M)})}function F(k){re[k?"unshift":"push"](()=>{h=k,t(2,h)})}return r.$$set=k=>{"node"in k&&t(0,i=k.node),"currentLines"in k&&t(18,o=k.currentLines),"searchKeyword"in k&&t(19,s=k.searchKeyword),"allHighlights"in k&&t(20,a=k.allHighlights),"triggerEditHeader"in k&&t(21,l=k.triggerEditHeader)},r.$$.update=()=>{if(r.$$.dirty[0]&2097168){e:l&&!I&&T()}if(r.$$.dirty[0]&262155){e:o>0&&(t(3,m=o===i.startLine),m&&u&&(Br(u)||setTimeout(()=>{u.scrollIntoView({behavior:"smooth",block:"start"})},0)))}if(r.$$.dirty[0]&524288){e:s!==void 0&&ie()}if(r.$$.dirty[0]&1){e:t(10,n=i.header.trim()||"\u7A7A\u6807\u9898")}if(r.$$.dirty[0]&4194311){e:h&&(p&&p&&p(),t(22,p=zr(u,i.level,()=>{})))}},[i,u,h,m,I,d,f,E,M,L,n,c,Z,ne,de,we,De,te,o,s,a,l,p,it,A,X,ye,F]}var Jn=class extends ge{constructor(e){super(),Me(this,e,ko,yo,be,{node:0,currentLines:18,searchKeyword:19,allHighlights:20,triggerEditHeader:21},vo,[-1,-1])}},Xn=Jn;function Dt(r){let e=r-1;return e*e*e+1}function mt(r){return--r*r*r*r*r+1}function Xt(r,{delay:e=0,duration:t=400,easing:n=dt}={}){let i=+getComputedStyle(r).opacity;return{delay:e,duration:t,easing:n,css:o=>`opacity: ${o*i}`}}function Zt(r,{delay:e=0,duration:t=400,easing:n=Dt,x:i=0,y:o=0,opacity:s=0}={}){let a=getComputedStyle(r),l=+a.opacity,c=a.transform==="none"?"":a.transform,d=l*(1-s),[u,h]=An(i),[f,p]=An(o);return{delay:e,duration:t,easing:n,css:(w,b)=>`
			transform: ${c} translate(${(1-w)*u}${h}, ${(1-w)*f}${p});
			opacity: ${l-d*b}`}}function ti(r,{delay:e=0,duration:t=400,easing:n=Dt,axis:i="y"}={}){let o=getComputedStyle(r),s=+o.opacity,a=i==="y"?"height":"width",l=parseFloat(o[a]),c=i==="y"?["top","bottom"]:["left","right"],d=c.map(m=>`${m[0].toUpperCase()}${m.slice(1)}`),u=parseFloat(o[`padding${d[0]}`]),h=parseFloat(o[`padding${d[1]}`]),f=parseFloat(o[`margin${d[0]}`]),p=parseFloat(o[`margin${d[1]}`]),w=parseFloat(o[`border${d[0]}Width`]),b=parseFloat(o[`border${d[1]}Width`]);return{delay:e,duration:t,easing:n,css:m=>`overflow: hidden;opacity: ${Math.min(m*20,1)*s};${a}: ${m*l}px;padding-${c[0]}: ${m*u}px;padding-${c[1]}: ${m*h}px;margin-${c[0]}: ${m*f}px;margin-${c[1]}: ${m*p}px;border-${c[0]}-width: ${m*w}px;border-${c[1]}-width: ${m*b}px;`}}function Eo(r){ke(r,"svelte-u4gy5o",'@charset "UTF-8";.root-container.svelte-u4gy5o.svelte-u4gy5o{position:relative;cursor:pointer;border:2px solid transparent;border-radius:8px;padding:10px;transition:border-color 0.2s ease-in-out}.root-container.selected.svelte-u4gy5o.svelte-u4gy5o{border-color:var(--interactive-accent);box-shadow:0 0 0 1px var(--interactive-accent)}.root-container.svelte-u4gy5o.svelte-u4gy5o:has(.markdown-editor-container){border-color:transparent !important;box-shadow:none !important}.root-title-header.svelte-u4gy5o.svelte-u4gy5o{padding:30px 0px;border:none;margin:0}.add-child-btn.svelte-u4gy5o.svelte-u4gy5o{position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);width:28px;height:28px;border-radius:50%;background:var(--interactive-accent);color:var(--text-on-accent);border:2px solid var(--background-primary);cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10;opacity:0;transition:all 0.2s ease-in-out;box-shadow:0 2px 8px rgba(0, 0, 0, 0.15);padding:0;pointer-events:none}.add-child-btn.svelte-u4gy5o.svelte-u4gy5o:hover{transform:translateX(-50%) scale(1.15);box-shadow:0 4px 12px rgba(0, 0, 0, 0.25)}.add-child-btn.svelte-u4gy5o.svelte-u4gy5o:active{transform:translateX(-50%) scale(0.95)}.add-child-btn.svelte-u4gy5o svg{width:16px;height:16px;display:block;flex-shrink:0}.root-container.svelte-u4gy5o:hover .add-child-btn.svelte-u4gy5o{opacity:1;pointer-events:auto}.root-container.svelte-u4gy5o:has(.markdown-editor-container) .add-child-btn.svelte-u4gy5o{opacity:0 !important;pointer-events:none}.tree-children-container.svelte-u4gy5o.svelte-u4gy5o{width:100%;max-width:100%;display:flex}.left-column.svelte-u4gy5o.svelte-u4gy5o{max-width:100%;flex:1 1 0%;padding:0px 10px;overflow-wrap:break-word;word-break:break-word;cursor:pointer;border:2px solid transparent;border-radius:6px;transition:border-color 0.2s ease-in-out;position:relative}.left-column.selected.svelte-u4gy5o.svelte-u4gy5o{border-color:var(--interactive-accent);box-shadow:0 0 0 1px var(--interactive-accent)}.left-column.svelte-u4gy5o.svelte-u4gy5o:has(.markdown-editor-container){border-color:transparent !important;box-shadow:none !important}.add-header-btn.svelte-u4gy5o.svelte-u4gy5o{position:absolute;width:28px;height:28px;border-radius:50%;background:var(--interactive-accent);color:var(--text-on-accent);border:2px solid var(--background-primary);cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10;opacity:0;transition:all 0.2s ease-in-out;box-shadow:0 2px 8px rgba(0, 0, 0, 0.15);padding:0;pointer-events:none}.add-header-btn.svelte-u4gy5o.svelte-u4gy5o:hover{transform:scale(1.15);box-shadow:0 4px 12px rgba(0, 0, 0, 0.25)}.add-header-btn.svelte-u4gy5o.svelte-u4gy5o:active{transform:scale(0.95)}.add-header-btn.svelte-u4gy5o svg{width:16px;height:16px;display:block;flex-shrink:0}.left-column.svelte-u4gy5o:hover .add-header-btn.svelte-u4gy5o{opacity:1;pointer-events:auto}.left-column.svelte-u4gy5o:has(.markdown-editor-container) .add-header-btn.svelte-u4gy5o{opacity:0 !important;pointer-events:none}.add-header-top.svelte-u4gy5o.svelte-u4gy5o{top:-14px;left:50%;transform:translateX(-50%)}.add-header-bottom.svelte-u4gy5o.svelte-u4gy5o{bottom:-14px;left:50%;transform:translateX(-50%)}.add-header-right.svelte-u4gy5o.svelte-u4gy5o{top:50%;right:-14px;transform:translateY(-50%)}.add-header-top.svelte-u4gy5o.svelte-u4gy5o:hover{transform:translateX(-50%) scale(1.15)}.add-header-bottom.svelte-u4gy5o.svelte-u4gy5o:hover{transform:translateX(-50%) scale(1.15)}.add-header-right.svelte-u4gy5o.svelte-u4gy5o:hover{transform:translateY(-50%) scale(1.15)}.right-column.svelte-u4gy5o.svelte-u4gy5o{overflow-wrap:break-word;word-break:break-word;min-width:50%}.left-column .inline-title{display:none}.left-column .markdown-rendered:not(.is-live-preview){max-width:100%;overflow-x:auto}.left-column .metadata-container{display:none !important}.search-highlight{background:var(--text-highlight-bg);color:var(--text-on-accent);border-radius:2px;box-shadow:0 0 0 2px var(--text-highlight-bg)}.search-current{background:var(--text-selection);color:var(--text-normal)}')}function Co(r){let e,t,n,i,o,s,a,l,c;return t=new Xn({props:{currentLines:r[2],node:r[0],searchKeyword:r[15],allHighlights:r[5],triggerEditHeader:r[12]}}),{c(){e=C("div"),Ae(t.$$.fragment),g(e,"data-node-id",n=r[0].id),g(e,"data-node-level",i=r[0].level),g(e,"data-start-line",o=r[0].startLine),g(e,"data-end-line",s=r[0].endLine),g(e,"data-start-char",a=r[0].startChar),g(e,"data-end-char",l=r[0].endChar)},m(d,u){P(d,e,u),Ce(t,e,null),c=!0},p(d,u){let h={};u[0]&4&&(h.currentLines=d[2]),u[0]&1&&(h.node=d[0]),u[0]&32768&&(h.searchKeyword=d[15]),u[0]&32&&(h.allHighlights=d[5]),u[0]&4096&&(h.triggerEditHeader=d[12]),t.$set(h),(!c||u[0]&1&&n!==(n=d[0].id))&&g(e,"data-node-id",n),(!c||u[0]&1&&i!==(i=d[0].level))&&g(e,"data-node-level",i),(!c||u[0]&1&&o!==(o=d[0].startLine))&&g(e,"data-start-line",o),(!c||u[0]&1&&s!==(s=d[0].endLine))&&g(e,"data-end-line",s),(!c||u[0]&1&&a!==(a=d[0].startChar))&&g(e,"data-start-char",a),(!c||u[0]&1&&l!==(l=d[0].endChar))&&g(e,"data-end-char",l)},i(d){c||(D(t.$$.fragment,d),c=!0)},o(d){W(t.$$.fragment,d),c=!1},d(d){d&&O(e),Se(t)}}}function So(r){let e,t,n,i,o,s,a,l,c,d,u;n=new Xn({props:{currentLines:r[2],node:r[0],searchKeyword:r[15],allHighlights:r[5],triggerEditHeader:r[12]}});let h=r[13]&&ni(r);return{c(){e=C("div"),t=C("h1"),Ae(n.$$.fragment),i=R(),h&&h.c(),g(t,"class","root-title-header svelte-u4gy5o"),g(e,"data-node-id",o=r[0].id),g(e,"data-node-level",s=r[0].level),g(e,"data-start-line",a=r[0].startLine),g(e,"data-end-line",l=r[0].endLine),g(e,"data-start-char",c=r[0].startChar),g(e,"data-end-char",d=r[0].endChar)},m(f,p){P(f,e,p),_(e,t),Ce(n,t,null),_(e,i),h&&h.m(e,null),u=!0},p(f,p){let w={};p[0]&4&&(w.currentLines=f[2]),p[0]&1&&(w.node=f[0]),p[0]&32768&&(w.searchKeyword=f[15]),p[0]&32&&(w.allHighlights=f[5]),p[0]&4096&&(w.triggerEditHeader=f[12]),n.$set(w),f[13]?h?(h.p(f,p),p[0]&8192&&D(h,1)):(h=ni(f),h.c(),D(h,1),h.m(e,null)):h&&(Ie(),W(h,1,1,()=>{h=null}),Te()),(!u||p[0]&1&&o!==(o=f[0].id))&&g(e,"data-node-id",o),(!u||p[0]&1&&s!==(s=f[0].level))&&g(e,"data-node-level",s),(!u||p[0]&1&&a!==(a=f[0].startLine))&&g(e,"data-start-line",a),(!u||p[0]&1&&l!==(l=f[0].endLine))&&g(e,"data-end-line",l),(!u||p[0]&1&&c!==(c=f[0].startChar))&&g(e,"data-start-char",c),(!u||p[0]&1&&d!==(d=f[0].endChar))&&g(e,"data-end-char",d)},i(f){u||(D(n.$$.fragment,f),D(h),u=!0)},o(f){W(n.$$.fragment,f),W(h),u=!1},d(f){f&&O(e),Se(n),h&&h.d()}}}function ni(r){let e,t,n,i,o,s,a,l,c=r[10]&&ri(r);return n=new jn({props:{node:r[0],View:r[16],searchKeyword:r[3],searchIndex:r[4],allHighlights:r[5],isLevelOne:!0,triggerEdit:r[11],isSelected:r[10]}}),n.$on("contentUpdated",r[27]),n.$on("headerUpdated",r[28]),{c(){e=C("div"),c&&c.c(),t=R(),Ae(n.$$.fragment),g(e,"class","level-1-content root-container svelte-u4gy5o"),g(e,"data-start-line",i=r[0].startLine),g(e,"role","button"),g(e,"tabindex","0"),ue(e,"max-width","70%"),ue(e,"margin","0 auto"),j(e,"selected",r[10])},m(d,u){P(d,e,u),c&&c.m(e,null),_(e,t),Ce(n,e,null),s=!0,a||(l=[B(e,"click",r[21]),B(e,"keydown",r[22])],a=!0)},p(d,u){d[10]?c?c.p(d,u):(c=ri(d),c.c(),c.m(e,t)):c&&(c.d(1),c=null);let h={};u[0]&1&&(h.node=d[0]),u[0]&8&&(h.searchKeyword=d[3]),u[0]&16&&(h.searchIndex=d[4]),u[0]&32&&(h.allHighlights=d[5]),u[0]&2048&&(h.triggerEdit=d[11]),u[0]&1024&&(h.isSelected=d[10]),n.$set(h),(!s||u[0]&1&&i!==(i=d[0].startLine))&&g(e,"data-start-line",i),(!s||u[0]&1024)&&j(e,"selected",d[10])},i(d){s||(D(n.$$.fragment,d),d&&Be(()=>{s&&(o||(o=tt(e,r[24],{duration:400,easing:mt},!0)),o.run(1))}),s=!0)},o(d){W(n.$$.fragment,d),d&&(o||(o=tt(e,r[24],{duration:400,easing:mt},!1)),o.run(0)),s=!1},d(d){d&&O(e),c&&c.d(),Se(n),d&&o&&o.end(),a=!1,ce(l)}}}function ri(r){let e,t,n;return{c(){e=C("button"),e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',g(e,"class","add-child-btn svelte-u4gy5o"),g(e,"title","\u6DFB\u52A0\u4E8C\u7EA7\u5B50\u6807\u9898"),g(e,"aria-label","\u6DFB\u52A0\u4E8C\u7EA7\u5B50\u6807\u9898")},m(i,o){P(i,e,o),t||(n=B(e,"click",yt(r[34])),t=!0)},p:J,d(i){i&&O(e),t=!1,n()}}}function ii(r){let e,t,n,i,o=r[9]==!1&&oi(r),s=r[0].children&&r[0].children.length>0&&r[0].level<=r[7]&&li(r);return{c(){e=C("div"),o&&o.c(),t=R(),s&&s.c(),g(e,"class","tree-children-container svelte-u4gy5o")},m(a,l){P(a,e,l),o&&o.m(e,null),_(e,t),s&&s.m(e,null),i=!0},p(a,l){a[9]==!1?o?(o.p(a,l),l[0]&512&&D(o,1)):(o=oi(a),o.c(),D(o,1),o.m(e,t)):o&&(Ie(),W(o,1,1,()=>{o=null}),Te()),a[0].children&&a[0].children.length>0&&a[0].level<=a[7]?s?(s.p(a,l),l[0]&129&&D(s,1)):(s=li(a),s.c(),D(s,1),s.m(e,null)):s&&(Ie(),W(s,1,1,()=>{s=null}),Te())},i(a){i||(D(o),D(s),a&&Be(()=>{i&&(n||(n=tt(e,r[24],{duration:350,easing:Dt},!0)),n.run(1))}),i=!0)},o(a){W(o),W(s),a&&(n||(n=tt(e,r[24],{duration:350,easing:Dt},!1)),n.run(0)),i=!1},d(a){a&&O(e),o&&o.d(),s&&s.d(),a&&n&&n.end()}}}function oi(r){let e,t,n,i,o,s,a,l,c,d=r[10]&&si(r);return n=new jn({props:{node:r[0],View:r[16],searchKeyword:r[3],searchIndex:r[4],allHighlights:r[5],isLevelOne:!1,triggerEdit:r[11],isSelected:r[10]}}),n.$on("contentUpdated",r[27]),n.$on("headerUpdated",r[28]),{c(){e=C("div"),d&&d.c(),t=R(),Ae(n.$$.fragment),g(e,"class","left-column svelte-u4gy5o"),ue(e,"flex","1 1 0%"),g(e,"data-start-line",i=r[0].startLine),g(e,"role","button"),g(e,"tabindex","0"),j(e,"selected",r[10])},m(u,h){P(u,e,h),d&&d.m(e,null),_(e,t),Ce(n,e,null),r[38](e),a=!0,l||(c=[B(e,"click",r[21]),B(e,"keydown",r[22])],l=!0)},p(u,h){u[10]?d?d.p(u,h):(d=si(u),d.c(),d.m(e,t)):d&&(d.d(1),d=null);let f={};h[0]&1&&(f.node=u[0]),h[0]&8&&(f.searchKeyword=u[3]),h[0]&16&&(f.searchIndex=u[4]),h[0]&32&&(f.allHighlights=u[5]),h[0]&2048&&(f.triggerEdit=u[11]),h[0]&1024&&(f.isSelected=u[10]),n.$set(f),(!a||h[0]&1&&i!==(i=u[0].startLine))&&g(e,"data-start-line",i),(!a||h[0]&1024)&&j(e,"selected",u[10])},i(u){a||(D(n.$$.fragment,u),u&&Be(()=>{a&&(s&&s.end(1),o=Bn(e,r[25],{x:-20,duration:300,delay:100,easing:mt}),o.start())}),a=!0)},o(u){W(n.$$.fragment,u),o&&o.invalidate(),u&&(s=Wn(e,r[26],{duration:200})),a=!1},d(u){u&&O(e),d&&d.d(),Se(n),r[38](null),u&&s&&s.end(),l=!1,ce(c)}}}function si(r){let e,t,n,i,o,s,a,l=r[8]&&ai(r);return{c(){e=C("button"),e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',t=R(),n=C("button"),n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',i=R(),l&&l.c(),o=ut(),g(e,"class","add-header-btn add-header-top svelte-u4gy5o"),g(e,"title","\u5728\u4E0A\u65B9\u63D2\u5165\u540C\u7EA7\u6807\u9898 (Ctrl+Shift+\u2191)"),g(e,"aria-label","\u5728\u4E0A\u65B9\u63D2\u5165\u540C\u7EA7\u6807\u9898"),g(n,"class","add-header-btn add-header-bottom svelte-u4gy5o"),g(n,"title","\u5728\u4E0B\u65B9\u63D2\u5165\u540C\u7EA7\u6807\u9898 (Ctrl+Shift+\u2193)"),g(n,"aria-label","\u5728\u4E0B\u65B9\u63D2\u5165\u540C\u7EA7\u6807\u9898")},m(c,d){P(c,e,d),P(c,t,d),P(c,n,d),P(c,i,d),l&&l.m(c,d),P(c,o,d),s||(a=[B(e,"click",yt(r[35])),B(n,"click",yt(r[36]))],s=!0)},p(c,d){c[8]?l?l.p(c,d):(l=ai(c),l.c(),l.m(o.parentNode,o)):l&&(l.d(1),l=null)},d(c){c&&(O(e),O(t),O(n),O(i),O(o)),l&&l.d(c),s=!1,ce(a)}}}function ai(r){let e,t,n;return{c(){e=C("button"),e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>',g(e,"class","add-header-btn add-header-right svelte-u4gy5o"),g(e,"title","\u5728\u53F3\u4FA7\u63D2\u5165\u5B50\u7EA7\u6807\u9898 (Ctrl+Shift+\u2192)"),g(e,"aria-label","\u5728\u53F3\u4FA7\u63D2\u5165\u5B50\u7EA7\u6807\u9898")},m(i,o){P(i,e,o),t||(n=B(e,"click",yt(r[37])),t=!0)},p:J,d(i){i&&O(e),t=!1,n()}}}function li(r){let e,t,n,i,o;return t=new bn({props:{currentLines:r[2],nodes:r[0].children,tier:r[1]+1,searchKeyword:r[3],searchIndex:r[4],allHighlights:r[5]}}),t.$on("contentUpdated",r[27]),t.$on("headerUpdated",r[28]),{c(){e=C("div"),Ae(t.$$.fragment),g(e,"class","right-column svelte-u4gy5o"),ue(e,"flex",r[14]+" 1 0%")},m(s,a){P(s,e,a),Ce(t,e,null),o=!0},p(s,a){let l={};a[0]&4&&(l.currentLines=s[2]),a[0]&1&&(l.nodes=s[0].children),a[0]&2&&(l.tier=s[1]+1),a[0]&8&&(l.searchKeyword=s[3]),a[0]&16&&(l.searchIndex=s[4]),a[0]&32&&(l.allHighlights=s[5]),t.$set(l),(!o||a[0]&16384)&&ue(e,"flex",s[14]+" 1 0%")},i(s){o||(D(t.$$.fragment,s),s&&Be(()=>{o&&(i&&i.end(1),n=Bn(e,r[25],{x:20,duration:300,delay:150,easing:mt}),n.start())}),o=!0)},o(s){W(t.$$.fragment,s),n&&n.invalidate(),s&&(i=Wn(e,r[26],{duration:200})),o=!1},d(s){s&&O(e),Se(t),s&&i&&i.end()}}}function Mo(r){let e,t,n,i,o,s,a=[So,Co],l=[];function c(u,h){return u[9]?0:1}t=c(r,[-1,-1]),n=l[t]=a[t](r);let d=r[13]&&ii(r);return{c(){e=C("div"),n.c(),i=R(),d&&d.c(),g(e,"class","gridnote-tree-item"),g(e,"data-node-id",o=r[0].id)},m(u,h){P(u,e,h),l[t].m(e,null),_(e,i),d&&d.m(e,null),s=!0},p(u,h){let f=t;t=c(u,h),t===f?l[t].p(u,h):(Ie(),W(l[f],1,1,()=>{l[f]=null}),Te(),n=l[t],n?n.p(u,h):(n=l[t]=a[t](u),n.c()),D(n,1),n.m(e,i)),u[13]?d?(d.p(u,h),h[0]&8192&&D(d,1)):(d=ii(u),d.c(),D(d,1),d.m(e,null)):d&&(Ie(),W(d,1,1,()=>{d=null}),Te()),(!s||h[0]&1&&o!==(o=u[0].id))&&g(e,"data-node-id",o)},i(u){s||(D(n),D(d),s=!0)},o(u){W(n),W(d),s=!1},d(u){u&&O(e),l[t].d(),d&&d.d()}}}function Lo(r){let e=r.getBoundingClientRect();return e.top>=0&&e.left>=0&&e.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&e.right<=(window.innerWidth||document.documentElement.clientWidth)}function Io(r,e,t){let n,i,o,s,a,l,c,d,u,h=J,f=()=>(h(),h=st(m,F=>t(15,u=F)),m);r.$$.on_destroy.push(()=>h());let{node:p}=e,{tier:w}=e,{currentLines:b}=e,{searchKeyword:m}=e;f();let{searchIndex:E}=e,{allHighlights:M}=e,y=$e("View"),I=$e("flexStore"),L=$e("selectedNodeLine");at(r,L,F=>t(33,d=F));let T=$e("editTrigger");at(r,T,F=>t(32,c=F));let q=$e("insertTrigger");at(r,q,F=>t(31,l=F));let N=$e("editHeaderTrigger");at(r,N,F=>t(30,a=F));function K(F){let k=F.target;if(F.currentTarget.querySelector(".markdown-editor-container")!==null)return;if(!k.closest(".markdown-rendered, .header, .add-header-btn, .add-child-btn")&&i){L.set(null);return}i||L.set(p.startLine)}function Z(F){F.key==="Enter"&&K(F)}let ne,de=!1,we=0,Y=!1;async function ae(F){if(!(!y.file||!y.app))try{let k=await y.app.vault.read(y.file),H,x;switch(F){case"before":H=p.startLine,x=p.level;break;case"after":H=lr(k,p.startLine,p.level),x=p.level;break;case"child":H=cr(k,p.startLine),x=p.level+1;break}let v=dr(k,H,x);await y.app.vault.modify(y.file,v),L.set(H),y.render&&setTimeout(()=>{y.render(v)},100)}catch(k){console.error("\u63D2\u5165\u6807\u9898\u5931\u8D25:",k)}}let ie=!0,le=[];function $(){let F=Date.now();return y.lastUserFoldInteraction>0&&F-y.lastUserFoldInteraction<500}y.LOCAL_FOLDS.subscribe(F=>{le=F,t(13,ie=!F.includes(p.startLine-1))});function Le(F,k){return $()?ti(F,k):{duration:0,css:()=>""}}function fe(F,k){return $()?Zt(F,k):{duration:0,css:()=>""}}function oe(F,k){return $()?Xt(F,k):{duration:0,css:()=>""}}let me=3;Pe(()=>{I.subscribe(F=>{t(7,me=F.tier),t(14,s=me-w)})});function Ge(F){let{node:k,newContent:H,fullMarkdown:x,skipGlobalRefresh:v}=F.detail;k===p&&(t(0,p.content=H,p),t(0,p=Object.assign({},p))),!v&&y&&y.render&&x&&setTimeout(()=>{y.render(x)},100)}function De(F){let{node:k,oldHeader:H,newHeader:x,oldLevel:v,newLevel:S}=F.detail;k===p&&(t(0,p.header=x,p),t(0,p.level=S,p),t(0,p=Object.assign({},p)))}let te=()=>ae("child"),it=()=>ae("before"),A=()=>ae("after"),X=()=>ae("child");function ye(F){re[F?"unshift":"push"](()=>{ne=F,t(6,ne)})}return r.$$set=F=>{"node"in F&&t(0,p=F.node),"tier"in F&&t(1,w=F.tier),"currentLines"in F&&t(2,b=F.currentLines),"searchKeyword"in F&&f(t(3,m=F.searchKeyword)),"searchIndex"in F&&t(4,E=F.searchIndex),"allHighlights"in F&&t(5,M=F.allHighlights)},r.$$.update=()=>{if(r.$$.dirty[0]&1){e:t(9,n=p.level===1)}if(r.$$.dirty[0]&1|r.$$.dirty[1]&4){e:t(10,i=d===p.startLine)}if(r.$$.dirty[0]&129){e:t(8,o=p.level<6&&p.level<=me)}if(r.$$.dirty[0]&1600){e:i&&ne&&!n&&Ze().then(()=>{Lo(ne)||ne.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"})})}if(r.$$.dirty[0]&536870913|r.$$.dirty[1]&2){e:c===p.startLine&&(t(29,we++,we),t(11,de=!0),T.set(null),setTimeout(()=>{t(11,de=!1)},100))}if(r.$$.dirty[0]&769|r.$$.dirty[1]&1){e:if(l&&l.line===p.startLine&&!n){let F=l.position;q.set(null),(F!=="child"||o)&&ae(F)}}if(r.$$.dirty[0]&1073741825){e:a===p.startLine&&(t(12,Y=!0),N.set(null),setTimeout(()=>{t(12,Y=!1)},100))}if(r.$$.dirty[0]&130){e:t(14,s=me-w)}},[p,w,b,m,E,M,ne,me,o,n,i,de,Y,ie,s,u,y,L,T,q,N,K,Z,ae,Le,fe,oe,Ge,De,we,a,l,c,d,te,it,A,X,ye]}var Zn=class extends ge{constructor(e){super(),Me(this,e,Io,Mo,be,{node:0,tier:1,currentLines:2,searchKeyword:3,searchIndex:4,allHighlights:5},Eo,[-1,-1])}},ci=Zn;function To(r){ke(r,"svelte-zw1sbl",".tree-container.svelte-zw1sbl{width:100%;height:100%;position:relative}.tree-list.svelte-zw1sbl{width:100%;list-style-type:none;padding-left:0;margin:0;padding-top:0}.tree-container.svelte-zw1sbl::-webkit-scrollbar{width:8px}.tree-container.svelte-zw1sbl::-webkit-scrollbar-track{background:var(--background-primary)}.tree-container.svelte-zw1sbl::-webkit-scrollbar-thumb{background:var(--background-modifier-border);border-radius:4px}.tree-container.svelte-zw1sbl::-webkit-scrollbar-thumb:hover{background:var(--background-modifier-border-hover)}")}function di(r,e,t){let n=r.slice();return n[8]=e[t],n}function ui(r,e){let t,n,i,o;return n=new ci({props:{currentLines:e[2],node:e[8],tier:e[1],searchKeyword:e[3],searchIndex:e[4],allHighlights:e[5]}}),{key:r,first:null,c(){t=C("li"),Ae(n.$$.fragment),i=R(),this.first=t},m(s,a){P(s,t,a),Ce(n,t,null),_(t,i),o=!0},p(s,a){e=s;let l={};a&4&&(l.currentLines=e[2]),a&1&&(l.node=e[8]),a&2&&(l.tier=e[1]),a&8&&(l.searchKeyword=e[3]),a&16&&(l.searchIndex=e[4]),a&32&&(l.allHighlights=e[5]),n.$set(l)},i(s){o||(D(n.$$.fragment,s),o=!0)},o(s){W(n.$$.fragment,s),o=!1},d(s){s&&O(t),Se(n)}}}function Ao(r){let e,t,n=[],i=new Map,o,s=Re(r[0]),a=l=>l[8].id;for(let l=0;l<s.length;l+=1){let c=di(r,s,l),d=a(c);i.set(d,n[l]=ui(d,c))}return{c(){e=C("div"),t=C("ul");for(let l=0;l<n.length;l+=1)n[l].c();g(t,"class","tree-list svelte-zw1sbl"),g(e,"class","tree-container svelte-zw1sbl")},m(l,c){P(l,e,c),_(e,t);for(let d=0;d<n.length;d+=1)n[d]&&n[d].m(t,null);r[7](e),o=!0},p(l,[c]){c&63&&(s=Re(l[0]),Ie(),n=Ar(n,c,a,1,l,s,i,t,Tr,ui,null,di),Te())},i(l){if(!o){for(let c=0;c<s.length;c+=1)D(n[c]);o=!0}},o(l){for(let c=0;c<n.length;c+=1)W(n[c]);o=!1},d(l){l&&O(e);for(let c=0;c<n.length;c+=1)n[c].d();r[7](null)}}}function Vo(r,e,t){let{nodes:n}=e,{tier:i}=e,{currentLines:o}=e,{searchKeyword:s}=e,{searchIndex:a}=e,{allHighlights:l}=e,c;function d(u){re[u?"unshift":"push"](()=>{c=u,t(6,c)})}return r.$$set=u=>{"nodes"in u&&t(0,n=u.nodes),"tier"in u&&t(1,i=u.tier),"currentLines"in u&&t(2,o=u.currentLines),"searchKeyword"in u&&t(3,s=u.searchKeyword),"searchIndex"in u&&t(4,a=u.searchIndex),"allHighlights"in u&&t(5,l=u.allHighlights)},[n,i,o,s,a,l,c,d]}var Qn=class extends ge{constructor(e){super(),Me(this,e,Vo,Ao,be,{nodes:0,tier:1,currentLines:2,searchKeyword:3,searchIndex:4,allHighlights:5},To)}},bn=Qn;function Fo(r){ke(r,"svelte-52qe79",'.search-bar.svelte-52qe79{display:flex;align-items:center;gap:8px;padding:6px 12px;background:var(--background-primary);border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.15)}input[type="text"].svelte-52qe79{flex:1;padding:4px 10px;border:1px solid var(--background-modifier-border);border-radius:4px;background:var(--background-primary);color:var(--text-normal);font-size:var(--font-small);transition:border-color 0.2s, box-shadow 0.2s}input[type="text"].svelte-52qe79:focus{outline:none;border-color:var(--interactive-accent);box-shadow:0 0 0 2px var(--interactive-accent-hover)}.search-btn.svelte-52qe79{padding:4px 8px;min-width:28px;height:28px;border:none;background:var(--interactive-normal);color:var(--text-normal);border-radius:4px;cursor:pointer;transition:all 0.2s;font-size:var(--font-small);display:flex;align-items:center;justify-content:center}.search-btn.svelte-52qe79:hover{background:var(--interactive-hover)}.search-btn.svelte-52qe79:active{background:var(--interactive-accent);color:var(--text-on-accent)}.search-btn.svelte-52qe79:disabled{background:var(--background-modifier-border);color:var(--text-faint);cursor:not-allowed}.result.svelte-52qe79{min-width:50px;text-align:center;color:var(--text-muted);font-size:var(--font-smaller);font-weight:500;padding:2px 6px}.result.has-results.svelte-52qe79{color:var(--interactive-accent)}.search-close.svelte-52qe79{padding:4px 6px;min-width:24px;height:24px;border:none;background:transparent;color:var(--text-muted);border-radius:50%;cursor:pointer;transition:all 0.2s;font-size:var(--font-smaller);display:flex;align-items:center;justify-content:center}.search-close.svelte-52qe79:hover{background:var(--background-modifier-hover);color:var(--text-normal)}')}function No(r){let e,t,n,i,o,s,a,l,c,d,u,h,f=r[2]>0?`${r[3]+1}/${r[2]}`:"\u65E0\u7ED3\u679C",p,w,b,m,E;return{c(){e=C("div"),t=C("input"),n=R(),i=C("button"),o=Ee("\u2191"),a=R(),l=C("button"),c=Ee("\u2193"),u=R(),h=C("span"),p=Ee(f),w=R(),b=C("button"),b.textContent="\u2715",g(t,"type","text"),g(t,"placeholder","\u641C\u7D22..."),g(t,"class","svelte-52qe79"),g(i,"class","search-btn svelte-52qe79"),i.disabled=s=r[2]===0,g(i,"title","\u4E0A\u4E00\u4E2A (Shift+Enter)"),g(l,"class","search-btn svelte-52qe79"),l.disabled=d=r[2]===0,g(l,"title","\u4E0B\u4E00\u4E2A (Enter)"),g(h,"class","result svelte-52qe79"),j(h,"has-results",r[2]>0),g(b,"class","search-close svelte-52qe79"),g(b,"title","\u5173\u95ED (Esc)"),g(e,"class","search-bar search-component svelte-52qe79")},m(M,y){P(M,e,y),_(e,t),ft(t,r[1]),r[15](t),_(e,n),_(e,i),_(i,o),_(e,a),_(e,l),_(l,c),_(e,u),_(e,h),_(h,p),_(e,w),_(e,b),m||(E=[B(t,"input",r[5]),B(t,"input",r[14]),B(t,"focus",r[8]),B(t,"blur",r[9]),B(t,"keydown",r[10]),B(i,"click",r[6]),B(l,"click",r[7]),B(b,"click",r[16])],m=!0)},p(M,[y]){y&2&&t.value!==M[1]&&ft(t,M[1]),y&4&&s!==(s=M[2]===0)&&(i.disabled=s),y&4&&d!==(d=M[2]===0)&&(l.disabled=d),y&12&&f!==(f=M[2]>0?`${M[3]+1}/${M[2]}`:"\u65E0\u7ED3\u679C")&&Je(p,f),y&4&&j(h,"has-results",M[2]>0)},i:J,o:J,d(M){M&&O(e),r[15](null),m=!1,ce(E)}}}function Ho(r,e,t){let{searchKeyword:n}=e,{searchIndex:i}=e,{searchCount:o}=e,{inputEl:s=null}=e,a=Kt(),l="",c=0,d=0,u=null,h="";function f(T){t(1,l=T.target.value),u&&clearTimeout(u);let q=l.length>10?300:200;u=setTimeout(()=>{l!==h&&(n.set(l),i.set(0),a("search",{keyword:l}),h=l)},q)}function p(){c!==0&&(i.update(T=>(T-1+c)%c),a("jump",{direction:"prev"}))}function w(){c!==0&&(i.update(T=>(T+1)%c),a("jump",{direction:"next"}))}function b(T){if(T.key==="Enter"){if(c===0)return;T.shiftKey?p():w(),T.preventDefault()}}function m(){s&&s.removeEventListener("keydown",b),s&&s.addEventListener("keydown",b)}function E(){s&&s.removeEventListener("keydown",b)}Pe(()=>{}),Ke(()=>{s&&s.removeEventListener("keydown",b),n.set(""),i.set(0),o.set(0)});function M(T){T.key==="Escape"&&(a("exit"),T.stopPropagation())}function y(){l=this.value,t(1,l)}function I(T){re[T?"unshift":"push"](()=>{s=T,t(0,s)})}let L=()=>a("exit");return r.$$set=T=>{"searchKeyword"in T&&t(11,n=T.searchKeyword),"searchIndex"in T&&t(12,i=T.searchIndex),"searchCount"in T&&t(13,o=T.searchCount),"inputEl"in T&&t(0,s=T.inputEl)},r.$$.update=()=>{if(r.$$.dirty&8192){e:o.subscribe(T=>t(2,c=T))}if(r.$$.dirty&4096){e:i.subscribe(T=>t(3,d=T))}},[s,l,c,d,a,f,p,w,m,E,M,n,i,o,y,I,L]}var $n=class extends ge{constructor(e){super(),Me(this,e,Ho,No,be,{searchKeyword:11,searchIndex:12,searchCount:13,inputEl:0},Fo)}},fi=$n;var Qe=require("obsidian");var hi=require("@codemirror/commands");function Do(r){ke(r,"svelte-13uxerw",`@charset "UTF-8";.vertical-toolbar.svelte-13uxerw{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);z-index:1000;background:var(--background-primary);border:1px solid var(--background-modifier-border);border-radius:12px;padding:8px 12px;margin-bottom:max(0px, env(safe-area-inset-bottom, 0px));box-shadow:0 4px 20px rgba(0, 0, 0, 0.2);display:flex;flex-direction:row;gap:6px;align-items:center;user-select:none;overflow:visible !important;opacity:0.9;transition:opacity 0.2s ease, transform 0.2s ease;backdrop-filter:blur(10px);pointer-events:auto;box-sizing:border-box}.vertical-toolbar.svelte-13uxerw:hover{opacity:1}.toolbar-section.svelte-13uxerw{display:flex;flex-direction:row;gap:4px;align-items:center;overflow:visible !important}.toolbar-divider.svelte-13uxerw{width:1px;height:24px;background:var(--background-modifier-border);margin:0 4px}.toolbar-button.svelte-13uxerw{width:28px;height:28px;border:none;border-radius:4px;background:var(--interactive-normal);color:var(--text-normal);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease;position:relative}.toolbar-button.svelte-13uxerw:hover:not(:disabled){background:var(--interactive-hover);transform:translateY(-1px);box-shadow:0 2px 6px rgba(0, 0, 0, 0.1)}.toolbar-button.svelte-13uxerw:active:not(:disabled){transform:translateY(0);background:var(--interactive-accent);color:var(--text-on-accent)}.toolbar-button.svelte-13uxerw:disabled,.toolbar-button[disabled].svelte-13uxerw,.toolbar-button.disabled.svelte-13uxerw{opacity:0.5 !important;cursor:not-allowed !important;background:var(--background-modifier-border) !important;color:var(--text-muted) !important}.toolbar-button.svelte-13uxerw:disabled:hover,.toolbar-button[disabled].svelte-13uxerw:hover,.toolbar-button.disabled.svelte-13uxerw:hover{opacity:0.5 !important;background:var(--background-modifier-border) !important;transform:none !important;box-shadow:none !important}.toolbar-button.active.svelte-13uxerw{background:var(--interactive-accent);color:var(--text-on-accent);box-shadow:0 0 0 2px var(--interactive-accent-hover)}.toolbar-button.active.svelte-13uxerw:hover{background:var(--interactive-accent-hover)}.toolbar-button.svelte-13uxerw svg{width:14px !important;height:14px !important;flex-shrink:0}.toolbar-button.vip-gold.svelte-13uxerw{position:relative;overflow:visible !important}.toolbar-button.vip-gold.svelte-13uxerw::after{content:"";position:absolute;top:-6px;right:-6px;width:16px;height:16px;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><defs><linearGradient id="goldV" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23ffd700;stop-opacity:1" /><stop offset="50%" style="stop-color:%23ffed4e;stop-opacity:1" /><stop offset="100%" style="stop-color:%23ffb700;stop-opacity:1" /></linearGradient></defs><text x="8" y="12" text-anchor="middle" fill="url(%23goldV)" font-family="Georgia,serif" font-size="12" font-weight="bold" stroke="%23cc8800" stroke-width="0.3">V</text></svg>');background-size:contain;background-repeat:no-repeat;background-position:center;z-index:10001 !important;pointer-events:none;filter:drop-shadow(0 1px 3px rgba(0, 0, 0, 0.4));transition:all 0.2s ease}.toolbar-button.vip-gold.svelte-13uxerw:hover::after{transform:scale(1.2);filter:drop-shadow(0 2px 6px rgba(255, 215, 0, 0.6))}.toolbar-button.vip-premium.svelte-13uxerw{position:relative;overflow:visible !important}.toolbar-button.vip-premium.svelte-13uxerw::after{content:"";position:absolute;top:-6px;right:-6px;width:16px;height:16px;background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><defs><linearGradient id="premiumV" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23ff6b9d;stop-opacity:1" /><stop offset="30%" style="stop-color:%23c850c0;stop-opacity:1" /><stop offset="70%" style="stop-color:%237c4dff;stop-opacity:1" /><stop offset="100%" style="stop-color:%234158d0;stop-opacity:1" /></linearGradient></defs><text x="8" y="12" text-anchor="middle" fill="url(%23premiumV)" font-family="Georgia,serif" font-size="12" font-weight="bold" stroke="%23ffffff" stroke-width="0.4">V</text></svg>');background-size:contain;background-repeat:no-repeat;background-position:center;z-index:10001 !important;pointer-events:none;filter:drop-shadow(0 1px 3px rgba(0, 0, 0, 0.4));transition:all 0.2s ease}.toolbar-button.vip-premium.svelte-13uxerw:hover::after{transform:scale(1.2);filter:drop-shadow(0 2px 6px rgba(200, 80, 192, 0.6))}@media(max-width: 768px){.vertical-toolbar.svelte-13uxerw{bottom:12px;padding:6px 10px;margin-bottom:max(0px, env(safe-area-inset-bottom, 0px));gap:4px}.toolbar-section.svelte-13uxerw{gap:3px}.toolbar-divider.svelte-13uxerw{margin:0 3px;height:20px}.toolbar-button.svelte-13uxerw{width:32px;height:32px}}@media(max-width: 480px){.vertical-toolbar.svelte-13uxerw{bottom:10px;max-width:95vw;overflow-x:auto;scrollbar-width:none}.vertical-toolbar.svelte-13uxerw::-webkit-scrollbar{display:none}.toolbar-button.svelte-13uxerw{width:30px;height:30px;flex-shrink:0}}`)}function Oo(r){let e,t,n,i,o,s,a,l,c,d,u,h,f,p,w,b,m,E,M,y,I,L,T,q,N,K,Z,ne,de,we,Y,ae,ie,le,$,Le,fe,oe,me,Ge;return{c(){e=C("div"),t=C("div"),n=C("button"),a=R(),l=C("div"),c=R(),d=C("div"),u=C("button"),h=R(),f=C("button"),p=R(),w=C("div"),b=R(),m=C("div"),E=C("button"),y=R(),I=C("button"),T=R(),q=C("div"),N=R(),K=C("div"),Z=C("button"),we=R(),Y=C("button"),le=R(),$=C("div"),Le=R(),fe=C("div"),oe=C("button"),g(n,"class","toolbar-button svelte-13uxerw"),n.disabled=i=!r[3],g(n,"title",o=r[3]?"\u5FEB\u901F\u5207\u6362\u6587\u4EF6 (Ctrl/Cmd+O)":"\u5FEB\u901F\u5207\u6362\u6587\u4EF6 (\u9700\u8981\u4E13\u4E1A\u7248)"),g(n,"aria-label",s=r[3]?"\u5FEB\u901F\u5207\u6362\u6587\u4EF6":"\u5FEB\u901F\u5207\u6362\u6587\u4EF6 (\u9700\u8981\u4E13\u4E1A\u7248)"),j(n,"disabled",!r[3]),j(n,"vip-gold",!r[3]),g(t,"class","toolbar-section svelte-13uxerw"),g(l,"class","toolbar-divider svelte-13uxerw"),g(u,"class","toolbar-button svelte-13uxerw"),g(u,"title","\u641C\u7D22 (Ctrl/Cmd+F/K)"),g(u,"aria-label","\u641C\u7D22"),j(u,"active",r[1]),g(f,"class","toolbar-button svelte-13uxerw"),g(f,"title","\u5FEB\u6377\u952E\u63D0\u793A (K)"),g(f,"aria-label","\u5FEB\u6377\u952E\u63D0\u793A"),g(d,"class","toolbar-section svelte-13uxerw"),g(w,"class","toolbar-divider svelte-13uxerw"),g(E,"class","toolbar-button svelte-13uxerw"),E.disabled=M=!r[12],g(E,"title","\u64A4\u9500 (Ctrl/Cmd+Z)"),g(E,"aria-label","\u64A4\u9500"),g(I,"class","toolbar-button svelte-13uxerw"),I.disabled=L=!r[13],g(I,"title","\u91CD\u505A (Ctrl/Cmd+Y)"),g(I,"aria-label","\u91CD\u505A"),g(m,"class","toolbar-section svelte-13uxerw"),g(q,"class","toolbar-divider svelte-13uxerw"),g(Z,"class","toolbar-button svelte-13uxerw"),Z.disabled=ne=!r[3]||r[14]>=5,g(Z,"aria-label",de=r[3]?"\u589E\u52A0\u5C42\u7EA7":"\u589E\u52A0\u5C42\u7EA7 (\u9700\u8981\u4E13\u4E1A\u7248)"),j(Z,"disabled",!r[3]),j(Z,"vip-premium",!r[3]),g(Y,"class","toolbar-button svelte-13uxerw"),Y.disabled=ae=!r[3]||r[14]<=1,g(Y,"aria-label",ie=r[3]?"\u51CF\u5C11\u5C42\u7EA7":"\u51CF\u5C11\u5C42\u7EA7 (\u9700\u8981\u4E13\u4E1A\u7248)"),j(Y,"disabled",!r[3]),j(Y,"vip-premium",!r[3]),g(K,"class","toolbar-section svelte-13uxerw"),g($,"class","toolbar-divider svelte-13uxerw"),g(oe,"class","toolbar-button svelte-13uxerw"),g(oe,"title","\u8BBE\u7F6E"),g(oe,"aria-label","\u8BBE\u7F6E"),g(fe,"class","toolbar-section svelte-13uxerw"),g(e,"class","vertical-toolbar svelte-13uxerw")},m(De,te){P(De,e,te),_(e,t),_(t,n),r[28](n),_(e,a),_(e,l),_(e,c),_(e,d),_(d,u),r[29](u),_(d,h),_(d,f),r[30](f),_(e,p),_(e,w),_(e,b),_(e,m),_(m,E),r[31](E),_(m,y),_(m,I),r[32](I),_(e,T),_(e,q),_(e,N),_(e,K),_(K,Z),r[33](Z),_(K,we),_(K,Y),r[34](Y),_(e,le),_(e,$),_(e,Le),_(e,fe),_(fe,oe),r[35](oe),me||(Ge=[B(n,"click",r[21]),B(u,"click",r[19]),B(f,"click",function(){Fe(r[2])&&r[2].apply(this,arguments)}),B(E,"click",r[15]),B(I,"click",r[16]),B(Z,"click",r[17]),B(Y,"click",r[18]),B(oe,"click",r[20])],me=!0)},p(De,te){r=De,te[0]&8&&i!==(i=!r[3])&&(n.disabled=i),te[0]&8&&o!==(o=r[3]?"\u5FEB\u901F\u5207\u6362\u6587\u4EF6 (Ctrl/Cmd+O)":"\u5FEB\u901F\u5207\u6362\u6587\u4EF6 (\u9700\u8981\u4E13\u4E1A\u7248)")&&g(n,"title",o),te[0]&8&&s!==(s=r[3]?"\u5FEB\u901F\u5207\u6362\u6587\u4EF6":"\u5FEB\u901F\u5207\u6362\u6587\u4EF6 (\u9700\u8981\u4E13\u4E1A\u7248)")&&g(n,"aria-label",s),te[0]&8&&j(n,"disabled",!r[3]),te[0]&8&&j(n,"vip-gold",!r[3]),te[0]&2&&j(u,"active",r[1]),te[0]&4096&&M!==(M=!r[12])&&(E.disabled=M),te[0]&8192&&L!==(L=!r[13])&&(I.disabled=L),te[0]&16392&&ne!==(ne=!r[3]||r[14]>=5)&&(Z.disabled=ne),te[0]&8&&de!==(de=r[3]?"\u589E\u52A0\u5C42\u7EA7":"\u589E\u52A0\u5C42\u7EA7 (\u9700\u8981\u4E13\u4E1A\u7248)")&&g(Z,"aria-label",de),te[0]&8&&j(Z,"disabled",!r[3]),te[0]&8&&j(Z,"vip-premium",!r[3]),te[0]&16392&&ae!==(ae=!r[3]||r[14]<=1)&&(Y.disabled=ae),te[0]&8&&ie!==(ie=r[3]?"\u51CF\u5C11\u5C42\u7EA7":"\u51CF\u5C11\u5C42\u7EA7 (\u9700\u8981\u4E13\u4E1A\u7248)")&&g(Y,"aria-label",ie),te[0]&8&&j(Y,"disabled",!r[3]),te[0]&8&&j(Y,"vip-premium",!r[3])},i:J,o:J,d(De){De&&O(e),r[28](null),r[29](null),r[30](null),r[31](null),r[32](null),r[33](null),r[34](null),r[35](null),me=!1,ce(Ge)}}}var Ro=500;function zo(r,e,t){let n,i,o=J,s=()=>(o(),o=st(l,x=>t(27,i=x)),l);r.$$.on_destroy.push(()=>o());let{View:a}=e,{flexStore:l}=e;s();let{increase:c}=e,{decrease:d}=e,{showSearch:u}=e,{openSearch:h}=e,{closeSearch:f}=e,{toggleShortcuts:p}=e,{proStatus:w=!1}=e,b,m,E,M,y,I,L,T,q=!1,N=!1,K=[],Z=null,ne=0;function de(){let x=Date.now();return Z&&x<ne||(Z=a.app.workspace.getActiveViewOfType(Qe.MarkdownView),ne=x+Ro),Z}function we(x){var v;try{let S=de();if(!(!((v=S==null?void 0:S.editor)===null||v===void 0)&&v.cm)||!(x!=null&&x.changes))return!1;let V=null;if(x.changes.iterChanges(U=>{V===null&&(V=U)}),V===null)return!1;let G=S.editor.cm.state.doc.lineAt(V).number,xe=a.containerEl;if(!xe)return!1;let se=xe.querySelectorAll("[data-node-id]");for(let U=0;U<se.length;U++){let ee=se[U],pe=ee.getAttribute("data-start-line"),he=ee.getAttribute("data-end-line");if(pe&&he){let Ve=parseInt(pe),Xe=parseInt(he);if(G>=Ve&&G<=Xe){let je=ee.getBoundingClientRect(),vt=window.innerHeight,nn=je.top>=0&&je.bottom<=vt,ki=je.top<vt&&je.bottom>0;if(nn)return!0;if(ki){let Ei=Math.min(je.bottom,vt)-Math.max(je.top,0),Ci=je.bottom-je.top;if(Ei/Ci>.7)return!0}return ee.scrollIntoView({behavior:"smooth",block:"center"}),!0}}}let _e=null,ve=1/0;for(let U=0;U<se.length;U++){let ee=se[U],pe=ee.getAttribute("data-start-line");if(pe){let he=parseInt(pe),Ve=Math.abs(G-he);Ve<ve&&(ve=Ve,_e=ee)}}if(_e){let U=_e.getBoundingClientRect(),ee=window.innerHeight,pe=U.top>=0&&U.bottom<=ee,he=U.top<ee&&U.bottom>0;if(pe)return!0;if(he){let Ve=Math.min(U.bottom,ee)-Math.max(U.top,0),Xe=U.bottom-U.top;if(Ve/Xe>.7)return!0}return _e.scrollIntoView({behavior:"smooth",block:"center"}),!0}return!1}catch(S){return console.error("[\u6EDA\u52A8] \u9519\u8BEF:",S),!1}}function Y(){var x;let v=de();if(!((x=v==null?void 0:v.editor)===null||x===void 0)&&x.cm)try{let S=v.editor.cm.state.field(hi.historyField);S&&(t(12,q=S.done&&S.done.length>0),t(13,N=S.undone&&S.undone.length>0))}catch(S){console.error("\u66F4\u65B0\u5386\u53F2\u72B6\u6001\u5931\u8D25:",S),t(12,q=!1),t(13,N=!1)}}function ae(){var x;let v=de();if(!(!((x=v==null?void 0:v.editor)===null||x===void 0)&&x.cm)){ie();return}try{let S=v.editor.cm.dom;if(S){let V=()=>{queueMicrotask(Y)},z=()=>{queueMicrotask(Y)};S.addEventListener("input",V),S.addEventListener("keyup",z),S.addEventListener("change",V);let Q=a.app.vault.on("modify",G=>{G&&a.file&&G.path===a.file.path&&queueMicrotask(Y)});K.push(()=>{S.removeEventListener("input",V),S.removeEventListener("keyup",z),S.removeEventListener("change",V),a.app.vault.offref(Q)});return}}catch(S){console.error("\u8BBE\u7F6ECodeMirror\u76D1\u542C\u5668\u5931\u8D25:",S)}ie()}function ie(){try{let x=[],v=a.app.workspace.on("editor-change",()=>{queueMicrotask(Y)});x.push(v);let S=a.app.workspace.on("active-leaf-change",()=>{queueMicrotask(Y)});x.push(S);let V=a.app.vault.on("modify",z=>{z&&a.file&&z.path===a.file.path&&queueMicrotask(Y)});x.push(V),K.push(()=>{x[0]&&a.app.workspace.offref(x[0]),x[1]&&a.app.workspace.offref(x[1]),x[2]&&a.app.vault.offref(x[2])})}catch(x){console.error("\u8BBE\u7F6Eworkspace\u76D1\u542C\u5668\u5931\u8D25:",x);let v=setInterval(Y,2e3);K.push(()=>clearInterval(v))}}function le(){try{if(typeof MutationObserver!="undefined"){let x=document.querySelector(".gridnote-container");if(!x)return;let v=null,S=new MutationObserver(V=>{V.some(Q=>Q.type==="characterData"?!0:Q.type==="childList"?Array.from(Q.addedNodes).some(G=>{var xe;return G.nodeType===Node.TEXT_NODE&&((xe=G.textContent)===null||xe===void 0?void 0:xe.trim())}):!1)&&(v&&clearTimeout(v),v=setTimeout(()=>Y(),100))});S.observe(x,{characterData:!0,childList:!0,subtree:!1}),K.push(()=>{S.disconnect(),v&&clearTimeout(v)})}}catch(x){console.error("\u8BBE\u7F6EGridNote\u5185\u5BB9\u76D1\u542C\u5668\u5931\u8D25:",x)}}Pe(()=>{b&&(0,Qe.setIcon)(b,"folder-open"),m&&(0,Qe.setIcon)(m,"undo"),E&&(0,Qe.setIcon)(E,"redo"),M&&(0,Qe.setIcon)(M,"plus"),y&&(0,Qe.setIcon)(y,"minus"),I&&(0,Qe.setIcon)(I,"search"),L&&(0,Qe.setIcon)(L,"keyboard"),T&&(0,Qe.setIcon)(T,"settings");let x=a.app.workspace.on("active-leaf-change",()=>{Z=null,ne=0});K.push(()=>{a.app.workspace.offref(x)}),Y(),ae(),le()}),Ke(()=>{K.forEach(x=>{try{x()}catch(v){console.error("\u6E05\u7406\u76D1\u542C\u5668\u5931\u8D25:",v)}}),K=[]});function $(){if(a!=null&&a.editor)try{let x=a.editor.getValue();a.editor.undo(),queueMicrotask(Y),queueMicrotask(()=>{if(a&&a.editor){let v=a.editor.getValue();a.render(v),a.recalculateFoldStates&&a.recalculateFoldStates(x,v)}})}catch(x){console.error("\u64A4\u9500\u64CD\u4F5C\u5931\u8D25:",x)}}function Le(){if(a!=null&&a.editor)try{let x=a.editor.getValue();a.editor.redo(),queueMicrotask(Y),queueMicrotask(()=>{if(a&&a.editor){let v=a.editor.getValue();a.render(v),a.recalculateFoldStates&&a.recalculateFoldStates(x,v)}})}catch(x){console.error("\u91CD\u505A\u64CD\u4F5C\u5931\u8D25:",x)}}function fe(){w&&c()}function oe(){w&&d()}function me(){u?f():h()}function Ge(){a.app.setting.open(),queueMicrotask(()=>{a.app.setting.openTabById(a.plugin.manifest.id)})}function De(){w&&a.app.commands.executeCommandById("switcher:open")}function te(x){re[x?"unshift":"push"](()=>{b=x,t(4,b)})}function it(x){re[x?"unshift":"push"](()=>{I=x,t(9,I)})}function A(x){re[x?"unshift":"push"](()=>{L=x,t(10,L)})}function X(x){re[x?"unshift":"push"](()=>{m=x,t(5,m)})}function ye(x){re[x?"unshift":"push"](()=>{E=x,t(6,E)})}function F(x){re[x?"unshift":"push"](()=>{M=x,t(7,M)})}function k(x){re[x?"unshift":"push"](()=>{y=x,t(8,y)})}function H(x){re[x?"unshift":"push"](()=>{T=x,t(11,T)})}return r.$$set=x=>{"View"in x&&t(22,a=x.View),"flexStore"in x&&s(t(0,l=x.flexStore)),"increase"in x&&t(23,c=x.increase),"decrease"in x&&t(24,d=x.decrease),"showSearch"in x&&t(1,u=x.showSearch),"openSearch"in x&&t(25,h=x.openSearch),"closeSearch"in x&&t(26,f=x.closeSearch),"toggleShortcuts"in x&&t(2,p=x.toggleShortcuts),"proStatus"in x&&t(3,w=x.proStatus)},r.$$.update=()=>{if(r.$$.dirty[0]&134217728){e:t(14,n=i.tier)}},[l,u,p,w,b,m,E,M,y,I,L,T,q,N,n,$,Le,fe,oe,me,Ge,De,a,c,d,h,f,i,te,it,A,X,ye,F,k,H]}var er=class extends ge{constructor(e){super(),Me(this,e,zo,Oo,be,{View:22,flexStore:0,increase:23,decrease:24,showSearch:1,openSearch:25,closeSearch:26,toggleShortcuts:2,proStatus:3},Do,[-1,-1])}},pi=er;function Po(r){ke(r,"svelte-1y46ihy",'@charset "UTF-8";.shortcuts-backdrop.svelte-1y46ihy.svelte-1y46ihy{position:fixed;top:0;left:0;right:0;bottom:0;background:transparent;display:flex;align-items:flex-end;justify-content:center;z-index:9999;padding:16px;pointer-events:auto}.shortcuts-card.svelte-1y46ihy.svelte-1y46ihy{background:var(--background-primary);border-radius:12px;box-shadow:0 8px 32px rgba(0, 0, 0, 0.3);backdrop-filter:blur(16px);border:1px solid var(--background-modifier-border);max-width:700px;width:100%;max-height:70vh;display:flex;flex-direction:column;overflow:hidden;pointer-events:auto}.shortcuts-header.svelte-1y46ihy.svelte-1y46ihy{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-bottom:1px solid var(--background-modifier-border);background:var(--background-secondary)}.shortcuts-header.svelte-1y46ihy h3.svelte-1y46ihy{margin:0;font-size:18px;font-weight:600;color:var(--text-normal)}.close-btn.svelte-1y46ihy.svelte-1y46ihy{background:none;border:none;cursor:pointer;padding:4px;display:flex;align-items:center;justify-content:center;color:var(--text-muted);transition:color 0.2s ease}.close-btn.svelte-1y46ihy.svelte-1y46ihy:hover{color:var(--text-normal)}.close-btn.svelte-1y46ihy svg.svelte-1y46ihy{width:20px;height:20px}.shortcuts-content.svelte-1y46ihy.svelte-1y46ihy{flex:1;overflow-y:auto;padding:12px 16px}.shortcut-category.svelte-1y46ihy.svelte-1y46ihy{margin-bottom:16px}.shortcut-category.svelte-1y46ihy.svelte-1y46ihy:last-child{margin-bottom:0}.shortcut-category.svelte-1y46ihy h4.svelte-1y46ihy{margin:0 0 8px 0;font-size:13px;font-weight:600;color:var(--text-accent);text-transform:uppercase;letter-spacing:0.5px}.shortcut-list.svelte-1y46ihy.svelte-1y46ihy{display:flex;flex-direction:column;gap:4px}.shortcut-list.grid-layout.svelte-1y46ihy.svelte-1y46ihy{display:grid;grid-template-columns:repeat(2, 1fr);gap:6px}.shortcut-item.svelte-1y46ihy.svelte-1y46ihy{display:flex;align-items:center;gap:10px;padding:6px 10px;background:var(--background-secondary);border-radius:4px;transition:background 0.2s ease}.shortcut-item.svelte-1y46ihy.svelte-1y46ihy:hover{background:var(--background-modifier-hover)}.shortcut-key.svelte-1y46ihy.svelte-1y46ihy{font-family:var(--font-monospace);font-size:13px;padding:3px 8px;background:var(--background-primary);border:1px solid var(--background-modifier-border);border-radius:3px;color:var(--text-normal);min-width:90px;text-align:center;box-shadow:0 1px 2px rgba(0, 0, 0, 0.1);font-weight:500;white-space:nowrap}.shortcut-description.svelte-1y46ihy.svelte-1y46ihy{flex:1;font-size:13px;color:var(--text-muted);line-height:1.4}.shortcuts-footer.svelte-1y46ihy.svelte-1y46ihy{padding:10px 16px;border-top:1px solid var(--background-modifier-border);background:var(--background-secondary);display:flex;justify-content:center}.hint.svelte-1y46ihy.svelte-1y46ihy{font-size:12px;color:var(--text-faint);font-style:italic}.shortcuts-content.svelte-1y46ihy.svelte-1y46ihy::-webkit-scrollbar{width:8px}.shortcuts-content.svelte-1y46ihy.svelte-1y46ihy::-webkit-scrollbar-track{background:var(--background-primary)}.shortcuts-content.svelte-1y46ihy.svelte-1y46ihy::-webkit-scrollbar-thumb{background:var(--background-modifier-border);border-radius:4px}.shortcuts-content.svelte-1y46ihy.svelte-1y46ihy::-webkit-scrollbar-thumb:hover{background:var(--background-modifier-border-hover)}')}function gi(r,e,t){let n=r.slice();return n[5]=e[t].category,n[6]=e[t].items,n[7]=e[t].grid,n}function mi(r,e,t){let n=r.slice();return n[10]=e[t].key,n[11]=e[t].description,n}function vi(r){let e,t,n,i,o,s,a,l,c,d,u,h,f,p,w,b=Re(r[2]),m=[];for(let E=0;E<b.length;E+=1)m[E]=wi(gi(r,b,E));return{c(){e=C("div"),t=C("div"),n=C("div"),i=C("h3"),i.textContent="\u5FEB\u6377\u952E\u63D0\u793A",o=R(),s=C("button"),s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svelte-1y46ihy"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',a=R(),l=C("div");for(let E=0;E<m.length;E+=1)m[E].c();c=R(),d=C("div"),d.innerHTML='<span class="hint svelte-1y46ihy">\u6309 K \u952E\u6216 Esc \u952E\u5173\u95ED</span>',g(i,"id","shortcuts-title"),g(i,"class","svelte-1y46ihy"),g(s,"class","close-btn svelte-1y46ihy"),g(s,"aria-label","\u5173\u95ED"),g(n,"class","shortcuts-header svelte-1y46ihy"),g(l,"class","shortcuts-content svelte-1y46ihy"),g(d,"class","shortcuts-footer svelte-1y46ihy"),g(t,"class","shortcuts-card svelte-1y46ihy"),g(t,"role","dialog"),g(t,"aria-modal","true"),g(t,"aria-labelledby","shortcuts-title"),g(e,"class","shortcuts-backdrop svelte-1y46ihy")},m(E,M){P(E,e,M),_(e,t),_(t,n),_(n,i),_(n,o),_(n,s),_(t,a),_(t,l);for(let y=0;y<m.length;y+=1)m[y]&&m[y].m(l,null);_(t,c),_(t,d),f=!0,p||(w=[B(s,"click",function(){Fe(r[1])&&r[1].apply(this,arguments)}),B(e,"click",r[3]),B(e,"keydown",r[4])],p=!0)},p(E,M){if(r=E,M&4){b=Re(r[2]);let y;for(y=0;y<b.length;y+=1){let I=gi(r,b,y);m[y]?m[y].p(I,M):(m[y]=wi(I),m[y].c(),m[y].m(l,null))}for(;y<m.length;y+=1)m[y].d(1);m.length=b.length}},i(E){f||(E&&Be(()=>{f&&(u||(u=tt(t,Zt,{y:20,duration:300,easing:mt},!0)),u.run(1))}),E&&Be(()=>{f&&(h||(h=tt(e,Xt,{duration:200},!0)),h.run(1))}),f=!0)},o(E){E&&(u||(u=tt(t,Zt,{y:20,duration:300,easing:mt},!1)),u.run(0)),E&&(h||(h=tt(e,Xt,{duration:200},!1)),h.run(0)),f=!1},d(E){E&&O(e),wt(m,E),E&&u&&u.end(),E&&h&&h.end(),p=!1,ce(w)}}}function bi(r){let e,t,n,i,o;return{c(){e=C("div"),t=C("kbd"),t.textContent=`${r[10]}`,n=R(),i=C("span"),i.textContent=`${r[11]}`,o=R(),g(t,"class","shortcut-key svelte-1y46ihy"),g(i,"class","shortcut-description svelte-1y46ihy"),g(e,"class","shortcut-item svelte-1y46ihy")},m(s,a){P(s,e,a),_(e,t),_(e,n),_(e,i),_(e,o)},p:J,d(s){s&&O(e)}}}function wi(r){let e,t,n,i,o,s=Re(r[6]),a=[];for(let l=0;l<s.length;l+=1)a[l]=bi(mi(r,s,l));return{c(){e=C("div"),t=C("h4"),t.textContent=`${r[5]}`,n=R(),i=C("div");for(let l=0;l<a.length;l+=1)a[l].c();o=R(),g(t,"class","svelte-1y46ihy"),g(i,"class","shortcut-list svelte-1y46ihy"),j(i,"grid-layout",r[7]),g(e,"class","shortcut-category svelte-1y46ihy")},m(l,c){P(l,e,c),_(e,t),_(e,n),_(e,i);for(let d=0;d<a.length;d+=1)a[d]&&a[d].m(i,null);_(e,o)},p(l,c){if(c&4){s=Re(l[6]);let d;for(d=0;d<s.length;d+=1){let u=mi(l,s,d);a[d]?a[d].p(u,c):(a[d]=bi(u),a[d].c(),a[d].m(i,null))}for(;d<a.length;d+=1)a[d].d(1);a.length=s.length}},d(l){l&&O(e),wt(a,l)}}}function Bo(r){let e,t=r[0]&&vi(r);return{c(){t&&t.c(),e=ut()},m(n,i){t&&t.m(n,i),P(n,e,i)},p(n,[i]){n[0]?t?(t.p(n,i),i&1&&D(t,1)):(t=vi(n),t.c(),D(t,1),t.m(e.parentNode,e)):t&&(Ie(),W(t,1,1,()=>{t=null}),Te())},i(n){D(t)},o(n){W(t)},d(n){n&&O(e),t&&t.d(n)}}}function Wo(r,e,t){let{show:n=!1}=e,{onClose:i}=e,o=[{category:"\u5BFC\u822A\uFF08\u4E00\u7EA7\u6807\u9898\uFF09",grid:!0,items:[{key:"\u2191",description:"\u4E0A\u4E00\u4E2A\u4E00\u7EA7\u6807\u9898"},{key:"\u2193",description:"\u5B50\u7EA7/\u4E0B\u4E00\u4E2A\u4E00\u7EA7"}]},{category:"\u5BFC\u822A\uFF08\u4E8C\u7EA7\u6807\u9898\uFF09",grid:!0,items:[{key:"\u2191",description:"\u4E0A\u4E00\u4E2A\u540C\u7EA7"},{key:"\u2193",description:"\u4E0B\u4E00\u4E2A\u540C\u7EA7"},{key:"\u2192",description:"\u7B2C\u4E00\u4E2A\u5B50\u7EA7"}]},{category:"\u5BFC\u822A\uFF083-6\u7EA7\u6807\u9898\uFF09",grid:!0,items:[{key:"\u2191",description:"\u4E0A\u4E00\u4E2A\u540C\u7EA7"},{key:"\u2193",description:"\u4E0B\u4E00\u4E2A\u540C\u7EA7"},{key:"\u2190",description:"\u7236\u7EA7\u6807\u9898"},{key:"\u2192",description:"\u7B2C\u4E00\u4E2A\u5B50\u7EA7"}]},{category:"\u9009\u4E2D",items:[{key:"F",description:"\u9009\u4E2D\u7B2C\u4E00\u4E2A\u53EF\u89C1\u6807\u9898"},{key:"Esc",description:"\u53D6\u6D88\u9009\u4E2D"}]},{category:"\u7F16\u8F91",items:[{key:"F",description:"\u7F16\u8F91\u5185\u5BB9\uFF08\u5DF2\u9009\u4E2D\u65F6\uFF09"},{key:"T",description:"\u7F16\u8F91\u6807\u9898"},{key:"Esc",description:"\u9000\u51FA\u7F16\u8F91/\u641C\u7D22"}]},{category:"\u63D2\u5165\uFF08\u975E\u4E00\u7EA7\u6807\u9898\uFF09",items:[{key:"Ctrl+Shift+\u2191",description:"\u4E0A\u65B9\u63D2\u5165\u540C\u7EA7"},{key:"Ctrl+Shift+\u2193",description:"\u4E0B\u65B9\u63D2\u5165\u540C\u7EA7"},{key:"Ctrl+Shift+\u2192",description:"\u63D2\u5165\u5B50\u7EA7"}]},{category:"\u641C\u7D22",items:[{key:"Ctrl/Cmd+F/K",description:"\u6253\u5F00\u641C\u7D22"},{key:"K",description:"\u663E\u793A/\u9690\u85CF\u6B64\u63D0\u793A"}]}];function s(l){l.target===l.currentTarget&&i()}let a=l=>l.key==="Escape"&&i();return r.$$set=l=>{"show"in l&&t(0,n=l.show),"onClose"in l&&t(1,i=l.onClose)},[n,i,o,s,a]}var tr=class extends ge{constructor(e){super(),Me(this,e,Wo,Bo,be,{show:0,onClose:1},Po)}},yi=tr;function qo(){let r=navigator.userAgent.toLowerCase(),e=window.innerWidth,t=window.innerHeight,n=/ipad/.test(r)||navigator.maxTouchPoints>1&&/macintosh/.test(r)||e>=1024&&e<=1800,i=n&&e>=1020&&e<=1030,o=n||/tablet|android(?!.*mobile)/.test(r)||e>=768&&e<1024;return{isMobile:/android|webos|iphone|ipod|blackberry|iemobile|opera mini/.test(r)||e<768&&"ontouchstart"in window,isTablet:o,isIPad:n,isIPadMini:i,screenWidth:e,screenHeight:t}}function Go(r){let{screenWidth:e,isIPad:t,isIPadMini:n}=r;return t?n?.7:e<1150?.85:e<1300?.9:.95:r.isTablet?e<800?.8:e<1e3?.85:.9:r.isMobile?e<375?.7:e<480?.75:.8:1}function xi(r){let e=()=>{let i=qo(),o=Go(i);r(o,i)};e();let t,n=()=>{clearTimeout(t),t=window.setTimeout(e,150)};return window.addEventListener("resize",n),window.addEventListener("orientationchange",e),()=>{window.removeEventListener("resize",n),window.removeEventListener("orientationchange",e),clearTimeout(t)}}function jo(r){ke(r,"svelte-ut93o5",'@charset "UTF-8";.container.svelte-ut93o5{padding-bottom:300px;position:relative;height:100%;width:100%;overflow-y:auto;overflow-x:hidden}.container.integrated-view.svelte-ut93o5{height:calc(100vh - 100px)}.content-wrapper.svelte-ut93o5{width:100%;position:relative;overflow:visible}.content-wrapper.mobile-scaled.svelte-ut93o5{pointer-events:none}.content-scaler.svelte-ut93o5{width:100%;transition:transform 0.3s ease;transform-origin:top left;pointer-events:auto}.content-scaler.scaled.svelte-ut93o5{touch-action:manipulation;user-select:auto;-webkit-user-select:auto}.content-scaler.scaled.svelte-ut93o5 *{pointer-events:auto !important;touch-action:manipulation !important}.search-float.svelte-ut93o5{position:sticky;top:0;z-index:1000;background:var(--background-primary);padding:8px 0;box-shadow:0 2px 12px rgba(0, 0, 0, 0.15);border-bottom:1px solid var(--background-modifier-border);margin-bottom:12px;border-radius:0 0 8px 8px;backdrop-filter:blur(8px);display:flex;justify-content:center}.search-float.svelte-ut93o5 .search-component{width:600px;max-width:90%}')}function _i(r){let e,t,n,i;function o(a){r[28](a)}let s={searchKeyword:r[14],searchIndex:r[15],searchCount:r[16]};return r[8]!==void 0&&(s.inputEl=r[8]),t=new fi({props:s}),re.push(()=>Vr(t,"inputEl",o)),t.$on("exit",r[20]),{c(){e=C("div"),Ae(t.$$.fragment),g(e,"class","search-float svelte-ut93o5")},m(a,l){P(a,e,l),Ce(t,e,null),i=!0},p(a,l){let c={};!n&&l[0]&256&&(n=!0,c.inputEl=a[8],Lr(()=>n=!1)),t.$set(c)},i(a){i||(D(t.$$.fragment,a),i=!0)},o(a){W(t.$$.fragment,a),i=!1},d(a){a&&O(e),Se(t)}}}function Ko(r){let e,t,n,i,o,s,a,l,c,d,u,h=r[7]&&_i(r);return n=new pi({props:{View:r[0],flexStore:r[3],increase:r[4],decrease:r[5],showSearch:r[7],openSearch:r[19],closeSearch:r[20],toggleShortcuts:r[21],proStatus:r[11]}}),o=new yi({props:{show:r[9],onClose:r[22]}}),d=new bn({props:{currentLines:r[12],nodes:r[10],tier:Yo,searchKeyword:r[14],searchIndex:r[15],allHighlights:r[17]}}),{c(){e=C("div"),h&&h.c(),t=R(),Ae(n.$$.fragment),i=R(),Ae(o.$$.fragment),s=R(),a=C("div"),l=C("div"),c=C("div"),Ae(d.$$.fragment),ue(c,"padding","20px"),g(l,"class","content-scaler svelte-ut93o5"),ue(l,"transform","scale(var(--scale-factor))"),ue(l,"transform-origin","top left"),ue(l,"width",r[6]<1?100/r[6]+"%":"100%"),j(l,"scaled",r[6]<1),g(a,"class","content-wrapper svelte-ut93o5"),ue(a,"--scale-factor",r[6]),j(a,"mobile-scaled",r[6]<1),g(e,"class","container svelte-ut93o5"),j(e,"integrated-view",r[1])},m(f,p){P(f,e,p),h&&h.m(e,null),_(e,t),Ce(n,e,null),_(e,i),Ce(o,e,null),_(e,s),_(e,a),_(a,l),_(l,c),Ce(d,c,null),u=!0},p(f,p){f[7]?h?(h.p(f,p),p[0]&128&&D(h,1)):(h=_i(f),h.c(),D(h,1),h.m(e,t)):h&&(Ie(),W(h,1,1,()=>{h=null}),Te());let w={};p[0]&1&&(w.View=f[0]),p[0]&128&&(w.showSearch=f[7]),p[0]&2048&&(w.proStatus=f[11]),n.$set(w);let b={};p[0]&512&&(b.show=f[9]),o.$set(b);let m={};p[0]&4096&&(m.currentLines=f[12]),p[0]&1024&&(m.nodes=f[10]),d.$set(m),(!u||p[0]&64)&&ue(l,"width",f[6]<1?100/f[6]+"%":"100%"),(!u||p[0]&64)&&j(l,"scaled",f[6]<1),(!u||p[0]&64)&&ue(a,"--scale-factor",f[6]),(!u||p[0]&64)&&j(a,"mobile-scaled",f[6]<1),(!u||p[0]&2)&&j(e,"integrated-view",f[1])},i(f){u||(D(h),D(n.$$.fragment,f),D(o.$$.fragment,f),D(d.$$.fragment,f),u=!0)},o(f){W(h),W(n.$$.fragment,f),W(o.$$.fragment,f),W(d.$$.fragment,f),u=!1},d(f){f&&O(e),h&&h.d(),Se(n),Se(o),Se(d)}}}var Uo=100,Yo=0;function Jo(r,e,t){let n,i,o,s,a,l=J,c=()=>(l(),l=st(f,A=>t(12,a=A)),f);r.$$.on_destroy.push(()=>l());let{View:d}=e,{root:u}=e,{isIntegratedView:h=!1}=e,f=He(-1);c();let p=He(!1);at(r,p,A=>t(11,s=A));let w=1,b=null,m=!1,E=0;Pe(()=>{let A=d==null?void 0:d.app.workspace.on("gridnote-setting-changed",(ye,F)=>{if(ye==="proStatus"){t(26,E=0);let k=d.ProStatus,H=Boolean(k);H!==m&&(t(25,m=H),p.set(H))}}),X=xi((ye,F)=>{t(6,w=ye),b=F});return()=>{A&&(d==null||d.app.workspace.offref(A)),X()}});let M=He(""),y=He(0),I=He(0),L=He([]);at(r,L,A=>t(27,i=A));let T=He(null);at(r,T,A=>t(30,o=A));let q=He(null),N=He(null),K=He(null),Z=new Map([["1",[0,1,1]],["2",[0,1,1,1]],["3",[0,1,2,1,1]],["4",[0,1,3,2,1,1]],["5",[0,1,4,3,2,1,1]]]),ne=He({tier:3,flex:[0,1,2,1,1]});pt("flexStore",ne),pt("selectedNodeLine",T),pt("editTrigger",q),pt("insertTrigger",N),pt("editHeaderTrigger",K);function de(A){ne.update(X=>(X.tier=A,X.flex=Z.get(String(X.tier+1)),X))}function we(){ne.update(A=>(A.tier>=5||(A.tier++,A.flex=Z.get(String(A.tier))),A))}function Y(){ne.update(A=>(A.tier<=1||(A.tier--,A.flex=Z.get(String(A.tier))),A))}pt("View",d);let ae=d.Level.flex,ie=!1,le=null,$=!1;function Le(){t(7,ie=!0),queueMicrotask(()=>{le==null||le.focus()})}function fe(){t(7,ie=!1),queueMicrotask(()=>{M.set(""),L.update(A=>(A.forEach(X=>X.classList.remove("search-highlight")),[]))})}function oe(){t(9,$=!$)}function me(){t(9,$=!1)}function Ge(){function A(F){let k=F.getBoundingClientRect(),H=window.innerHeight||document.documentElement.clientHeight,x=window.innerWidth||document.documentElement.clientWidth,v=k.top>=0&&k.top<H||k.bottom>0&&k.bottom<=H||k.top<0&&k.bottom>H,S=k.left>=0&&k.left<x||k.right>0&&k.right<=x||k.left<0&&k.right>x;return v&&S}let X=[],ye=document.querySelectorAll("[data-start-line][data-node-level]");for(let F of Array.from(ye)){let k=parseInt(F.getAttribute("data-start-line")||"0");if(A(F)&&k>0){let H=F.getBoundingClientRect();X.push({element:F,top:H.top,startLine:k})}}if(X.length>0){X.sort((x,v)=>x.top-v.top);let F=X[0];T.set(F.startLine);let k=F.element.getBoundingClientRect();k.top>=0&&k.bottom<=window.innerHeight||setTimeout(()=>{F.element.scrollIntoView({behavior:"smooth",block:"center"})},50)}}function De(A){let X=document.activeElement,ye=X&&(X.tagName==="INPUT"||X.tagName==="TEXTAREA"||X.isContentEditable);if((A.key==="k"||A.key==="K")&&!ye){A.preventDefault(),oe();return}if(A.key==="Escape"&&!ye&&o!==null){A.preventDefault(),T.set(null);return}if((A.key==="f"||A.key==="F")&&!ye&&o===null){A.preventDefault(),Ge();return}if(o===null||ye)return;if(A.key==="f"||A.key==="F"){A.preventDefault(),q.set(o);return}if(A.key==="t"||A.key==="T"){A.preventDefault(),K.set(o);return}let F=ur(u);if(F.length===0)return;let k=F.find(v=>v.line===o);if(!k)return;let H=k.level===1;if((A.ctrlKey||A.metaKey)&&A.shiftKey&&!H){let v=null;switch(A.key){case"ArrowUp":v="before";break;case"ArrowDown":v="after";break;case"ArrowRight":v="child";break}if(v){A.preventDefault(),N.set({line:o,position:v});return}}let x=null;if(H)switch(A.key){case"ArrowUp":x=Mn(F,k.line,k.level);break;case"ArrowDown":x=In(F,k.line,k.level),x===null&&(x=Ln(F,k.line,k.level));break;case"ArrowLeft":case"ArrowRight":return;default:return}else switch(A.key){case"ArrowUp":x=Mn(F,k.line,k.level);break;case"ArrowDown":x=Ln(F,k.line,k.level);break;case"ArrowLeft":if(k.level===2)return;x=fr(F,k.line,k.level);break;case"ArrowRight":x=In(F,k.line,k.level);break;default:return}x!==null&&(A.preventDefault(),T.set(x))}Pe(()=>(document.addEventListener("keydown",te),document.addEventListener("keydown",De),()=>{document.removeEventListener("keydown",te),document.removeEventListener("keydown",De)}));function te(A){let X=document.activeElement;X&&(X.tagName==="INPUT"||X.tagName==="TEXTAREA"||X.isContentEditable)||((A.ctrlKey||A.metaKey)&&["f","k"].includes(A.key.toLowerCase())&&(A.preventDefault(),Le()),A.key==="Escape"&&ie&&fe())}function it(A){le=A,t(8,le)}r.$$set=A=>{"View"in A&&t(0,d=A.View),"root"in A&&t(23,u=A.root),"isIntegratedView"in A&&t(1,h=A.isIntegratedView)},r.$$.update=()=>{if(r.$$.dirty[0]&8388608){e:t(10,n=u.filter(A=>!(A.header==="Document"||A.header==="Document Header")))}if(r.$$.dirty[0]&100663297){e:if(d){let A=Date.now();if(A-E>Uo){let X=d.ProStatus,ye=Boolean(X);ye!==m&&(t(25,m=ye),p.set(ye)),t(26,E=A)}}}if(r.$$.dirty[0]&134217728){e:{let A=i.filter(X=>X.isConnected&&X.offsetParent!==null);I.set(A.length)}}};e:M.subscribe(()=>{L.set([])});return[d,h,f,ne,we,Y,w,ie,le,$,n,s,a,p,M,y,I,L,T,Le,fe,oe,me,u,de,m,E,i,it]}var nr=class extends ge{constructor(e){super(),Me(this,e,Jo,Ko,be,{View:0,root:23,isIntegratedView:1,currentLines:2,flexStore:3,setTier:24,increase:4,decrease:5},jo,[-1,-1])}get currentLines(){return this.$$.ctx[2]}get flexStore(){return this.$$.ctx[3]}get setTier(){return this.$$.ctx[24]}get increase(){return this.$$.ctx[4]}get decrease(){return this.$$.ctx[5]}},wn=nr;var yn=class{constructor(){this.tier=3;this._levels=new Map([["1",[0,1,1]],["2",[0,1,1,1]],["3",[0,1,2,1,1]],["4",[0,1,3,2,1,1]],["5",[0,1,4,3,2,1,1]]]);this.increase=()=>{this.tier>=5||this.tier++};this.decrease=()=>{this.tier<=1||this.tier--}}get flex(){return this._levels.get(this.tier.toString())}};var Ot=class{constructor(e){this.foldStates=new Map;this.callbacks=new Map;this.stores=new Map;this.debounceTimers=new Map;this.app=e}static getInstance(e){if(!Ot.instance){if(!e)throw new Error("FoldStateManager requires app instance on first initialization");Ot.instance=new Ot(e)}return Ot.instance}getFolds(e){let t=this.foldStates.get(e);return t?Array.from(t).sort((n,i)=>n-i):[]}setFolds(e,t,n={}){let{silent:i=!1,skipPersist:o=!1,skipStoreUpdate:s=!1,animated:a=!0}=n,l=this.getFolds(e),c=[...t].sort((u,h)=>u-h);(l.length!==c.length||l.some((u,h)=>u!==c[h]))&&(this.foldStates.set(e,new Set(t)),s||this.getStore(e).set(c),o||this.debouncedPersist(e,c),i||this.notifyCallbacks(e,c,a))}toggleFold(e,t){let n=this.getFolds(e),i=new Set(n);i.has(t)?i.delete(t):i.add(t),this.setFolds(e,Array.from(i))}getStore(e){let t=this.stores.get(e);if(!t){let n=this.getFolds(e);t=He(n),this.stores.set(e,t)}return t}recalculateFolds(e,t,n){if(!t||!n)return;let i=this.getFolds(e);if(i.length!==0)try{let o=this.extractHeaders(t),s=this.extractHeaders(n),a=[];i.forEach(l=>{let c=o.find(d=>d.line===l+1);if(c){let d=s.find(u=>u.text===c.text&&u.level===c.level);d&&a.push(d.line-1)}}),this.setFolds(e,a,{animated:!1})}catch(o){console.error("\u91CD\u65B0\u8BA1\u7B97\u6298\u53E0\u72B6\u6001\u65F6\u51FA\u9519:",o)}}loadFromStorage(e){if(this.app)try{let n=`${this.app.appId}-note-fold-${e}`,i=localStorage.getItem(n);if(i){let a=(JSON.parse(i).folds||[]).map(l=>l.from);this.setFolds(e,a,{silent:!0,skipPersist:!0})}}catch(t){console.error("\u4ECE localStorage \u52A0\u8F7D\u6298\u53E0\u72B6\u6001\u5931\u8D25:",t),this.setFolds(e,[],{silent:!0,skipPersist:!0})}}subscribe(e,t,n={}){let i=this.callbacks.get(e);return i||(i=[],this.callbacks.set(e,i)),i.push(t),n.immediate!==!1&&t(this.getFolds(e)),()=>{let o=this.callbacks.get(e);if(o){let s=o.indexOf(t);s>-1&&o.splice(s,1),o.length===0&&this.callbacks.delete(e)}}}cleanup(e){this.foldStates.delete(e),this.callbacks.delete(e),this.stores.delete(e);let t=this.debounceTimers.get(e);t&&(clearTimeout(t),this.debounceTimers.delete(e))}extractHeaders(e){let t=[],n=e.split(`
`),i=!1;return n.forEach((o,s)=>{let a=o.trim();if(a.startsWith("```")){i=!i;return}if(!i){let l=a.match(/^(#{1,6})\s+(.+)$/);l&&t.push({text:l[2].trim(),level:l[1].length,line:s+1})}}),t}debouncedPersist(e,t){let n=this.debounceTimers.get(e);n&&clearTimeout(n);let i=setTimeout(()=>{this.persistToStorage(e,t),this.debounceTimers.delete(e)},300);this.debounceTimers.set(e,i)}persistToStorage(e,t){if(this.app)try{let i=`${this.app.appId}-note-fold-${e}`,s={folds:t.map(a=>({from:a,to:a+1})),timestamp:Date.now()};localStorage.setItem(i,JSON.stringify(s))}catch(n){console.error("\u6301\u4E45\u5316\u6298\u53E0\u72B6\u6001\u5230 localStorage \u5931\u8D25:",n)}}notifyCallbacks(e,t,n=!0){let i=this.callbacks.get(e);i&&i.forEach(o=>{try{o(t,n)}catch(s){console.error("\u6298\u53E0\u72B6\u6001\u56DE\u8C03\u6267\u884C\u5931\u8D25:",s)}})}},kt=Ot;kt.instance=null;var Qt=class{constructor(e){this.view=e,this.originalSetItem=localStorage.setItem.bind(localStorage),this.originalRemoveItem=localStorage.removeItem.bind(localStorage),this.isHijacked=!1}start(){this.isHijacked||(localStorage.setItem=(e,t)=>{let n=localStorage.getItem(e);this.originalSetItem(e,t),this.dispatchChangeEvent(e,t,n)},localStorage.removeItem=e=>{let t=localStorage.getItem(e);this.originalRemoveItem(e),this.dispatchChangeEvent(e,null,t)},this.isHijacked=!0)}stop(){localStorage.setItem=this.originalSetItem,localStorage.removeItem=this.originalRemoveItem,this.isHijacked=!1}dispatchChangeEvent(e,t,n){this.view.app&&this.view.app.workspace.trigger("localStorageChanged",{key:e,newValue:t,oldValue:n,timestamp:Date.now()})}};var Et=class{constructor(e,t){this.viewStates=new WeakMap;this.eventRefs=[];this.leafFileMap=new Map;this.isDestroyed=!1;this.cachedActiveView=null;this.activeViewCacheValidUntil=0;this.ACTIVE_VIEW_CACHE_DURATION=300;Et.instance&&Et.instance.destroy(),this.app=e,this.plugin=t,this.foldManager=kt.getInstance(e),Et.instance=this,this.initialize()}getCachedActiveView(){let e=Date.now();return this.cachedActiveView&&e<this.activeViewCacheValidUntil?this.cachedActiveView:(this.cachedActiveView=this.app.workspace.getActiveViewOfType(en.MarkdownView),this.activeViewCacheValidUntil=e+this.ACTIVE_VIEW_CACHE_DURATION,this.cachedActiveView)}clearActiveViewCache(){this.cachedActiveView=null,this.activeViewCacheValidUntil=0}initialize(){this.updateAllMarkdownViews(),this.eventRefs.push(this.app.workspace.on("layout-change",()=>{this.clearActiveViewCache(),this.updateAllMarkdownViews()})),this.eventRefs.push(this.app.workspace.on("file-open",t=>{this.clearActiveViewCache(),this.updateAllMarkdownViews(),this.handleFileSwitch(t)})),this.eventRefs.push(this.app.workspace.on("file-open",()=>{Promise.resolve().then(()=>this.cleanupClosedFiles())})),this.eventRefs.push(this.app.workspace.on("layout-change",()=>{Promise.resolve().then(()=>this.cleanupClosedFiles())}));let e=()=>{requestAnimationFrame(()=>this.updateActiveViewButtons())};this.eventRefs.push(this.app.workspace.on("active-leaf-change",t=>{if(e(),t&&t.view instanceof en.MarkdownView){let n=t.view;n.file&&n.file.extension==="md"&&this.handleActiveLeafChange(t,n)}}),this.app.workspace.on("layout-change",e)),this.eventRefs.push(this.app.vault.on("modify",t=>{this.isDestroyed||t&&t instanceof en.TFile&&t.extension==="md"&&queueMicrotask(async()=>{if(!this.isDestroyed)try{let n=this.leafFileMap.get(t.path);if(!n||n.size===0)return;n.forEach(i=>{if(!i||!i.view)return;let o=this.getViewState(i);if(!o.isGridNoteMode)return;let s=Date.now(),a=s-o.lastModificationTime;if(o.lastModificationSource==="internal"&&a<500)return;let c=i.view;if(!c||!c.editor)return;o.lastModificationSource="external",o.lastModificationTime=s;let d=c.editor.getValue(),u=ot(d,t.path,o.lastContent);o.nodes=u,o.lastContent=d,o.instance&&o.instance.$set({root:u})})}catch(n){console.error("GridNote: \u5904\u7406\u5916\u90E8\u6587\u4EF6\u4FEE\u6539\u65F6\u51FA\u9519:",n)}})})),this.cleanupStaleElements()}refreshAllProStatus(){this.app.workspace.getLeavesOfType("markdown").forEach(t=>{let n=t.view;if(n){let i=n.containerEl.querySelector(".gridnote-toggle-button");i&&this.updateButtonState(t,i)}})}cleanupStaleElements(){this.app.workspace.getLeavesOfType("markdown").forEach(t=>{let n=t.view;if(n&&n.contentEl){n.contentEl.querySelectorAll(".gridnote-container").forEach(s=>s.remove());let o=n.contentEl.querySelector(".markdown-source-view, .markdown-reading-view");o&&(o.style.display="")}})}cleanupClosedFiles(){let e=new Set;this.app.workspace.getLeavesOfType("markdown").forEach(n=>{e.add(n);let i=n.view;if(i&&i.file){let o=i.file.path;this.leafFileMap.has(o)||this.leafFileMap.set(o,new Set),this.leafFileMap.get(o).add(n)}}),this.leafFileMap.forEach((n,i)=>{let o=[];n.forEach(s=>{if(!e.has(s)){o.push(s);let a=this.viewStates.get(s);a&&(a.editorChangeEventRef&&this.app.workspace.offref(a.editorChangeEventRef),a.instance&&a.instance.$destroy(),a.localWatcher&&a.localWatcher.stop(),a.foldSyncRefs&&a.foldSyncRefs.forEach(l=>{try{this.app.workspace.offref(l)}catch(c){}}),this.viewStates.delete(s))}}),o.forEach(s=>n.delete(s)),n.size===0&&(this.leafFileMap.delete(i),ar(i))})}handleFileSwitch(e){!e||e.extension!=="md"||setTimeout(()=>{var o;let t=this.getCachedActiveView();if(!t||!t.file||!t.leaf||t.file.path!==e.path)return;let n=t.leaf,i=t.contentEl.querySelector(".gridnote-container");if(i){let s=this.getViewState(n);if(s.currentFilePath===e.path)return;let a=((o=t.editor)==null?void 0:o.getValue())||"",l=ot(a,e.path,s.lastContent);for(s.isGridNoteMode=!0,s.nodes=l,s.lastContent=a,s.currentFilePath=e.path;i.firstChild;)i.removeChild(i.firstChild);if(s.instance=new wn({target:i,props:{View:this.createGridNoteViewAdapter(t,s),root:l,isIntegratedView:!0}}),t.editor&&!s.editorChangeEventRef){let c=n,d=u=>{let h=this.getCachedActiveView();if(h&&h.leaf===c&&h.editor===u){let f=u.getValue()||"",p=this.getViewState(c),w=ot(f,e.path,p.lastContent);this.markInternalModification(c),p.isGridNoteMode&&p.instance&&(p.nodes=w,p.lastContent=f,p.instance.$set({root:w})),this.syncFileContent(e.path,w,c)}};s.editorChangeEventRef=this.app.workspace.on("editor-change",d)}s.localWatcher||(s.localWatcher=new Qt(t),s.localWatcher.start()),this.updateLeafFileMapping(n,e.path)}},50)}handleActiveLeafChange(e,t){let n=t.contentEl.querySelector(".gridnote-container");!n||!t.file||setTimeout(()=>{var c;let i=this.getCachedActiveView();if(!i||i.leaf!==e||!i.file)return;let o=this.getViewState(e),s=i.file.path;if(o.currentFilePath===s)return;let a=((c=i.editor)==null?void 0:c.getValue())||"",l=ot(a,s,o.lastContent);for(o.isGridNoteMode=!0,o.nodes=l,o.lastContent=a,o.currentFilePath=s,o.instance&&o.instance.$destroy();n.firstChild;)n.removeChild(n.firstChild);o.instance=new wn({target:n,props:{View:this.createGridNoteViewAdapter(i,o),root:l,isIntegratedView:!0}}),this.updateLeafFileMapping(e,s)},50)}syncFileContent(e,t,n){let i=this.leafFileMap.get(e);i&&i.forEach(o=>{if(o!==n){let s=this.viewStates.get(o);s&&s.isGridNoteMode&&s.instance&&(s.nodes=t,s.instance.$set({root:t}))}})}updateLeafFileMapping(e,t){this.leafFileMap.has(t)||this.leafFileMap.set(t,new Set),this.leafFileMap.get(t).add(e)}updateAllMarkdownViews(){this.app.workspace.getLeavesOfType("markdown").forEach(t=>{let n=t.view;n&&n.file&&n.file.extension==="md"&&(this.addToggleButtonToView(t,n),this.getViewState(t).isGridNoteMode&&this.updateLeafFileMapping(t,n.file.path))})}updateActiveViewButtons(){let e=this.getCachedActiveView();if(e&&e.file&&e.file.extension==="md"){let t=e.containerEl.querySelector(".gridnote-toggle-button");t&&this.updateButtonVisibility(e,t)}}addToggleButtonToView(e,t){let n=t.containerEl.querySelector(".gridnote-toggle-button");if(n){this.updateButtonState(e,n),this.updateButtonVisibility(t,n);return}let i=t.containerEl.querySelector(".view-actions");if(!i)return;let o=document.createElement("div");o.className="clickable-icon gridnote-toggle-button",o.setAttribute("aria-label","Toggle GridNote View"),i.insertBefore(o,i.firstChild),o.innerHTML=`<svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
			<g fill="currentColor">
				<!-- \u5916\u8FB9\u6846 -->
				<rect x="1" y="1" width="14" height="14" stroke="currentColor" stroke-width="0.8" fill="none" rx="1"/>
				
				<!-- \u5EB7\u5948\u5C14\u7B14\u8BB0\u5206\u9694\u7EBF -->
				<!-- \u5DE6\u4FA7\u5173\u952E\u8BCD\u533A\u5206\u9694\u7EBF -->
				<line x1="5.5" y1="1" x2="5.5" y2="11" stroke="currentColor" stroke-width="0.6"/>
				<!-- \u5E95\u90E8\u603B\u7ED3\u533A\u5206\u9694\u7EBF -->
				<line x1="1" y1="11" x2="15" y2="11" stroke="currentColor" stroke-width="0.6"/>
				
				<!-- \u5DE6\u4FA7\u5173\u952E\u8BCD\u533A\u5185\u5BB9 (\u70B9\u72B6\u8868\u793A\u5173\u952E\u8BCD) -->
				<circle cx="3" cy="3.5" r="0.4" opacity="0.7"/>
				<circle cx="3" cy="5.5" r="0.4" opacity="0.7"/>
				<circle cx="3" cy="7.5" r="0.4" opacity="0.7"/>
				<circle cx="3" cy="9.5" r="0.4" opacity="0.7"/>
				
				<!-- \u53F3\u4FA7\u7B14\u8BB0\u533A\u5185\u5BB9 (\u77ED\u7EBF\u8868\u793A\u7B14\u8BB0\u5185\u5BB9) -->
				<rect x="7" y="3" width="6" height="0.6" rx="0.3" opacity="0.8"/>
				<rect x="7" y="4.2" width="4" height="0.6" rx="0.3" opacity="0.6"/>
				<rect x="7" y="5.8" width="5" height="0.6" rx="0.3" opacity="0.8"/>
				<rect x="7" y="7" width="3.5" height="0.6" rx="0.3" opacity="0.6"/>
				<rect x="7" y="8.5" width="4.5" height="0.6" rx="0.3" opacity="0.8"/>
				<rect x="7" y="9.7" width="3" height="0.6" rx="0.3" opacity="0.6"/>
				
				<!-- \u5E95\u90E8\u603B\u7ED3\u533A\u5185\u5BB9 (\u6A2A\u7EBF\u8868\u793A\u603B\u7ED3) -->
				<rect x="2" y="12.5" width="11" height="0.6" rx="0.3" opacity="0.9"/>
				<rect x="3" y="13.8" width="8" height="0.6" rx="0.3" opacity="0.7"/>
			</g>
		</svg>`,o.addEventListener("click",async a=>{if(a.preventDefault(),!o.hasAttribute("disabled")){o.setAttribute("disabled","true");try{this.toggleGridNoteView(e,t)}finally{o.removeAttribute("disabled")}}}),this.updateButtonState(e,o),this.updateButtonVisibility(t,o),this.getViewState(e).isGridNoteMode&&t.file&&this.updateLeafFileMapping(e,t.file.path)}async toggleGridNoteView(e,t){this.getViewState(e).isGridNoteMode?this.switchToMarkdownMode(e,t):await this.switchToGridNoteMode(e,t);let i=t.containerEl.querySelector(".gridnote-toggle-button");i&&this.updateButtonState(e,i)}async ensureDocumentHasH1Header(e,t){var w;let n=e.split(`
`),i=-1,o=-1,s=!1,a=/^(#{1,6})\s+/,l=/^\s*```/,c=-1;if(n.length>0&&n[0].trim()==="---"){for(let b=1;b<n.length;b++)if(n[b].trim()==="---"){c=b;break}}let d=c>=0?c+1:0;for(let b=d;b<n.length;b++){let m=n[b];if(l.test(m)){s=!s;continue}if(!s){let E=m.trim().match(a);if(E){i=b,o=E[1].length;break}}}if(o===1&&(i===d||n.slice(d,i).every(b=>!b.trim())))return e;let u="# Untitled",h=[...n],f=c>=0?c+1:0;c>=0?f<h.length&&((w=h[f])==null?void 0:w.trim())!==""?h.splice(f,0,"",u):h.splice(f,0,u):h.length>0&&h[0].trim()!==""?h.unshift(u,""):h.unshift(u);let p=h.join(`
`);if(t.file)try{this.markInternalModification(t.leaf),await this.app.vault.modify(t.file,p)}catch(b){console.error("[GridNote] \u81EA\u52A8\u63D2\u5165 H1 \u6807\u9898\u5931\u8D25:",b)}return p}parseMarkdown(e,t,n){return ot(e,t,n)}async switchToGridNoteMode(e,t){var a,l,c;let n=this.getViewState(e),i=t.contentEl,o=i.querySelector(".markdown-source-view, .markdown-reading-view");o&&(o.style.display="none"),this.hideOriginalMenuButtons(t);let s=i.createDiv("gridnote-container");try{let d=((a=t.editor)==null?void 0:a.getValue())||"";d=await this.ensureDocumentHasH1Header(d,t);let u=this.parseMarkdown(d,(l=t.file)==null?void 0:l.path,n.lastContent);n.nodes=u,n.lastContent=d;let h=this.createGridNoteViewAdapter(t,n);if(h.getLocalFoldsCache(),n.instance=new wn({target:s,props:{View:h,root:u,isIntegratedView:!0}}),n.localWatcher=new Qt(t),n.localWatcher.start(),t.editor&&!n.editorChangeEventRef){let f=e,p=(c=t.file)==null?void 0:c.path,w=b=>{let m=this.getCachedActiveView();if(m&&m.leaf===f&&m.editor===b){let E=b.getValue()||"",M=this.getViewState(f),y=ot(E,p,M.lastContent);this.markInternalModification(f),M.isGridNoteMode&&M.instance&&(M.nodes=y,M.lastContent=E,M.instance.$set({root:y})),p&&this.syncFileContent(p,y,f)}};n.editorChangeEventRef=this.app.workspace.on("editor-change",w)}t.file&&this.updateLeafFileMapping(e,t.file.path),n.isGridNoteMode=!0}catch(d){console.error("GridNote\u5207\u6362\u5931\u8D25:",d),s.innerHTML=`<div style="display: flex; align-items: center; justify-content: center; height: 200px; color: var(--text-error);">
				<div>\u52A0\u8F7D\u5931\u8D25\uFF0C\u8BF7\u91CD\u8BD5</div>
			</div>`}}switchToMarkdownMode(e,t){let n=this.getViewState(e);n.editorChangeEventRef&&(this.app.workspace.offref(n.editorChangeEventRef),n.editorChangeEventRef=null),n.instance&&(n.instance.$destroy(),n.instance=null),n.localWatcher&&(n.localWatcher.stop(),n.localWatcher=null);let i=t.contentEl.querySelector(".gridnote-container");i&&i.remove();let o=t.contentEl.querySelector(".markdown-source-view, .markdown-reading-view");o&&(o.style.display=""),this.showOriginalMenuButtons(t),n.isGridNoteMode=!1}createGridNoteViewAdapter(e,t){var o,s;let n=this.plugin,i={app:this.app,file:e.file,editor:e.editor,contentEl:e.contentEl,Level:t.levelController,lastUserFoldInteraction:0,plugin:n,nodes:t.nodes,instance:t.instance,LOCAL_FOLDS:He([]),leaf:e.leaf,containerEl:e.containerEl,addChild:(o=e.addChild)==null?void 0:o.bind(e),removeChild:(s=e.removeChild)==null?void 0:s.bind(e),getViewType:()=>e.getViewType(),getState:()=>e.getState(),setState:(a,l)=>e.setState(a,l),get ProStatus(){var a;try{let l=(a=n.vipManager)==null?void 0:a.getActivationInfo(),c=(l==null?void 0:l.isActive)||!1;return Boolean(c)}catch(l){return console.error("[ViewAdapter] VIP\u72B6\u6001\u68C0\u67E5\u5931\u8D25:",l),!1}},scrollToLine:a=>{t.instance&&t.instance.currentLines&&t.instance.currentLines.set(a+1)},markInternalModification:a=>{this.markInternalFileModification(a)},handleClickHeader:a=>{e.editor&&e.editor.scrollIntoView({from:{line:a,ch:0},to:{line:a,ch:0}},!0)},handleClickFold:(a,l,c)=>{if(i.lastUserFoldInteraction=Date.now(),e.editor){let d=l-1,u=e.editor.cm;if(!u){c();return}let h=u.domAtPos(a),f=h.node instanceof Element?h.node:h.node.parentElement,p=f==null?void 0:f.querySelector(".cm-fold-indicator");if(!p&&f){let w=f.parentElement;for(;w&&!p&&w!==u.dom;)p=w.querySelector(".cm-fold-indicator"),w=w.parentElement}if(p){let w=p.classList.contains("is-collapsed");p.dispatchEvent(new MouseEvent("click",{bubbles:!1,cancelable:!0})),i.LOCAL_FOLDS.update(b=>{let m=b.indexOf(d),E;return w?E=b.filter(M=>M!==d):E=[...b,d],E}),Promise.resolve().then(()=>{var E,M,y;let b=this.app.foldManager,m=((E=b==null?void 0:b.load)==null?void 0:E.call(b,e.file))||((M=b==null?void 0:b.get)==null?void 0:M.call(b,e.file));if(m&&m.folds){let L=`${this.app.appId}-note-fold-${(y=e.file)==null?void 0:y.path}`;localStorage.setItem(L,JSON.stringify({folds:m.folds,lines:e.editor.lineCount()}))}}),c()}else c()}},handleClickLink:(a,l)=>{let c=a.target;if(c instanceof HTMLAnchorElement){let d=c.dataset.href;if(e.file){let{basename:u,path:h}=e.file;d&&!d.startsWith(u)?c.classList.contains("internal-link")&&this.app.workspace.openLinkText(d,h,!0):i.handleClickHeader(l)}}},getLocalFoldsCache:()=>{var d;let l=`${this.app.appId}-note-fold-${(d=e.file)==null?void 0:d.path}`,c=localStorage.getItem(l);if(c)try{let h=JSON.parse(c).folds.map(f=>f.from);i.LOCAL_FOLDS.set(h)}catch(u){console.error(u)}else i.LOCAL_FOLDS.set([])},recalculateFoldStates:(a,l)=>{if(!e.file||!a||!l)return;let c=Bt(i.LOCAL_FOLDS);if(c.length!==0)try{let d=this.extractHeaders(a),u=this.extractHeaders(l),h=[];c.forEach(b=>{let m=d.find(E=>E.line===b+1);if(m){let E=u.find(M=>M.text===m.text&&M.level===m.level);E&&h.push(E.line-1)}});let f=[...c].sort((b,m)=>b-m),p=[...h].sort((b,m)=>b-m);(f.length!==p.length||f.some((b,m)=>b!==p[m]))&&(i.LOCAL_FOLDS.set(h),this.saveFoldsToStorage(h,e.file.path))}catch(d){console.error("\u91CD\u65B0\u8BA1\u7B97\u6298\u53E0\u72B6\u6001\u65F6\u51FA\u9519:",d)}},refreshFromMarkdown:a=>{var c;let l=ot(a,(c=e.file)==null?void 0:c.path,t.lastContent);t.nodes=l,t.lastContent=a,t.instance&&t.instance.$set({root:l})},get foldManager(){return kt.getInstance(this.app)},loadFoldStates:()=>{var c;if(!((c=e.file)!=null&&c.path))return;let a=kt.getInstance(this.app);a.loadFromStorage(e.file.path);let l=a.getFolds(e.file.path);i.LOCAL_FOLDS.set(l)},render:a=>{var l;try{let c=ot(a,(l=e.file)==null?void 0:l.path,t.lastContent);t.nodes=c,t.lastContent=a,t.instance&&t.instance.$set({root:c})}catch(c){console.error("GridNote adapter render failed:",c)}}};return i}extractHeaders(e){let t=[],n=e.split(`
`),i=!1;return n.forEach((o,s)=>{let a=o.trim();if(a.startsWith("```")){i=!i;return}if(!i){let l=a.match(/^(#{1,6})\s+(.+)$/);l&&t.push({text:l[2].trim(),level:l[1].length,line:s+1})}}),t}saveFoldsToStorage(e,t){if(!t)return;let i=`${this.app.appId}-note-fold-${t}`,s={folds:e.map(a=>({from:a,to:a+1})),lines:e.length};localStorage.setItem(i,JSON.stringify(s))}getViewState(e){return this.viewStates.has(e)||this.viewStates.set(e,{isGridNoteMode:!1,instance:null,levelController:new yn,localWatcher:null,nodes:[],editorChangeEventRef:null,lastModificationSource:null,lastModificationTime:0}),this.viewStates.get(e)}markInternalModification(e){let t=this.getViewState(e);t.lastModificationSource="internal",t.lastModificationTime=Date.now()}markInternalFileModification(e){let t=this.leafFileMap.get(e);t&&t.forEach(n=>{this.markInternalModification(n)})}updateButtonState(e,t){this.getViewState(e).isGridNoteMode?(t.addClass("is-active"),t.setAttribute("aria-label","Switch to Markdown View")):(t.removeClass("is-active"),t.setAttribute("aria-label","Switch to GridNote View"))}updateButtonVisibility(e,t){try{e.getMode()==="source"?t.style.display="":t.style.display="none"}catch(n){t.style.display=""}}hideOriginalMenuButtons(e){let t=e.containerEl.querySelector(".view-actions");t&&t.querySelectorAll(".clickable-icon:not(.gridnote-toggle-button)").forEach(i=>{let o=i;o.style.display="none",o.setAttribute("data-gridnote-hidden","true")})}showOriginalMenuButtons(e){let t=e.containerEl.querySelector(".view-actions");t&&t.querySelectorAll('[data-gridnote-hidden="true"]').forEach(i=>{let o=i;o.style.display="",o.removeAttribute("data-gridnote-hidden")})}setupFoldManagerSync(e,t,n){let i=this.getViewState(e);if(!t.file)return;let o=t.file.path,s="",a=!1,l=()=>{var p,w,b;if(!a)try{let m=this.app.foldManager,E=((p=m==null?void 0:m.load)==null?void 0:p.call(m,t.file))||((w=m==null?void 0:m.get)==null?void 0:w.call(m,t.file));if(E&&E.folds){let M=JSON.stringify(E.folds);if(M!==s){s=M;let y=E.folds.map(T=>T.from);n.LOCAL_FOLDS.set(y);let L=`${this.app.appId}-note-fold-${o}`;localStorage.setItem(L,JSON.stringify({folds:E.folds,lines:((b=t.editor)==null?void 0:b.lineCount())||0}))}}}catch(m){console.error("[\u6298\u53E0\u540C\u6B65] \u9519\u8BEF:",m)}},c=null,d=null,u=()=>{c&&clearTimeout(c),d&&cancelIdleCallback(d),d=requestIdleCallback(()=>{l(),d=null},{timeout:100})},h=this.app.workspace.on("layout-change",u),f=this.app.workspace.on("active-leaf-change",p=>{p===e&&u()});i.foldSyncRefs||(i.foldSyncRefs=[]),i.foldSyncRefs.push(h,f),i.triggerFoldSync=u,queueMicrotask(l)}destroy(){if(this.isDestroyed)return;this.isDestroyed=!0;try{this.eventRefs.forEach(n=>{try{this.app.workspace.offref(n)}catch(i){}}),this.eventRefs=[],this.app.workspace.getLeavesOfType("markdown").forEach(n=>{try{let i=this.viewStates.get(n);if(i){if(i.editorChangeEventRef){try{this.app.workspace.offref(i.editorChangeEventRef)}catch(s){}i.editorChangeEventRef=null}if(i.instance){try{i.instance.$destroy()}catch(s){}i.instance=null}if(i.localWatcher){try{i.localWatcher.stop()}catch(s){}i.localWatcher=null}i.foldSyncRefs&&(i.foldSyncRefs.forEach(s=>{try{this.app.workspace.offref(s)}catch(a){}}),i.foldSyncRefs=void 0);let o=n.view;if(o&&o.contentEl){let s=o.contentEl.querySelector(".gridnote-container");s&&s.remove();let a=o.containerEl.querySelector(".gridnote-toggle-button");a&&a.remove();let l=o.contentEl.querySelector(".markdown-source-view, .markdown-reading-view");l&&(l.style.display="")}}}catch(i){}}),this.leafFileMap.clear(),Et.instance===this&&(Et.instance=null)}catch(t){console.error("GridNote: \u6E05\u7406\u8D44\u6E90\u65F6\u51FA\u9519:",t)}this.app.workspace.getLeavesOfType("markdown").forEach(t=>{let n=t.view;if(n){let i=n.containerEl.querySelector(".gridnote-toggle-button");i&&i.remove()}})}},$t=Et;$t.instance=null;var Ue=require("obsidian"),xn=class extends Ue.PluginSettingTab{constructor(t,n){super(t,n);this.plugin=n}display(){var p,w,b,m,E,M;let{containerEl:t}=this;t.empty(),new Ue.Setting(t).setName("\u529F\u80FD\u4ECB\u7ECD").setHeading(),new Ue.Setting(t).setDesc("GridNote \u5C06 Markdown \u6587\u6863\u8F6C\u6362\u4E3A\u805A\u7126\u5F0F\u6811\u72B6\u7ED3\u6784\u89C6\u56FE\uFF0C\u7ED3\u5408\u5EB7\u5948\u5C14\u7B14\u8BB0\u6CD5\u548C\u5361\u7247\u76D2\u7B14\u8BB0\u7CFB\u7EDF\uFF0C\u63D0\u5347\u77E5\u8BC6\u7EC4\u7EC7\u548C\u9605\u8BFB\u7406\u89E3\u6548\u7387\u3002"),new Ue.Setting(t).setName("\u6FC0\u6D3B\u72B6\u6001").setHeading(),new Ue.Setting(t).setName("\u8BBE\u5907 ID").setDesc("ID \u7528\u4E8E\u6FC0\u6D3B\u63D2\u4EF6,\u4E00\u4E2A\u8BA2\u5355\u53F7\u6700\u591A\u6FC0\u6D3B\u4E09\u53F0\u8BBE\u5907").addButton(y=>{let I=()=>{try{return this.app.appId||"unknown-device"}catch(L){return"unknown-device"}};return y.setButtonText(I()).onClick(async()=>{})}),new Ue.Setting(t).setName("\u8D2D\u4E70\u4E13\u4E1A\u7248").setDesc("\u8D2D\u4E70\u540E\uFF0C\u53EF\u6FC0\u6D3B\u4E13\u4E1A\u7248").addButton(y=>y.setButtonText("\u53BB\u8D2D\u4E70").onClick(()=>{window.open("https://gridnote.cn/#/landing")}));let n=null;(p=this.plugin.vipManager)==null||p.clearCache();let i=((w=this.plugin.vipManager)==null?void 0:w.getActivationInfo())||{isActive:!1},o=((b=this.plugin.vipManager)==null?void 0:b.isVIPActive())||!1,s="";i.isActive&&i.activatedAt?s=`\u2705 \u5DF2\u6FC0\u6D3B\u4E13\u4E1A\u7248 (\u6C38\u4E45\u6709\u6548\uFF0C\u6FC0\u6D3B\u65F6\u95F4\uFF1A${((m=i.activatedAt)==null?void 0:m.toLocaleDateString())||"\u672A\u77E5"})`:s="\u274C \u672A\u6FC0\u6D3B\u4E13\u4E1A\u7248";let a=new Ue.Setting(t).setName("\u6FC0\u6D3B\u4E13\u4E1A\u7248").setDesc(s).setClass("grid-note-setting-activate").addText(y=>{n=y,y.setPlaceholder("\u8BA2\u5355\u53F7").setValue("").onChange(async I=>{this.plugin.settings.activationCode=I,await this.plugin.saveSettings(),this.app.workspace.trigger("gridnote-setting-changed","activationCode",I)})}).addButton(y=>y.setButtonText("\u7ACB\u5373\u9A8C\u8BC1").onClick(async()=>{var L,T;let I=((L=n==null?void 0:n.getValue())==null?void 0:L.trim())||"";if(!I){new Ue.Notice("\u8BF7\u8F93\u5165\u8BA2\u5355\u53F7");return}try{y.setButtonText("\u9A8C\u8BC1\u4E2D..."),y.setDisabled(!0),await((T=this.plugin.vipManager)==null?void 0:T.activate(I))?this.display():(y.setButtonText("\u7ACB\u5373\u9A8C\u8BC1"),y.setDisabled(!1))}catch(q){console.error("[Settings] \u6FC0\u6D3B\u9519\u8BEF:",q),y.setButtonText("\u7ACB\u5373\u9A8C\u8BC1"),y.setDisabled(!1)}}));(E=this.plugin.vipManager)!=null&&E.isVIPActive()&&new Ue.Setting(t).setName("\u5237\u65B0\u9A8C\u8BC1\u72B6\u6001").setDesc("\u7ACB\u5373\u8054\u7F51\u9A8C\u8BC1\u5F53\u524D\u6FC0\u6D3B\u72B6\u6001").addButton(y=>y.setButtonText("\u7ACB\u5373\u9A8C\u8BC1").onClick(async()=>{var I;try{y.setButtonText("\u9A8C\u8BC1\u4E2D..."),y.setDisabled(!0),await((I=this.plugin.vipManager)==null?void 0:I.manualVerify())?this.display():this.display(),y.setButtonText("\u7ACB\u5373\u9A8C\u8BC1"),y.setDisabled(!1)}catch(L){console.error("Manual verify error:",L),y.setButtonText("\u7ACB\u5373\u9A8C\u8BC1"),y.setDisabled(!1)}})),t.createEl("div",{text:"\u9047\u5230\u95EE\u9898\uFF1F",cls:"gridnote-help-links"}).append(createEl("a",{href:"https://gridnote.cn/#/landing",text:"\u8054\u7CFB\u6280\u672F\u652F\u6301"})),t.createEl("div",{cls:"gridnote-section-spacer"}),new Ue.Setting(t).setName("\u529F\u80FD\u5BF9\u6BD4").setHeading();let l=t.createDiv({cls:"gridnote-features-container"}),c=l.createDiv({cls:"features-section free-features"});c.createEl("h4",{text:"\u{1F4CB} \u514D\u8D39\u529F\u80FD",cls:"features-section-title"}),[{icon:"\u{1F332}",name:"\u6811\u72B6\u7ED3\u6784\u89C6\u56FE",desc:"\u5C06 Markdown \u6587\u6863\u8F6C\u6362\u4E3A\u76F4\u89C2\u7684\u6811\u72B6\u7ED3\u6784"},{icon:"\u{1F50D}",name:"\u5168\u6587\u641C\u7D22",desc:"\u5FEB\u901F\u641C\u7D22\u5E76\u5B9A\u4F4D\u5230\u5177\u4F53\u5185\u5BB9\u4F4D\u7F6E (Ctrl/Cmd + F/K)"},{icon:"\u{1F4F1}",name:"\u667A\u80FD\u6807\u9898\u70B9\u51FB",desc:"\u70B9\u51FB\u6807\u9898\u5FEB\u901F\u8DF3\u8F6C\u5230\u5BF9\u5E94\u7F16\u8F91\u4F4D\u7F6E"},{icon:"\u{1F4BE}",name:"\u72B6\u6001\u8BB0\u5FC6",desc:"\u81EA\u52A8\u4FDD\u5B58\u6298\u53E0\u5C55\u5F00\u72B6\u6001\uFF0C\u4E0B\u6B21\u6253\u5F00\u6062\u590D"}].forEach(y=>{let I=c.createEl("div",{cls:"feature-row"});I.createEl("span",{text:y.icon,cls:"feature-icon"});let L=I.createEl("div",{cls:"feature-content"});L.createEl("div",{text:y.name,cls:"feature-name"}),L.createEl("div",{text:y.desc,cls:"feature-desc"})});let u=l.createDiv({cls:`features-section pro-features${(M=this.plugin.vipManager)!=null&&M.isVIPActive()?" activated":""}`});u.createEl("h4",{text:"\u2B50 \u4E13\u4E1A\u7248\u529F\u80FD",cls:"features-section-title"}),[{icon:"\u270F\uFE0F",name:"\u53CC\u51FB\u5C31\u5730\u7F16\u8F91",desc:"\u53CC\u51FB\u4EFB\u610F\u8282\u70B9\u5185\u5BB9\u5373\u53EF\u76F4\u63A5\u7F16\u8F91\uFF0C\u652F\u6301\u8BED\u6CD5\u9AD8\u4EAE"},{icon:"\u{1F4CA}",name:"\u5C42\u7EA7\u6DF1\u5EA6\u63A7\u5236",desc:"\u81EA\u7531\u8C03\u8282\u663E\u793A\u6DF1\u5EA6\uFF081-5\u7EA7\uFF09\uFF0C\u4E13\u6CE8\u91CD\u8981\u4FE1\u606F"},{icon:"\u{1F4C1}",name:"\u6587\u4EF6\u5FEB\u901F\u5207\u6362",desc:"\u4E00\u952E\u8BBF\u95EE\u540C\u76EE\u5F55 Markdown \u6587\u4EF6\uFF0C\u5FEB\u901F\u8DF3\u8F6C"},{icon:"\u{1F517}",name:"\u667A\u80FD\u53CC\u89C6\u56FE",desc:"\u5DE6\u4FA7\u6811\u72B6\u7ED3\u6784 + \u53F3\u4FA7\u7F16\u8F91\u5668\uFF0C\u5B8C\u7F8E\u7ED3\u5408"}].forEach(y=>{var T;let I=u.createEl("div",{cls:"feature-row"});I.createEl("span",{text:y.icon,cls:"feature-icon"});let L=I.createEl("div",{cls:"feature-content"});L.createEl("div",{text:y.name,cls:"feature-name"}),L.createEl("div",{text:y.desc,cls:"feature-desc"}),(T=this.plugin.vipManager)!=null&&T.isVIPActive()?I.createEl("span",{text:"\u2713",cls:"feature-status activated"}):I.createEl("span",{text:"\u{1F512}",cls:"feature-status locked"})});let f=t.createEl("style");f.textContent=`
			.gridnote-section-spacer {
				height: 32px;
			}

			/* \u529F\u80FD\u4ECB\u7ECD\u5BB9\u5668 */
			.gridnote-features-container {
				margin-bottom: 16px;
				display: grid;
				gap: 12px;
			}

			.features-section {
				padding: 12px;
				border-radius: 6px;
				border: 1px solid var(--background-modifier-border);
				background: var(--background-primary);
			}

			.features-section-title {
				margin: 0 0 8px 0;
				font-size: 15px;
				font-weight: 600;
				color: var(--text-normal);
			}

			.free-features {
				border-left: 4px solid var(--color-green);
			}

			.pro-features {
				border-left: 4px solid var(--color-orange);
				position: relative;
			}

			.pro-features.activated {
				border-left-color: var(--interactive-accent);
				background: var(--background-secondary);
			}

			.feature-row {
				display: flex;
				align-items: flex-start;
				padding: 6px 0;
				border-bottom: 1px solid var(--background-modifier-border-focus);
				transition: all 0.2s ease;
			}

			.feature-row:last-child {
				border-bottom: none;
			}

			.feature-row:hover {
				background: var(--background-modifier-hover);
				border-radius: 4px;
				padding-left: 6px;
				padding-right: 6px;
				margin-left: -6px;
				margin-right: -6px;
			}

			.feature-icon {
				font-size: 16px;
				margin-right: 10px;
				margin-top: 1px;
				flex-shrink: 0;
			}

			.feature-content {
				flex: 1;
			}

			.feature-name {
				font-weight: 600;
				color: var(--text-normal);
				font-size: 13px;
				margin-bottom: 2px;
			}

			.feature-desc {
				color: var(--text-muted);
				font-size: 12px;
				line-height: 1.3;
			}

			.feature-status {
				flex-shrink: 0;
				margin-left: 6px;
				margin-top: 1px;
				font-size: 14px;
				font-weight: bold;
			}

			.feature-status.activated {
				color: var(--color-green);
			}

			.feature-status.locked {
				color: var(--text-muted);
				opacity: 0.6;
			}

			/* \u6FC0\u6D3B\u72B6\u6001\u4E0B\u7684\u7279\u6B8A\u6837\u5F0F */
			.pro-features.activated .feature-name {
				color: var(--interactive-accent);
			}

			.pro-features.activated .feature-row:hover {
				background: var(--background-modifier-success);
			}
		`}};var qe=require("obsidian");function _n(r,e){let t="";for(let n=0;n<e.length;n++){let i=r.charCodeAt(n%r.length);t+=(e.charCodeAt(n)^i).toString(16).padStart(2,"0")}return t}function Rt(r,e){let t="",n=[];for(let i=0;i<e.length;i+=2)n.push(parseInt(e.substr(i,2),16));for(let i=0;i<n.length;i++){let o=r.charCodeAt(i%r.length);t+=String.fromCharCode(n[i]^o)}return t}var rt=class{constructor(e,t){this.STORAGE_KEY_PREFIX="GRID_NOTE_VIP_";this.VERIFICATION_INTERVAL=7*24*60*60*1e3;this.isInitialized=!1;this.cachedVIPStatus=null;this.cacheValidUntil=0;this.CACHE_DURATION=5*60*1e3;this.app=e,this.plugin=t}static getInstance(e,t){return rt.instance||(rt.instance=new rt(e,t)),rt.instance}async initialize(){if(!this.isInitialized)try{if(!this.plugin.settings){console.error("[GridNote VIP] Settings not initialized!");return}this.cleanupOldStorageKeys(),await this.validateLocalData(),this.setupSettingsWatcher(),this.setupPeriodicVerification(),this.isInitialized=!0}catch(e){console.error("[GridNote VIP] Initialization failed:",e)}}getAppId(){try{return this.app.appId||"unknown-device"}catch(e){return console.error("Failed to get app ID:",e),"unknown-device"}}getStorageKey(){return`${this.STORAGE_KEY_PREFIX}${this.getAppId()}`}async activate(e){try{let t=this.getAppId(),n=await(0,qe.requestUrl)({url:"https://gridnote.cn/plugin-verify",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e,vault_id:t})}),{code:i,message:o}=n.json;if(i!==201)return new qe.Notice(`\u6FC0\u6D3B\u5931\u8D25\uFF1A${o||"\u672A\u77E5\u9519\u8BEF"}`),!1;let s={appId:t,activationCode:e,activatedAt:Date.now(),lastVerified:Date.now()},a=_n(t,JSON.stringify(s));return localStorage.setItem(this.getStorageKey(),a),this.plugin.settings.activationCode=e,this.plugin.settings.proStatus=!0,await this.plugin.saveSettings(),this.plugin.app.workspace.trigger("gridnote-setting-changed","proStatus",!0),this.notifyStatusChange(),new qe.Notice("\u2705 \u4E13\u4E1A\u7248\u6FC0\u6D3B\u6210\u529F\uFF01"),!0}catch(t){return console.error("[VIPManager] \u274C \u6FC0\u6D3B\u5931\u8D25:",t),new qe.Notice(`\u6FC0\u6D3B\u5931\u8D25\uFF1A${t.message}`),!1}}async validateLocalData(){if(!this.isMobilePlatform())try{let e=this.getAppId(),t=this.getStorageKey(),n=localStorage.getItem(t);if(!n){await this.resetVIPStatus();return}let i=Rt(e,n),o=JSON.parse(i);if(!o.appId||!o.activationCode||o.appId!==e){await this.resetVIPStatus();return}(!this.plugin.settings.proStatus||this.plugin.settings.activationCode!==o.activationCode)&&(this.plugin.settings.proStatus=!0,this.plugin.settings.activationCode=o.activationCode,await this.plugin.saveSettings(),this.plugin.app.workspace.trigger("gridnote-setting-changed","proStatus",!0)),Date.now()-o.lastVerified>this.VERIFICATION_INTERVAL&&setTimeout(()=>{this.backgroundVerify(o.activationCode)},2e3)}catch(e){console.error("[GridNote VIP] localStorage \u9A8C\u8BC1\u5F02\u5E38:",e),await this.resetVIPStatus()}}async backgroundVerify(e){try{let t=this.getAppId(),n=await(0,qe.requestUrl)({url:"https://gridnote.cn/plugin-verify",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e,vault_id:t})}),{code:i}=n.json;if(i===201){let o={appId:t,activationCode:e,activatedAt:Date.now(),lastVerified:Date.now()},s=_n(t,JSON.stringify(o));localStorage.setItem(this.getStorageKey(),s)}else await this.resetVIPStatus(),new qe.Notice("\u26A0\uFE0F VIP\u72B6\u6001\u9A8C\u8BC1\u5931\u8D25\uFF0C\u53EF\u80FD\u8BA2\u5355\u5DF2\u9000\u6B3E")}catch(t){}}async resetVIPStatus(){try{localStorage.removeItem(this.getStorageKey())}catch(e){}try{this.plugin.settings.proStatus=!1,this.plugin.settings.activationCode="",await this.plugin.saveSettings()}catch(e){console.error("[GridNote VIP] Failed to reset settings:",e)}this.clearCache(),this.plugin.app.workspace.trigger("gridnote-setting-changed","proStatus",!1)}async manualVerify(){let e=(this.plugin.settings.activationCode||"").trim();if(!e||e.length===0)return new qe.Notice("\u8BF7\u5148\u8F93\u5165\u6FC0\u6D3B\u7801"),!1;try{let t=this.getAppId(),n=await(0,qe.requestUrl)({url:"https://gridnote.cn/plugin-verify",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e,vault_id:t})}),{code:i,message:o}=n.json;if(i===201){let s={appId:t,activationCode:e,activatedAt:Date.now(),lastVerified:Date.now()},a=_n(t,JSON.stringify(s));return localStorage.setItem(this.getStorageKey(),a),this.plugin.settings.proStatus=!0,await this.plugin.saveSettings(),this.clearCache(),this.plugin.app.workspace.trigger("gridnote-setting-changed","proStatus",!0),new qe.Notice("\u2705 \u9A8C\u8BC1\u6210\u529F\uFF0CVIP\u72B6\u6001\u6B63\u5E38"),!0}else return await this.resetVIPStatus(),new qe.Notice(`\u274C \u9A8C\u8BC1\u5931\u8D25\uFF1A${o||"\u6FC0\u6D3B\u7801\u65E0\u6548"}`),!1}catch(t){return console.error("Manual verification failed:",t),new qe.Notice(`\u274C \u9A8C\u8BC1\u5931\u8D25\uFF1A${t.message}`),!1}}isMobilePlatform(){return qe.Platform.isMobile}syncMobileVIPStatus(){try{let e=this.getAppId(),t=this.getStorageKey(),n=localStorage.getItem(t);if(n){let i=Rt(e,n),o=JSON.parse(i);o.appId===e&&o.activationCode&&(!this.plugin.settings.proStatus||this.plugin.settings.activationCode!==o.activationCode)&&(this.plugin.settings.proStatus=!0,this.plugin.settings.activationCode=o.activationCode,this.plugin.saveSettings().catch(s=>console.error("[GridNote VIP] Failed to save synced settings:",s)))}}catch(e){}}isVIPActive(){let e=Date.now();if(this.cachedVIPStatus!==null&&e<this.cacheValidUntil)return this.cachedVIPStatus;if(this.isMobilePlatform()){this.syncMobileVIPStatus();let n=this.plugin.settings.proStatus===!0,i=this.plugin.settings.activationCode||"",o=n&&i.length>0;return this.updateCache(o),o}try{let n=this.getAppId(),i=this.getStorageKey(),o=localStorage.getItem(i);if(!o)return this.updateCache(!1),!1;let s=Rt(n,o),a=JSON.parse(s);if(a.appId!==n||!a.activationCode)return this.updateCache(!1),!1;if((this.plugin.settings.activationCode||"")!==a.activationCode)return this.updateCache(!1),!1;let c=this.plugin.settings.proStatus===!0;return this.updateCache(c),c}catch(n){return console.error("[GridNote VIP] \u684C\u9762\u7AEF VIP \u9A8C\u8BC1\u5931\u8D25:",n),this.updateCache(!1),!1}}getActivationInfo(){if(this.isMobilePlatform())return{isActive:this.plugin.settings.proStatus&&!!this.plugin.settings.activationCode,activatedAt:null};try{let e=this.getAppId(),t=localStorage.getItem(this.getStorageKey());if(t){let n=Rt(e,t),i=JSON.parse(n);if(i.appId===e&&i.activationCode&&this.plugin.settings.proStatus)return{isActive:!0,activatedAt:new Date(i.activatedAt)}}}catch(e){console.error("[VIPManager] Failed to get activation info:",e)}return{isActive:!1,activatedAt:null}}setupSettingsWatcher(){this.plugin.registerEvent(this.plugin.app.workspace.on("gridnote-setting-changed",(e,t)=>{(e==="activationCode"||e==="proStatus")&&this.notifyStatusChange()}))}updateCache(e){this.cachedVIPStatus=e,this.cacheValidUntil=Date.now()+this.CACHE_DURATION}notifyStatusChange(){this.clearCache(),this.plugin.viewToggleManager&&this.plugin.viewToggleManager.refreshAllProStatus()}setupPeriodicVerification(){setInterval(()=>{this.checkAndPerformBackgroundVerification()},24*60*60*1e3)}async checkAndPerformBackgroundVerification(){try{let e=this.getAppId(),t=localStorage.getItem(this.getStorageKey());if(!t)return;let n=Rt(e,t),i=JSON.parse(n);Date.now()-i.lastVerified>this.VERIFICATION_INTERVAL&&await this.backgroundVerify(i.activationCode)}catch(e){console.error("Periodic verification check failed:",e)}}clearCache(){this.cachedVIPStatus=null,this.cacheValidUntil=0}cleanupOldStorageKeys(){let t=`GRID_NOTE_${this.getAppId()}`;localStorage.getItem(t)&&localStorage.removeItem(t);let n="gridnote_vip_cache";localStorage.getItem(n)&&localStorage.removeItem(n)}destroy(){rt.instance=null}};var rr={signature:"",activationCode:"",proStatus:!1},kn=class extends tn.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new xn(this.app,this)),this.vipManager=rt.getInstance(this.app,this),await this.vipManager.initialize(),this.viewToggleManager=new $t(this.app,this),this.registerView(Ye,t=>new St(t))}async loadSettings(){try{let t=await this.loadData(),n={};t&&(typeof t.signature=="string"&&(n.signature=t.signature),typeof t.activationCode=="string"&&(n.activationCode=t.activationCode),typeof t.proStatus=="boolean"&&(n.proStatus=t.proStatus)),this.settings=Object.assign({},rr,n)}catch(t){console.error("[GridNote] Failed to load settings, using defaults:",t),this.settings=Object.assign({},rr),new tn.Notice("GridNote: \u914D\u7F6E\u52A0\u8F7D\u5931\u8D25\uFF0C\u4F7F\u7528\u9ED8\u8BA4\u8BBE\u7F6E")}}async saveSettings(){try{await this.saveData(this.settings)}catch(t){throw console.error("[GridNote] Failed to save settings:",t),new tn.Notice("GridNote: \u914D\u7F6E\u4FDD\u5B58\u5931\u8D25"),t}}onunload(){this.vipManager&&(this.vipManager.destroy(),this.vipManager=null),this.viewToggleManager&&(this.viewToggleManager.destroy(),this.viewToggleManager=null);let t=ze.getInstance(this.app);t&&t.destroy(),this.app.workspace.detachLeavesOfType(Ye),setTimeout(()=>{document.querySelectorAll(".gridnote-container").forEach(n=>n.remove()),document.querySelectorAll(".gridnote-toggle-button").forEach(n=>n.remove())},0)}};
